function enter(fn){return this.enters.push(fn),this}function exit(fn){return this.exits.push(fn),this}function goto(str){let name=str.slice(3),current=this.resolve(this.current()[0]);current.exits.forEach((e=>e())),this.current("/"+name),current=this.resolve("/"+name),current.enters.forEach((e=>e()))}function isChild(p){return p.type&&"object"==typeof p.type&&p.type.childOf}function isToOne(p){return p.type&&"object"==typeof p.type&&!p.type.parentOf}function isToMany(p){return p.type&&"object"==typeof p.type&&p.type.parentOf}function defaultTransform(value){return value}export default Object.freeze((function(store,formatter){let newValue,oldValue,proposed,p,state,alias,isReadOnly=!1,isRequired=!1;return(formatter=formatter||{}).toType=formatter.toType||defaultTransform,formatter.fromType=formatter.fromType||defaultTransform,state=function(){let state,current,subs={};return state={current:function(...args){return args.length&&(current=state.resolve(args[0])),["/"+current.name]},resolve:function(n){return subs[n.slice(1)]},send:function(name){current.events[name]&&current.events[name]()},substateMap:subs},subs.Ready={events:{change:goto.bind(state,"../Changing"),silence:goto.bind(state,"../Silent"),disable:goto.bind(state,"../Disabled")}},subs.Changing={events:{changed:goto.bind(state,"../Ready")}},subs.Silent={events:{report:goto.bind(state,"../Ready")}},subs.Disabled={events:{enable:goto.bind(state,"../Ready")}},Object.keys(subs).forEach((function(key){subs[key].name=key,subs[key].enters=[],subs[key].exits=[],subs[key].enter=enter.bind(subs[key]),subs[key].exit=exit.bind(subs[key])})),state.current("/Ready"),state}(),state.substateMap.Disabled.events.changed=function(){store=oldValue},p=function(...args){let value=args[0];if(args.length){if("/Changing"===p.state().current()[0])return p.newValue(value);if(proposed=formatter.toType(value),proposed===store)return;newValue=value,oldValue=store,p.state().send("change"),store=value===newValue?proposed:formatter.toType(newValue),p.state().send("changed"),newValue=void 0,oldValue=void 0,proposed=void 0}return formatter.fromType(store)},p.alias=function(...args){return args.length&&(alias=args[0]),alias},p.newValue=function(...args){return args.length&&"/Changing"===p.state().current()[0]&&(newValue=args[0]),newValue},p.newValue.toJSON=function(){return"object"==typeof newValue&&null!==newValue&&"function"==typeof newValue.toJSON?newValue.toJSON():formatter.toType(newValue)},p.oldValue=function(){return formatter.fromType(oldValue)},p.oldValue.toJSON=function(){return oldValue},p.state=()=>state,p.toJSON=function(){return"object"==typeof store&&null!==store&&"function"==typeof store.toJSON?store.toJSON():store},p.isReadOnly=function(value){return void 0!==value&&(isReadOnly=Boolean(value)),isReadOnly||"/Ready"!==state.current()[0]},p.isRequired=function(value){return void 0!==value&&(isRequired=Boolean(value)),isRequired},p.isToOne=isToOne.bind(null,p),p.isToMany=isToMany.bind(null,p),p.isChild=isChild.bind(null,p),store=formatter.toType(store),p}));const formDialog={viewModel:function(options){let vm,substate,onOk=options.onOk;return options.title=options.title||options.model.toName(),options.icon=options.icon||"file-text",options.onOk=function(){let model=vm.formWidget().model();model.save().then((function(){onOk&&onOk(model)}))},vm=f.createViewModel("Dialog",options),vm.formWidget=f.prop(),vm.modelId=f.prop(options.id),vm.okDisabled=function(){let w=vm.formWidget();return!w||!w.model().canSave()},vm.okTitle=function(){let w=vm.formWidget();return w?w.model().lastError()||"Record is unchanged":""},vm.content=function(){let state=vm.state();return state.resolve(state.current()[0]).content()},substate=vm.state().resolve("/Display/Closed"),substate.content=function(){return m("div")},substate=vm.state().resolve("/Display/Showing"),substate.enter((function(){vm.formWidget(f.createViewModel("FormWidget",{model:options.model,config:options.config,id:vm.modelId(),outsideElementIds:[vm.ids().header,vm.ids().buttonOk],containerId:vm.ids().dialog,isScrollable:!1})),delete vm.style().display})),substate.content=function(){return m(f.getComponent("FormWidget"),{viewModel:vm.formWidget()})},substate.exit((function(){vm.formWidget(void 0),vm.style().display="none"})),vm.style().top="50px",vm}};f.catalog().register("viewModels","formDialog",formDialog.viewModel),formDialog.component=f.getComponent("Dialog"),f.catalog().register("components","formDialog",formDialog.component);const formWidget={};function buildButtons(vm){let ret,className,lonelyTabClass=["pure-button","fb-group-tab","fb-group-tab-form"],midTabClass=f.copy(lonelyTabClass),leftTabClass=f.copy(lonelyTabClass),rightTabClass=f.copy(lonelyTabClass),tabs=vm.config().tabs||[],last=tabs.length-1;return tabs=tabs.map((tab=>tab.name)),tabs.length>1?(midTabClass.push("fb-group-tab-middle"),leftTabClass.push("fb-group-tab-left"),rightTabClass.push("fb-group-tab-right"),ret=tabs.map((function(name,idx){switch(idx){case 0:className=leftTabClass;break;case last:className=rightTabClass;break;default:className=f.copy(midTabClass)}return idx+1===vm.selectedTab()&&className.push("fb-group-tab-active"),m("button",{class:className.join(" "),onclick:vm.selectedTab.bind(null,idx+1)},name)})),ret):(lonelyTabClass.push("fb-group-tab-lonely"),lonelyTabClass.push("fb-group-tab-active"),m("button",{class:lonelyTabClass.join(" "),onclick:vm.selectedTab.bind(null,1)},tabs[0]))}function resizeWidget(vm,vnode){let e=document.getElementById(vnode.dom.id),bodyHeight=window.innerHeight;vm.outsideElementIds().forEach((function(id){let h=document.getElementById(id).clientHeight;bodyHeight=bodyHeight.minus(h)})),e.style.maxHeight=bodyHeight-5+"px"}function buildUnit(vm,attrs,n){let fieldset=function(vm,attrs){return attrs.map((function(item){let result,labelOpts,label,theKey=item.attr,theModel=vm.model(),prop=theModel.data[theKey];if(!prop)return void window.console.error("Unknown attribute "+theKey+" in form");let theDataList=item.dataList||prop.dataList,value=prop(),theOptions={height:item.height},menuButtons=vm.menuButtons(),relation=vm.relations()[theKey];return theOptions.disableCurrency=item.disableCurrency,theDataList&&("string"==typeof theDataList?theDataList=theModel.data[theDataList]():"object"!=typeof theDataList[0]&&(theDataList=theDataList.map((function(item){return{value:item,label:item}})))),labelOpts={for:theKey,key:theKey+"FormLabel",class:"fb-form-label",style:{},title:prop.description},relation&&relation.isRelationWidget?(menuButtons[theKey]||(menuButtons[theKey]={display:"none"}),labelOpts.class="pure-button fb-form-label-button",labelOpts.onclick=function(){menuButtons[theKey].display="block"},labelOpts.onmouseout=function(ev){ev&&ev.toElement&&ev.toElement.id&&-1!==ev.toElement.id.indexOf("nav-relation")||(menuButtons[theKey].display="none")},label=m("div",labelOpts,[m("div",{id:"nav-relation-div-"+theKey,class:"pure-menu fb-relation-menu"},[m("ul",{class:"pure-menu-list fb-relation-menu-list",id:"nav-relation-list-"+theKey,style:{top:"27px",display:menuButtons[theKey].display}},[m("li",{id:"nav-relation-search-"+theKey,class:function(){let ret="pure-menu-link fb-form-label-menu-item";return relation&&relation.isReadOnly&&relation.isReadOnly()&&(ret+=" pure-menu-disabled"),ret}(),onclick:relation.search},[m("i",{id:"nav-relation-search-icon-"+theKey,class:"fa fa-search"})]," Search"),m("li",{id:"nav-relation-open-"+theKey,class:function(){let ret="pure-menu-link fb-form-label-menu-item";return relation&&relation.model&&!relation.model()&&(ret+=" pure-menu-disabled"),ret}(),onclick:relation.open},[m("i",{id:"nav-relation-open-icon-"+theKey,class:"fa fa-folder-open"})]," Open"),m("li",{id:"nav-relation-new-"+theKey,class:function(){let ret="pure-menu-link fb-form-label-menu-item";return(relation&&relation.isReadOnly&&relation.isReadOnly()||!relation.canCreate())&&(ret+=" pure-menu-disabled"),ret}(),onclick:relation.new},[m("i",{id:"nav-relation-new-icon-"+theKey,class:"fa fa-plus-circle"})]," New")])]),m("i",{class:"fa fa-bars",style:{marginRight:"4px"}})],item.label||prop.alias()+":")):label=m("label",labelOpts,item.label||prop.alias()+":"),!1===item.showLabel&&(labelOpts.style.display="none"),prop.isReadOnly()||vm.focusAttr()||vm.focusAttr(theKey),vm.focusAttr()===theKey&&(theOptions.oncreate=function(vnode){document.getElementById(vnode.dom.id).focus()}),prop.isRequired()&&(null===value||"string"===prop.type&&!value)&&(labelOpts.style.color="Red"),result=m("div",{class:"pure-control-group"},[label,f.createEditor({model:theModel,key:theKey,dataList:theDataList,filter:item.filter,viewModel:vm,options:theOptions,widget:item.relationWidget})]),result}))}(vm,attrs);return m("div",{class:"pure-u-1 pure-u-md-1-"+n},[m("div",{class:"pure-form pure-form-aligned"},[m("fieldset",fieldset)])])}function buildGrid(grid,idx){let units,vm=this,className="fb-tabbed-panes fb-tabbed-panes-form";return units=grid.map((function(unit){return buildUnit(vm,unit,grid.length)})),idx?(idx!==vm.selectedTab()&&(className+=" fb-tabbed-panes-hidden"),m("div",{class:className},[buildButtons(vm),m("div",{class:"pure-g fb-tabbed-pane"},units)])):m("div",{class:"pure-g fb-top-pane"},units)}formWidget.viewModel=function(options){let model,modelState,vm={};return vm.config=f.prop(options.config),vm.containerId=f.prop(options.containerId),vm.errorDialog=f.prop(f.createViewModel("Dialog",{icon:"exclamation-circle",title:"Error"})),vm.errorDialog().buttonCancel().hide(),vm.isScrollable=f.prop(!1!==options.isScrollable),vm.focusAttr=f.prop(options.config.focus),vm.menuButtons=f.prop({}),vm.selectedTab=f.prop(1),vm.model=f.prop(),vm.outsideElementIds=f.prop(options.outsideElementIds||[]),vm.relations=f.prop({}),vm.selectComponents=f.prop({}),"object"==typeof options.model?vm.model(options.model):(model=vm.model(f.createModel(options.model.toCamelCase(!0))),options.id&&(model.id(options.id),options.isNew||(model.fetch(),model.checkUpdate()))),modelState=vm.model().state(),modelState.resolve("/Ready").enter((function(){let err=vm.model().lastError();err&&(vm.errorDialog().message(err.message),vm.errorDialog().show())})),vm.model().subscribe(!0),vm},f.catalog().register("viewModels","formWidget",formWidget.viewModel),formWidget.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel},onremove:function(){this.viewModel.model().subscribe(!1)},view:function(vnode){let vm=vnode.attrs.viewModel,attrs=vm.config().attrs||[],model=vm.model(),grids=[];return attrs.forEach((function(item){let gidx=item.grid||0,uidx=item.unit||0;grids[gidx]||(grids[gidx]=[]),grids[gidx][uidx]||(grids[gidx][uidx]=[]),grids[gidx][uidx].push(item)})),grids=grids.map(buildGrid.bind(vm)),grids.unshift(m(f.getComponent("Dialog"),{viewModel:vm.errorDialog()})),m("div",{id:model.id(),class:vm.isScrollable()?"fb-form-content":"",oncreate:resizeWidget.bind(null,vm),onupdate:resizeWidget.bind(null,vm)},grids)}},f.catalog().register("components","formWidget",formWidget.component);const moneyRelation={};function selections(item){let value=item.data.displayUnit()?item.data.displayUnit().data.code():item.data.code();return m("option",value)}moneyRelation.viewModel=function(options){let selector,wasReadOnly,wasCurrency,vm={},parent=options.parentViewModel,currencyList=f.catalog().store().data().currencies,currConvList=f.createList("CurrencyConversion",{fetch:!1}),prop=f.resolveProperty(parent.model(),options.parentProperty);return parent.model().onChange(options.parentProperty,(function(p){let baseCode=f.baseCurrency().data.code(),newCurr=p.newValue().currency;newCurr!==baseCode?p.oldValue().currency===newCurr||p.newValue().ratio||(vm.conversion(null),vm.fetchConversion(baseCode,f.getCurrency(newCurr).data.code())):vm.conversion(null)})),parent.model().state().resolve("/Ready/Fetched").enter((function(){let baseCode=f.baseCurrency().data.code(),newCurr=prop().currency;newCurr!==baseCode?newCurr&&!prop().ratio&&(vm.conversion(null),vm.fetchConversion(baseCode,f.getCurrency(newCurr).data.code())):vm.conversion(null)})),vm.id=f.prop(options.id),vm.key=f.prop(options.key),vm.isCell=f.prop(Boolean(options.isCell)),vm.label=function(){return f.baseCurrency(vm.effective()).data.code()},vm.amount=function(...args){let money;return args.length&&(money=f.copy(prop()),money.amount=args[0],prop(money)),prop().amount},vm.baseAmount=function(){let ret,money,baseCode=f.baseCurrency(vm.effective()).data.code(),conv=vm.conversion(),value=prop.toJSON();if(value.effective)ret=value.baseAmount;else if(conv&&conv.data.fromCurrency().data.code()===baseCode)ret=value.amount.times(conv.data.ratio.toJSON());else{if(!conv)return;ret=value.amount.div(conv.data.ratio.toJSON())}return money={amount:ret,currency:baseCode,effective:null,baseAmount:null},f.formats().money.fromType(money).amount},vm.conversion=f.prop(),vm.currency=function(...args){let money;return args.length&&(money=f.copy(prop()),money.currency=args[0],prop(money)),prop().currency},vm.disableCurrency=f.prop(Boolean(options.disableCurrency)),vm.currencies=function(){let ret,curr=vm.currency();return ret=currencyList().map((function(item){return item})).filter((function(item){return!item.data.isDeleted()||curr===item.data.code()||item.data.displayUnit()&&curr===item.data.displayUnit().data.code()})),ret.sort((function(a,b){return(a.data.displayUnit()?a.data.displayUnit().data.code():a.data.code())>(b.data.displayUnit()?b.data.displayUnit().data.code():b.data.code())?1:-1})),ret},vm.effective=function(){return prop().effective},vm.fetchConversion=function(fromCurr,toCurr){return new Promise((function(resolve,reject){let filter;filter={criteria:[{value:[fromCurr,toCurr],operator:"IN",property:"fromCurrency.code"},{value:[fromCurr,toCurr],operator:"IN",property:"toCurrency.code"}],sort:[{property:"effective",order:"DESC"}],limit:1},currConvList.fetch(filter,!1).then((function(result){vm.conversion(result.length?result[0]:null),resolve()})).catch((function(err){reject(err)}))}))},vm.selector=function(vnode){let selectorStyle,readOnly=!0===vnode.attrs.readonly||vm.disableCurrency()||vm.effective(),currency=vm.currency();return selector&&readOnly===wasReadOnly&&currency===wasCurrency||(selectorStyle={width:"95px"},vm.showCurrency()||(selectorStyle.display="none"),wasReadOnly=readOnly,wasCurrency=currency,selector=m("select",{id:"C"+vm.id(),onchange:e=>vm.currency(e.target.value),value:currency,readonly:readOnly,style:selectorStyle},vm.currencies().map(selections))),selector},vm.showCurrency=f.prop(!1!==options.showCurrency),vm},moneyRelation.component={oninit:function(vnode){let options=vnode.attrs;this.viewModel=moneyRelation.viewModel({parentViewModel:options.parentViewModel,parentProperty:options.parentProperty,id:options.id,key:options.key,isCell:options.isCell,readonly:options.readonly,showCurrency:options.showCurrency,disableCurrency:options.disableCurrency})},view:function(vnode){let currencyLabelStyle,inputStyle,amountLabelStyle,displayStyle,vm=this.viewModel,readOnly=Boolean(!0===vnode.attrs.readonly||vm.effective()),theId="A"+vm.id();return displayStyle={display:"inline-block"},amountLabelStyle={textAlign:"right",marginTop:vm.label()?"6px":"",marginRight:"30px",display:"inline-block"},inputStyle={marginRight:"4px",width:"116px",textAlign:"right"},vm.isCell()&&(displayStyle.float="right",amountLabelStyle.display="none"),vm.baseAmount()||(amountLabelStyle.display="none"),currencyLabelStyle=f.copy(amountLabelStyle),amountLabelStyle.width="105px",m("div",{style:displayStyle,key:vm.key()},[m("input",{style:inputStyle,id:theId,onchange:e=>vm.amount(e.target.value),value:vm.amount(),readonly:readOnly,oncreate:vnode.attrs.onCreate,onremove:vnode.attrs.onRemove,onfocus:vnode.attrs.onFocus,onblur:vnode.attrs.onBlur}),vm.selector(vnode),m("div",[m("div",{style:amountLabelStyle},vm.baseAmount()),m("div",{style:currencyLabelStyle},vm.label())])])}},f.catalog().register("components","moneyRelation",moneyRelation.component);const searchInput={viewModel:function(options){let vm,state;return options=options||{},vm={},vm.clear=function(){vm.text(""),vm.end()},vm.end=function(){state.send("end")},vm.id=f.prop(f.createId()),vm.onkeydown=function(e){"Enter"===(e.key||e.keyIdentifier)&&vm.refresh()},vm.refresh=function(){options.refresh&&options.refresh()},vm.start=function(){state.send("start")},vm.state=function(){return state},vm.style=function(){return state.resolve(state.current()[0]).style()},vm.text=f.prop(),vm.value=function(){return state.resolve(state.current()[0]).value()},state=f.State.define((function(){this.state("Search",(function(){this.state("Off",(function(){this.enter((function(){vm.text("Search")})),this.event("start",(function(){this.goto("../On")})),this.style=function(){return{color:"LightGrey",margin:"2px"}},this.value=function(){return""}})),this.state("On",(function(){this.enter((function(){vm.text("")})),this.exit((function(){vm.refresh()})),this.canExit=function(){return!vm.text()},this.event("end",(function(){this.goto("../Off")})),this.style=function(){return{color:"Black",margin:"2px"}},this.value=function(){return vm.text()}}))}))})),state.goto(),vm}};f.catalog().register("viewModels","searchInput",searchInput.viewModel),searchInput.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel||searchInput.viewModel(vnode.attrs)},view:function(){let vm=this.viewModel;return m("input",{id:vm.id(),value:vm.text(),class:"fb-search-input",style:vm.style(),onfocus:vm.start,onblur:vm.end,oninput:e=>vm.text(e.target.value),onkeydown:vm.onkeydown})}},f.catalog().register("components","searchInput",searchInput.component);const searchPage={viewModel:function(options){let vm={},theFeather=f.catalog().getFeather(options.feather.toCamelCase(!0)),theConfig=f.catalog().register("config")[options.config];return vm.buttonBack=f.prop(),vm.buttonSelect=f.prop(),vm.buttonClear=f.prop(),vm.buttonFilter=f.prop(),vm.buttonRefresh=f.prop(),vm.buttonSort=f.prop(),vm.doBack=function(){window.history.back()},vm.doSelect=function(){let receivers,selection;options.receiver&&(receivers=f.catalog().register("receivers"),receivers[options.receiver]&&(selection=vm.tableWidget().selection(),receivers[options.receiver].callback(selection),delete receivers[options.receiver])),vm.doBack()},vm.filterDialog=f.prop(),vm.sortDialog=f.prop(),vm.searchInput=f.prop(),vm.tableWidget=f.prop(),vm.refresh=function(){vm.tableWidget().refresh()},vm.searchInput(f.createViewModel("SearchInput",{refresh:vm.refresh})),vm.tableWidget(f.createViewModel("TableWidget",{config:theConfig,feather:options.feather.toCamelCase(!0),search:vm.searchInput().value,ondblclick:vm.doSelect})),vm.filterDialog(f.createViewModel("FilterDialog",{filter:vm.tableWidget().filter,list:vm.tableWidget().models(),feather:theFeather})),vm.sortDialog(f.createViewModel("SortDialog",{filter:vm.tableWidget().filter,list:vm.tableWidget().models(),feather:theFeather})),vm.buttonBack(f.createViewModel("Button",{onclick:vm.doBack,label:"&Back",icon:"arrow-left",class:"fb-toolbar-button"})),vm.buttonSelect(f.createViewModel("Button",{onclick:vm.doSelect,label:"&Select",title:vm.selectTitle,disabled:vm.selectDisabled,class:"fb-toolbar-button"})),vm.buttonSelect().isDisabled=function(){return!vm.tableWidget().selection()},vm.buttonSelect().title=function(){return vm.buttonSelect().isDisabled()?"A row must be selected":""},vm.buttonRefresh(f.createViewModel("Button",{onclick:vm.refresh,title:"Refresh",hotkey:"R",icon:"sync",class:"fb-toolbar-button"})),vm.buttonClear(f.createViewModel("Button",{onclick:vm.searchInput().clear,title:"Clear search",hotkey:"C",icon:"eraser",class:"fb-toolbar-button"})),vm.buttonClear().isDisabled=function(){return!vm.searchInput().value()},vm.buttonFilter(f.createViewModel("Button",{onclick:vm.filterDialog().show,title:"Filter",hotkey:"F",icon:"filter",class:"fb-toolbar-button"})),vm.buttonSort(f.createViewModel("Button",{onclick:vm.sortDialog().show,title:"Sort",hotkey:"O",icon:"sort",class:"fb-toolbar-button"})),vm}};f.catalog().register("viewModels","searchPage",searchPage.viewModel),searchPage.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel||searchPage.viewModel(vnode.attrs)},onremove:function(vnode){delete f.catalog().register("config")[vnode.attrs.config]},view:function(){let vm=this.viewModel,btn=f.getComponent("Button"),srch=f.getComponent("SearchInput"),sdlg=f.getComponent("SortDialog"),fdlg=f.getComponent("FilterDialog"),tw=f.getComponent("TableWidget");return m("div",{class:"pure-form"},[m("div",{class:"fb-toolbar"},[m(btn,{viewModel:vm.buttonBack()}),m(btn,{viewModel:vm.buttonSelect()}),m(srch,{viewModel:vm.searchInput()}),m(btn,{viewModel:vm.buttonRefresh()}),m(btn,{viewModel:vm.buttonClear()}),m(btn,{viewModel:vm.buttonSort()}),m(btn,{viewModel:vm.buttonFilter()})]),m(sdlg,{viewModel:vm.sortDialog()}),m(fdlg,{viewModel:vm.filterDialog()}),m(tw,{viewModel:vm.tableWidget()})])}},f.catalog().register("components","searchPage",searchPage.component);const sortDialog={viewModel:function(options){let vm;return(options=options||{}).propertyName="sort",options.title=options.title||"Sort",options.icon=options.icon||"sort",vm=f.createViewModel("FilterDialog",options),vm.addAttr=function(attr){if(!this.some(vm.hasAttr.bind(attr)))return this.push({property:attr}),!0},vm.attrs=function(){let feather=vm.feather(),keys=Object.keys(feather.properties);return vm.resolveProperties(feather,keys).sort()},vm.viewHeaderIds=f.prop({column:f.createId(),order:f.createId()}),vm.viewHeaders=function(){let ids=vm.viewHeaderIds();return[m("th",{style:{minWidth:"175px"},id:ids.column},"Column"),m("th",{style:{minWidth:"175px"},id:ids.order},"Order")]},vm.viewRows=function(){let view;return view=vm.items().map((function(item){let row;return row=m("tr",{onclick:vm.selection.bind(this,item.index,!0),style:{backgroundColor:vm.rowColor(item.index)}},[m("td",{style:{minWidth:"175px",maxWidth:"175px"}},m("select",{style:{minWidth:"175px",maxWidth:"175px"},value:item.property,onchange:e=>vm.itemChanged.bind(this,item.index,"property")(e.target.value)},vm.attrs().map((function(attr){return m("option",{value:attr},attr.toName())})))),m("td",{style:{minWidth:"175px",maxWidth:"175px"}},[m("select",{style:{minWidth:"175px",maxWidth:"175px"},value:item.order||"ASC",onchange:e=>vm.itemChanged.bind(this,item.index,"order")(e.target.value)},[m("option",{value:"ASC"},"Ascending"),m("option",{value:"DESC"},"Descending")])])]),row})),view},vm.style().width="460px",vm}};f.catalog().register("viewModels","sortDialog",sortDialog.viewModel),sortDialog.component=f.getComponent("Dialog"),f.catalog().register("components","sortDialog",sortDialog.component);const settingsPage={viewModel:function(options){options=options||{};let vm={},form={},models=f.catalog().store().models(),theModel=models[options.settings](),definition=models[options.settings].definition();return form.name=definition.name,form.description=definition.description,form.attrs=[],Object.keys(definition.properties).forEach((function(key){form.attrs.push({attr:key,grid:0,unit:0})})),vm.buttonDone=f.prop(),vm.doDone=function(){theModel.canSave()?vm.formWidget().model().save().then((function(){window.history.back()})):window.history.back()},vm.formWidget=f.prop(f.createViewModel("FormWidget",{model:theModel,id:options.settings,config:form,outsideElementIds:["toolbar"]})),vm.model=f.prop(theModel),vm.title=function(){return options.settings.toName()},vm.buttonDone(f.createViewModel("Button",{onclick:vm.doDone,label:"&Done",class:"fb-toolbar-button"})),"/Ready/New"===theModel.state().current()[0]&&theModel.fetch(),vm}};settingsPage.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel||settingsPage.viewModel(vnode.attrs)},view:function(){let vm=this.viewModel;return m("div",[m("div",{id:"toolbar",class:"fb-toolbar"},[m(f.getComponent("Button"),{viewModel:vm.buttonDone()})]),m("div",{class:"fb-title"},[m("i",{class:"fa fa-wrench fb-title-icon"}),m("label",vm.title())]),m(f.getComponent("FormWidget"),{viewModel:vm.formWidget()})])}},f.catalog().register("components","settingsPage",settingsPage.component);const tableDialog={};let scrWidth,inner,widthNoScroll,widthWithScroll;tableDialog.viewModel=function(options){let vm,state,buttonAdd,buttonRemove,buttonClear,buttonDown,buttonUp;options=options||{};let selection=f.prop();return vm=f.createViewModel("Dialog",options),vm.add=function(){let ary=vm.data();vm.attrs().some(vm.addAttr.bind(ary)),vm.isSelected()||vm.selection(ary.length-1),buttonRemove.enable(),buttonClear.enable(),vm.scrollBottom(!0)},vm.addAttr=function(attr){if(!this.some(vm.hasAttr.bind(attr)))return this.push({property:attr}),!0},vm.buttonAdd=function(){return buttonAdd},vm.buttonClear=function(){return buttonClear},vm.buttonDown=function(){return buttonDown},vm.buttonRemove=function(){return buttonRemove},vm.buttonUp=function(){return buttonUp},vm.clear=function(){vm.data().length=0,buttonClear.disable()},vm.content=function(){let btn=f.getComponent("Button");return[m(btn,{viewModel:vm.buttonAdd()}),m(btn,{viewModel:vm.buttonRemove()}),m(btn,{viewModel:vm.buttonClear()}),m(btn,{viewModel:vm.buttonDown()}),m(btn,{viewModel:vm.buttonUp()}),m("table",{class:"pure-table"},[m("thead",{class:"fb-table-dialog-table-header"},vm.viewHeaders()),m("tbody",{id:"sortTbody",class:"fb-table-dialog-table-body",oncreate:function(vnode){let e=document.getElementById(vnode.dom.id);vm.scrollBottom()&&(e.scrollTop=e.scrollHeight),vm.scrollBottom(!1)}},vm.viewRows())])]},vm.data=function(){},vm.isSelected=function(){return state.resolve(state.resolve("/Selection").current()[0]).isSelected()},vm.itemChanged=function(index,property,value){vm.data()[index][property]=value},vm.items=function(){let i=0;return vm.data().map((function(item){let ret=f.copy(item);return ret.index=i,i+=1,ret}))},vm.hasAttr=function(item){return item.property===this},vm.list=f.prop(options.list),vm.moveDown=function(){let ary=vm.data(),idx=vm.selection(),a=ary[idx],b=ary[idx+1];ary.splice(idx,2,b,a),vm.selection(idx+1)},vm.moveUp=function(){let ary=vm.data(),idx=vm.selection()-1,a=ary[idx],b=ary[idx+1];ary.splice(idx,2,b,a),vm.selection(idx)},vm.remove=function(){let idx=selection(),ary=vm.data();if(ary.splice(idx,1),state.send("unselected"),ary.length)return idx>0&&(idx-=1),void selection(idx);buttonRemove.disable()},vm.reset=function(){},vm.resolveProperties=function(feather,properties,ary,prefix,norel){prefix=prefix||"";let result=ary||[];return properties.forEach((function(key){let rfeather,prop=feather.properties[key],isObject="object"==typeof prop.type,path=prefix+key;if(isObject&&prop.type.properties&&(rfeather=f.catalog().getFeather(prop.type.relation),vm.resolveProperties(rfeather,prop.type.properties,result,path+".",norel)),"money"===prop.format)path+=".amount";else if("object"===prop.type||isObject&&(prop.type.childOf||prop.type.parentOf||prop.type.isChild||norel))return;result.push(path)})),result},vm.rowColor=function(index){return vm.selection()===index?vm.isSelected()?"LightSkyBlue":"AliceBlue":"White"},vm.title=f.prop(options.title),vm.viewHeaderIds=f.prop(),vm.viewHeaders=function(){},vm.viewRows=function(){},vm.scrollBottom=f.prop(!1),vm.selection=function(...args){let ary=vm.data(),index=args[0];return args[1]&&state.send("selected"),args.length?(buttonUp.disable(),buttonDown.disable(),ary.length>1&&(index<ary.length-1&&buttonDown.enable(),index>0&&buttonUp.enable()),selection(index)):selection()},buttonAdd=f.createViewModel("Button",{onclick:vm.add,label:"Add",icon:"plus-circle",class:"fb-icon-button",style:{backgroundColor:"white"}}),buttonRemove=f.createViewModel("Button",{onclick:vm.remove,label:"Remove",icon:"trash",class:"fb-icon-button",style:{backgroundColor:"white"}}),buttonClear=f.createViewModel("Button",{onclick:vm.clear,title:"Clear",icon:"eraser",class:"fb-icon-button",style:{backgroundColor:"white"}}),buttonUp=f.createViewModel("Button",{onclick:vm.moveUp,icon:"chevron-up",title:"Move up",class:"fb-icon-button",style:{backgroundColor:"white",float:"right"}}),buttonDown=f.createViewModel("Button",{onclick:vm.moveDown,icon:"chevron-down",title:"Move down",class:"fb-icon-button",style:{backgroundColor:"white",float:"right"}}),state=f.State.define((function(){this.state("Selection",(function(){this.state("Off",(function(){this.event("selected",(function(){this.goto("../On")})),this.isSelected=function(){return!1}})),this.state("On",(function(){this.event("unselected",(function(){this.goto("../Off")})),this.isSelected=function(){return!0}}))}))})),state.goto(),vm.state().resolve("/Display/Showing").enter((function(){vm.reset()})),vm},f.catalog().register("viewModels","tableDialog",tableDialog.viewModel),tableDialog.component=f.getComponent("Dialog"),f.catalog().register("components","tableDialog",tableDialog.component);const tableWidget={},outer=document.createElement("div");function handleStyle(style,tdOpts){style&&(style=f.getStyle(style),tdOpts.style.color=style.color,tdOpts.style.backgroundColor=style.backgroundColor,tdOpts.style.fontWeight=style.fontWeight,tdOpts.style.textDecoration=style.textDecoration)}function normalizeDataList(dataList,model){return dataList&&("string"==typeof dataList?dataList=model.data[dataList]():"object"!=typeof dataList[0]&&(dataList=dataList.map((function(item){return{value:item,label:item}})))),dataList}function createTableDataEditor(options,col){let cell,tdOpts,inputOpts,columnSpacerClass,theWidget,config=options.config,defaultFocusId=options.defaultFocusId,theModel=options.model,onshifttab=options.onshifttab,ontab=options.ontab,theVm=options.vm,zoom=options.zoom,prop=f.resolveProperty(theModel,col),theId=theVm.formatInputId(col),item=config.columns[options.idx],columnWidth=item.width||"150",theDataList=normalizeDataList(item.dataList||prop.dataList,theModel),cfilter=item.filter,style=prop.style?prop.style():"";return columnWidth-=6,inputOpts={id:theId,key:theId,onclick:theVm.toggleSelection.bind(this,theModel,theId),value:prop(),style:{minWidth:columnWidth+"px",maxWidth:columnWidth+"px",fontSize:zoom},isCell:!0,showCurrency:item.showCurrency},theVm.nextFocus()===theId&&theId===defaultFocusId?(inputOpts.oncreate=function(vnode){let e=document.getElementById(vnode.dom.id);e.addEventListener("keydown",onshifttab),e.focus()},inputOpts.onremove=function(vnode){let e=document.getElementById(vnode.dom.id);e&&e.removeEventListener("keydown",onshifttab)},theVm.nextFocus(void 0)):theVm.nextFocus()===theId&&theId!==defaultFocusId?(inputOpts.oncreate=function(vnode){document.getElementById(vnode.dom.id).focus()},theVm.nextFocus(void 0)):theId===defaultFocusId&&(inputOpts.oncreate=function(vnode){document.getElementById(vnode.dom.id).addEventListener("keydown",onshifttab)},inputOpts.onremove=function(vnode){let e=document.getElementById(vnode.dom.id);e&&e.removeEventListener("keydown",onshifttab)}),options.lastFocusId===theId&&(inputOpts.oncreate=function(vnode){document.getElementById(vnode.dom.id).addEventListener("keydown",ontab)},inputOpts.onremove=function(vnode){let e=document.getElementById(vnode.dom.id);e&&e.removeEventListener("keydown",ontab)}),tdOpts=prop.isRequired&&prop.isRequired()&&(null===prop()||void 0===prop())?{class:"fb-table-cell-edit fb-table-cell-edit-cell fb-table-cell-edit-required",style:{}}:{class:"fb-table-cell-edit fb-table-cell-edit-cell",style:{}},tdOpts.style.minWidth=columnWidth+"px",tdOpts.style.maxWidth=columnWidth+"px",tdOpts.style.fontSize=zoom,handleStyle(style,tdOpts),columnSpacerClass="fb-column-spacer "+tdOpts.class,theWidget=theVm.form().attrs.find((item=>item.attr===col&&item.relationWidget)),theWidget&&(theWidget=theWidget.relationWidget),cell=[m("td",tdOpts,[f.createEditor({model:theModel,key:col,dataList:theDataList,filter:cfilter,viewModel:theVm,options:inputOpts,widget:theWidget})]),m("td",{style:{fontSize:zoom},class:columnSpacerClass})],options.idx+=1,cell}function createTableDataView(options,col){let url,cell,content,tdOpts,tableData,relation,theVm=options.vm,model=options.model,config=options.config,zoom=options.zoom,onClick=options.onclick,theProp=f.resolveProperty(options.model,col),theValue=theProp(),format=theProp.format||theProp.type,columnWidth=config.columns[options.idx].width||"150",style=theProp.style?theProp.style():"",id=model.id()+"-"+options.idx,dataList=normalizeDataList(config.columns[options.idx].dataList||theProp.dataList,model),otitle=theProp.title?theProp.title():"";return columnWidth-=6,tdOpts={key:id+"-data",onclick:function(ev){let optKey;ev.shiftKey?optKey="shiftKey":ev.ctrlKey&&(optKey="ctrlKey"),theVm.toggleSelection(model,theVm.formatInputId(col),optKey)},class:"fb-cell-view",style:{minWidth:columnWidth+"px",maxWidth:columnWidth+"px",fontSize:zoom}},handleStyle(style,tdOpts),"object"==typeof format&&theProp()?(relation=theProp.type.relation.toCamelCase(),tableData=f.types[relation]&&f.types[relation].tableData?f.types[relation].tableData:function(){let rel,keys;if(rel=f.catalog().getFeather(format.relation),keys=Object.keys(rel.properties),rel=keys.find((key=>rel.properties[key].isNaturalKey))||keys.find((key=>rel.properties[key].isLabelKey)),rel)return theValue=theProp().data[rel](),url=window.location.protocol+"//"+window.location.hostname+":"+window.location.port+"#!/edit/"+theProp.type.relation.toSnakeCase()+"/"+theProp().id(),m("a",{href:url,onclick:function(e){theVm.canToggle(!1),e.preventDefault(),m.route.set("/edit/:feather/:key",{feather:theProp.type.relation.toSnakeCase(),key:theProp().id()},{state:{}})}},theValue)}):tableData=theProp.format&&f.formats()[theProp.format].tableData?f.formats()[theProp.format].tableData:f.types[theProp.type]&&f.types[theProp.type].tableData?f.types[theProp.type].tableData:obj=>obj.value,dataList&&(theValue=dataList.find((i=>i.value===theValue))||{},theValue=theValue.label),content=tableData({value:theValue,options:tdOpts,viewModel:theVm,prop:theProp,onclick:onClick,title:otitle}),cell=[m("td",tdOpts,content),m("td",{key:id+"-spcr",class:"fb-column-spacer",style:{fontSize:zoom}})],options.idx+=1,cell}function resolveDescription(feather,attr){let prefix,suffix,idx=attr.indexOf(".");return idx>-1?(prefix=attr.slice(0,idx),suffix=attr.slice(idx+1,attr.length),resolveDescription(feather=f.catalog().getFeather(feather.properties[prefix].type.relation),suffix)):feather.properties[attr]?feather.properties[attr].description:"Unknown attribute '"+attr+"'"}function createTableHeader(options,col){let hview,order,name,fidx,config=options.config,filter=options.filter,vm=options.vm,sort=options.sort,zoom=options.zoom,key=col.attr,icon=[],operators=f.operators,columnWidth=config.columns[options.idx].width||"150";function findFilterIndex(col,name){let hasCol,ary=filter[name=name||"criteria"]||[],i=0;return hasCol=function(item){if(item.property===col)return!0;i+=1},!!ary.some(hasCol)&&i}return fidx=findFilterIndex(key,"sort"),columnWidth-=6,!1!==fidx&&(order=sort[fidx].order||"ASC",name="ASC"===order.toUpperCase()?"fa fa-sort-up":"fa fa-sort-down",icon.push(m("i",{class:name+" fb-column-sort-icon",style:{fontSize:zoom}})),sort.length>1&&icon.push(m("span",{class:"fb-column-sort-number",style:{fontSize:.6*vm.zoom()+"%"}},fidx+1))),fidx=findFilterIndex(key),!1!==fidx&&icon.push(m("i",{class:"fa fa-filter fb-column-filter-icon",title:operators[filter.criteria[fidx].operator||"="]+" "+filter.criteria[fidx].value,style:{fontSize:.8*vm.zoom()+"%"}})),hview=[m("th",{ondragover:vm.ondragover,draggable:!0,ondragstart:vm.ondragstart.bind(null,options.idx,"column"),ondrop:vm.ondrop.bind(null,options.idx,"column",config.columns),class:"fb-column-header",style:{minWidth:columnWidth+"px",maxWidth:columnWidth+"px",fontSize:zoom},title:resolveDescription(options.feather,key)},icon,col.label||vm.alias(key)),m("th",{ondragover:vm.ondragover,draggable:!0,ondragstart:vm.ondragstart.bind(null,options.idx,"width"),class:"fb-column-spacer fb-column-header-grabber",style:{fontSize:zoom}})],options.idx+=1,hview}function createTableRow(options,pModel){let tds,row,thContent,onClick,lock,iconStyle,theLastFocusId,onTab,onShifttab,rowClass,style,theConfig=options.config,theVm=options.vm,theZoom=options.zoom,theDefaultFocusId=theVm.defaultFocus(pModel),currentMode=theVm.mode().current()[0],isSelected=theVm.isSelected(pModel),currentState=pModel.state().current()[0],data=pModel.data,rowOpts={key:pModel.id()},cellOpts={};return isSelected&&(rowClass=theVm.selectedClass()),"/Mode/View"!==currentMode&&isSelected?(cellOpts={class:"fb-table-cell-edit"},theLastFocusId=theVm.lastFocus(pModel),onTab=function(e){"Tab"!==(e.key||e.keyIdentifier)||e.shiftKey||(e.preventDefault(),document.getElementById(theDefaultFocusId).focus())},onShifttab=function(e){"Tab"===(e.key||e.keyIdentifier)&&e.shiftKey&&(e.preventDefault(),document.getElementById(theLastFocusId).focus())},tds=theVm.attrs().map(createTableDataEditor.bind(null,{config:theConfig,defaultFocusId:theDefaultFocusId,idx:0,lastFocusId:theLastFocusId,model:pModel,onshifttab:onShifttab,ontab:onTab,vm:theVm,zoom:theZoom}))):(tds=theVm.attrs().map(createTableDataView.bind(null,{config:theConfig,d:data,idx:0,model:pModel,onclick:onClick,vm:theVm,zoom:theZoom})),rowOpts={ondblclick:theVm.ondblclick.bind(null,pModel)},style=pModel.style(),style&&(style=f.getStyle(style),rowOpts.style={color:style.color,fontWeight:style.fontWeight,textDecoration:style.textDecoration},isSelected||(rowOpts.style.backgroundColor=style.backgroundColor))),onClick=function(ev){let optKey;ev.shiftKey?optKey="shiftKey":ev.ctrlKey&&(optKey="ctrlKey"),theVm.toggleSelection(pModel,theDefaultFocusId,optKey)},iconStyle={fontSize:theZoom,minWidth:"25px"},"/Mode/Edit"!==currentMode&&isSelected?thContent=m("i",{onclick:theVm.ondblclick.bind(null,pModel),class:"fa fa-folder-open fb-icon-button",style:iconStyle}):pModel.isValid()?"/Locked"===currentState?(lock=data.lock()||{},thContent=m("i",{onclick:onClick,title:"User: "+lock.username+"\nSince: "+new Date(lock.created).toLocaleTimeString(),class:"fa fa-user-lock",style:iconStyle})):"/Delete"===currentState?thContent=m("i",{onclick:onClick,class:"fa fa-trash",style:iconStyle}):"/Ready/New"===currentState?thContent=m("i",{onclick:onClick,class:"fa fa-plus",style:iconStyle}):pModel.canUndo()?thContent=m("i",{onclick:onClick,class:"fa fa-pencil-alt",style:iconStyle}):(cellOpts={onclick:onClick,style:iconStyle},"/Mode/Edit"===currentMode&&isSelected&&(cellOpts.class="fb-table-cell-edit fb-table-cell-edit-header")):thContent=m("i",{onclick:onClick,title:pModel.lastError(),class:"fa fa-exclamation-triangle",style:iconStyle}),tds.unshift(m("th",cellOpts,thContent)),rowOpts.class=rowClass,rowOpts.key=pModel.id(),row=data.isDeleted()?m("del",{key:f.createId()},m("tr",rowOpts,tds)):m("tr",rowOpts,tds),options.idx+=1,row}function resolveFeatherProp(feather,attr){let prefix,suffix,idx=attr.indexOf(".");return idx>-1?(prefix=attr.slice(0,idx),"money"===feather.properties[prefix].format?feather.properties[prefix]:(suffix=attr.slice(idx+1,attr.length),resolveFeatherProp(feather=f.catalog().getFeather(feather.properties[prefix].type.relation),suffix))):feather.properties[attr]}function createTableFooter(options,col){let fview,theValue,tableData,config=options.config,vm=options.vm,values=vm.aggregateValues()||{},zoom=options.zoom,columnWidth=config.columns[options.idx].width||"150",prop=resolveFeatherProp(options.feather,col.attr),agg=vm.aggregates().find((a=>a.property===col.attr)),content="",attr=col.attr;return!prop||"money"!==prop.format||agg&&"COUNT"===agg.method||(attr+=".amount"),theValue=void 0!==values[attr]&&null!==values[attr]?values[attr]:"",""!==theValue&&(tableData=agg&&"COUNT"===agg.method?f.types.integer.tableData:"date"===prop.format?f.formats().date.tableData:"dateTime"===prop.format?f.formats().dateTime.tableData:"string"===prop.type?f.types.string.tableData:"money"===prop.format?f.formats().money.tableData:f.types.number.tableData,content=tableData({options:{title:"",style:{}},value:theValue})),columnWidth-=6,fview=[m("th",{class:"fb-column-footer",style:{minWidth:columnWidth+"px",maxWidth:columnWidth+"px",fontSize:zoom}},content),m("th",{class:"fb-column-spacer fb-column-header-grabber fb-column-footer",style:{fontSize:zoom}})],options.idx+=1,fview}function resize(vm,vnode){let pageFooter,yPosition,e=document.getElementById(vnode.dom.id),id=vm.footerId(),height=vm.height(),tableFooter=document.getElementById(vm.ids().footer),tfootHeight=tableFooter?tableFooter.offsetHeight+1:0;height?e.style.height=height:id?(pageFooter=document.getElementById(id),e.style.height=window.innerHeight-f.getElementPosition(e.parentElement).y-e.offsetTop-pageFooter.offsetHeight-tfootHeight-1+"px"):(yPosition=f.getElementPosition(e.offsetParent).y,height=window.innerHeight-yPosition-82,height<150&&(height=150),e.style.height=height+"px")}outer.style.visibility="hidden",outer.style.width="100px",outer.style.msOverflowStyle="scrollbar",document.body.appendChild(outer),widthNoScroll=outer.offsetWidth,outer.style.overflow="scroll",inner=document.createElement("div"),inner.style.width="100%",outer.appendChild(inner),widthWithScroll=inner.offsetWidth,outer.parentNode.removeChild(outer),scrWidth=widthNoScroll-widthWithScroll,tableWidget.viewModel=function(options){let fromWidthIdx,dataTransfer,feather="object"==typeof(options=options||{}).feather?options.feather:f.catalog().getFeather(options.feather),modelName=feather.name.toCamelCase(),modelConstructor=f.catalog().store().models()[modelName],offset=0,dlgSelectId=f.createId(),dlgSelectedId=f.createId(),dlgVisibleId=f.createId(),vm={},isEditModeEnabled=f.prop(!1!==options.isEditModeEnabled),fetchCount=0;function doDownload(target,source){let element=document.createElement("a");element.setAttribute("href",source+"/"+target),element.setAttribute("download",source),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}function doImport(){let input=document.createElement("input"),dlg=vm.confirmDialog();function callback(resp){let target="error_log_"+f.now()+".json";resp&&(dlg.message("One or more errors were encountered during import. Would you like to download the log?"),dlg.title("Error"),dlg.icon("window-close"),dlg.onOk(doDownload.bind(null,target,resp)),dlg.show()),vm.refresh()}function error(err){null!==err.response&&(dlg.message(err.message),dlg.title("Error"),dlg.icon("window-close"),dlg.buttonCancel().hide(),dlg.show())}input.setAttribute("type","file"),input.setAttribute("accept",".json,.ods,.xlsx"),input.onchange=function(){let payload,file=input.files[0],formData=new FormData,format=file.name.slice(file.name.indexOf(".")+1,file.name.length),name=file.name.slice(0,file.name.indexOf(".")),feathers=f.catalog().feathers();-1!==name.indexOf(" ")&&(name=name.slice(0,name.indexOf(" "))),"ods"===format||"json"===format||"xlsx"===format?Object.keys(feathers).some((key=>feathers[key].plural===name))?(formData.append("import",file),payload={method:"POST",path:"/do/import/"+format+"/"+name,body:formData},f.datasource().request(payload).then(callback).catch(error)):error(new Error('Unrecognized data type name "'+name+'"')):error(new Error('Unrecognized file format "'+format+'"'))},input.click()}function getFilter(offset){let criterion,fattrs=[],theValue=vm.search(),filter=f.copy(vm.filter());function formatOf(feather,property){let prefix,suffix,rel,prop,idx=property.indexOf(".");return idx>-1?(prefix=property.slice(0,idx),suffix=property.slice(idx+1,property.length),rel=feather.properties[prefix].type.relation,formatOf(f.catalog().getFeather(rel),suffix)):(prop=feather.properties[property],prop.format||prop.type)}return filter.offset=offset||0,filter.limit=20,theValue&&(vm.attrs().forEach((function(attr){let nk,props,theFeather=vm.feather(),fmt=formatOf(theFeather,attr),p=resolveFeatherProp(theFeather,attr);p.isCalculated||("string"===p.type&&"date"!==fmt&&"dateTime"!==fmt?fattrs.push(attr):"object"!=typeof fmt||fmt.childOf||(props=f.catalog().getFeather(fmt.relation).properties,nk=Object.keys(props).find((key=>props[key].isNaturalKey)),nk&&fattrs.push(attr+"."+nk)))})),fattrs.length&&(criterion={property:fattrs,operator:"~*",value:theValue},filter.criteria=filter.criteria||[],filter.criteria.push(criterion))),filter}function doExport(){let dlg=vm.confirmDialog(),isOnlyVisible=f.prop(!0),isOnlySelected=f.prop(!1),format=f.prop("xlsx"),chkbox=f.getComponent("Checkbox");function error(err){dlg.message(err.message),dlg.title("Error"),dlg.icon("window-close"),dlg.buttonCancel().hide(),dlg.show()}dlg.content=function(){return m("div",{class:"pure-form pure-form-aligned"},[m("div",{class:"pure-control-group"},[m("label",{for:dlgSelectId},"Format:"),m("select",{id:dlgSelectId,onchange:e=>format(e.target.value),value:format()},[m("option",{value:"xlsx"},"Excel 2007+ XML Format (xlsx)"),m("option",{value:"ods"},"Open Document Spreadsheet (ods)"),m("option",{value:"json"},"JavaScript Object Notation (json)")])]),m("div",{class:"pure-control-group"},[m("label",{for:dlgSelectedId},"Only selected rows:"),m(chkbox,{onclick:function(value){isOnlySelected(value)},value:isOnlySelected(),readonly:0===vm.selections().length,title:0===vm.selections().length?"No selections to export":""})]),m("div",{class:"pure-control-group"},[m("label",{for:dlgVisibleId},"Only visible columns:"),m(chkbox,{onclick:function(value){isOnlyVisible(value)},value:isOnlyVisible()})])])},dlg.title("Export data"),dlg.icon("file-export"),dlg.onOk((function(){let theUrl,payload,theBody={},fspec=vm.feather(),plural=fspec.plural||fspec.name;return isOnlyVisible()&&(theBody.properties=vm.config().columns.map((col=>col.attr)),theBody.properties=theBody.properties.filter((function(p){return-1!==p.indexOf(".")||!fspec.properties[p].isCalculated}))),theBody.filter=getFilter(),delete theBody.filter.limit,isOnlySelected()&&(theBody.filter.criteria=[{property:"id",operator:"IN",value:vm.selections().map((item=>item.id()))}]),theUrl="/do/export/"+format()+"/"+plural,payload={method:"POST",url:theUrl,body:theBody},m.request(payload).then(doDownload.bind(null,plural+"."+format())).catch(error)})),dlg.style({width:"550px"}),dlg.show()}function setProperties(){let attrs,list=vm.models(),props=[],fp=vm.feather().properties;vm.isEditModeEnabled()?list.properties(void 0):(attrs=vm.config().columns.map((col=>col.attr)),attrs.forEach((function(a){let i=a.indexOf(".");-1!==i&&(a=a.slice(0,i)),-1===props.indexOf(a)&&props.push(a)})),props=props.filter((p=>fp[p]&&!fp[p].isCalculated)),-1===props.indexOf("id")&&props.unshift("id"),list.properties(props))}function doFetchAggregates(){let theUrl,payload,aggregates=vm.aggregates(),theBody={name:vm.feather().name,aggregations:aggregates,filter:f.copy(getFilter())};if(theBody.aggregations.length)return delete theBody.filter.limit,delete theBody.filter.sort,delete theBody.filter.offset,theUrl="/do/aggregate",payload={method:"POST",url:"/do/aggregate",body:theBody},m.request(payload).then((function(resp){let keys,aggs={},i=0,props=aggregates.map((a=>a.property)),values=resp.result;null!==values?("number"==typeof values&&(values={f1:values}),keys=Object.keys(values),props.forEach((function(p){let val=values[keys[i]]||0;"money"===resolveFeatherProp(vm.feather(),p).format&&"COUNT"!==aggregates[i].method&&(val=f.money(val)),aggs[p]=val,i+=1})),vm.aggregateValues(aggs)):vm.aggregateValues({})}))}function doFetch(refresh){refresh&&(doFetchAggregates(),offset=0,fetchCount=0),fetchCount+=1,setProperties(),vm.models().fetch(getFilter(offset),!0!==refresh).then((function(){fetchCount<3&&(offset+=20,doFetch())}))}function selectionChanged(){vm.state().send("changed")}function selectionFetched(){vm.state().send("fetched")}return options.config.aggregates=options.config.aggregates||[],vm.actions=function(){let menu,o,actions=options.actions||[],selections=vm.selections();return menu=actions.map((function(action){let opts,actionIcon,method=modelConstructor.static()[action.method],validator=modelConstructor.static()[action.validator];return method||(method=function(viewModel){let dialog=viewModel.confirmDialog();dialog.message('No method "'+action.method+'" found on model "'+modelName+'"'),dialog.title("Error"),dialog.icon("exclamation-triangle"),dialog.onOk(void 0),dialog.buttonCancel().hide(),dialog.show()}),action.id=action.id||f.createId(),opts={id:"nav-actions-"+action.id,class:"pure-menu-link",title:action.title},validator&&!validator(selections)?opts.class="pure-menu-link pure-menu-disabled":opts.onclick=method.bind(null,vm),action.hasSeparator&&(opts.class+=" fb-menu-list-separator"),action.icon&&(actionIcon=[m("i",{id:"nav-actions-"+action.id+"-icon",class:"fa fa-"+action.icon+" fb-menu-list-icon"})]),m("li",opts,actionIcon,action.name)})),o={id:"nav-actions-import",class:"pure-menu-link",title:"Import data",onclick:doImport},menu.length&&(o.class+=" fb-menu-list-separator"),menu.push(m("li",o,[m("i",{id:"nav-actions-import-icon",class:"fa fa-file-import fb-menu-list-icon"})],"Import")),menu.push(m("li",{id:"nav-actions-export",class:"pure-menu-link",title:"Export data",onclick:doExport},[m("i",{id:"nav-actions-export-icon",class:"fa fa-file-export fb-menu-list-icon"})],"Export")),menu},vm.aggregates=function(ary){return ary&&(options.config.aggregates.length=0,ary.forEach((i=>options.config.aggregates.push(i)))),options.config.aggregates},vm.alias=function(attr){return f.resolveAlias(vm.feather(),attr)},vm.attrs=function(){return vm.config().columns.map((function(column){return column.attr}))||[{attr:"id"}]},vm.canToggle=f.prop(!0),vm.class=f.prop(options.class||""),vm.isEditModeEnabled=function(...args){let enable=args[0];return!1===enable&&vm.toggleView(),void 0!==enable&&vm.models().isEditable(enable),isEditModeEnabled(...args)},vm.isQuery=f.prop(!0),vm.config=f.prop(options.config),vm.footerId=f.prop(options.footerId),vm.confirmDialog=f.prop(f.createViewModel("Dialog",{icon:"question-circle",title:"Confirmation"})),vm.confirmDialog().state().resolve("/Display/Closed").enter((function(){let dlg=vm.confirmDialog();dlg.icon("question-circle"),dlg.title("Confirmation"),dlg.buttonOk().show(),dlg.buttonCancel().show(),dlg.buttonCancel().isPrimary(!1),dlg.onOk(void 0),dlg.onCancel(void 0),dlg.content=function(){return m("div",{id:dlg.ids().content},dlg.message())},dlg.buttons([dlg.buttonOk,dlg.buttonCancel])})),vm.defaultFocus=function(model){let col=vm.attrs().find((function(attr){return!model.data[attr]||!model.data[attr].isReadOnly()}));return col?vm.formatInputId(col):void 0},vm.errorDialog=f.prop(f.createViewModel("Dialog",{icon:"exclamation-triangle",title:"Error"})),vm.feather=f.prop(feather),vm.filter=f.prop(),vm.form=function(){return f.getForm({form:vm.config().form,feather:feather.name})},vm.formatInputId=function(col){return"input"+col.toCamelCase(!0)},vm.height=f.prop(options.height),vm.goNextRow=function(){let list=vm.models(),ids=list.map((function(model){return model.id()})),model=vm.model(),idx=model?ids.indexOf(model.id())+1:0;list.length>idx&&vm.select(list[idx])},vm.goPrevRow=function(){let list=vm.models(),model=vm.model(),idx=list.indexOf(model)-1;idx>=0&&vm.select(list[idx])},vm.ids=f.prop({header:f.createId(),rows:f.createId(),footer:f.createId()}),vm.isDragging=f.prop(!1),vm.isScrolling=f.prop(!1),vm.isSelected=function(model){return vm.selectionIds().indexOf(model.id())>-1},vm.lastFocus=function(model){let col;return col=vm.attrs().slice().reverse().find((function(attr){return model.data[attr]&&!model.data[attr].isReadOnly()})),col?vm.formatInputId(col):void 0},vm.lastSelected=f.prop(),vm.mode=function(){let state=vm.state();return state.resolve(state.current()[0])},vm.model=function(){return vm.selection()},vm.modelDelete=function(){return vm.mode().modelDelete()},vm.modelNew=function(){return vm.mode().modelNew()},vm.models=f.prop(options.models),vm.nextFocus=f.prop(),vm.ondblclick=function(model){vm.select(model),options.ondblclick&&options.ondblclick()},vm.ondragover=function(ev){ev.preventDefault()},vm.ondragstart=function(idx,type,ev){switch(vm.isDragging(!0),dataTransfer={},dataTransfer.typeStart=type,type){case"width":return fromWidthIdx=idx,void(dataTransfer.widthStart=ev.clientX)}dataTransfer[type]=idx},vm.ondrop=function(toIdx,type,ary,ev){let moved,column,fromIdx,oldWidth,newWidth,widthStart,typeStart=dataTransfer.typeStart;switch(ev.preventDefault(),typeStart){case"width":fromWidthIdx<=toIdx&&(widthStart=dataTransfer.widthStart-0,column=vm.config().columns[fromWidthIdx],oldWidth=column.width||"150",newWidth=oldWidth-(widthStart-ev.clientX),column.width=newWidth);break;default:fromIdx=dataTransfer[type]-0,fromIdx!==toIdx&&(moved=ary.splice(fromIdx,1)[0],ary.splice(toIdx,0,moved))}vm.isDragging(!1)},vm.onkeydown=function(e){let id;function nav(name){id=e.target.id,document.getElementById(id).blur(),vm[name](),m.redraw(),document.getElementById(id).focus()}switch(e.key||e.keyIdentifier){case"Up":case"ArrowUp":nav("goPrevRow");break;case"Down":case"ArrowDown":nav("goNextRow")}},vm.onscroll=function(evt){let ids=vm.ids(),e=evt.srcElement,remainScroll=e.scrollHeight-e.clientHeight-e.scrollTop,childHeight=e.lastChild.clientHeight,header=document.getElementById(ids.header),rows=document.getElementById(ids.rows);if(vm.isQuery()&&remainScroll<2*childHeight&&vm.models().length>=offset)return offset+=20,void doFetch();header.scrollLeft=rows.scrollLeft,vm.isScrolling(!0)},vm.onscrollFooter=function(){let ids=vm.ids(),rows=document.getElementById(ids.rows),footer=document.getElementById(ids.footer);rows.scrollLeft=footer.scrollLeft,vm.isScrolling(!0)},vm.refresh=function(){doFetch(!0)},vm.relations=f.prop({}),vm.selectComponents=f.prop({}),vm.save=function(){vm.models().save()},vm.scrollbarWidth=f.prop(scrWidth),vm.search=options.search||f.prop(""),vm.select=function(models){let state,selections=vm.selections(),ids=vm.selectionIds();return Array.isArray(models)||(1===selections.length&&void 0!==models&&selections[0].id()===models.id()||(vm.unselect(selections),ids=[]),models=void 0===models?[]:[models]),models.forEach((function(model){-1===ids.indexOf(model.id())&&(state=model.state().resolve("/Ready/Fetched/Dirty"),state.enter(selectionChanged),state=model.state().resolve("/Delete"),state.enter(selectionChanged),state=model.state().resolve("/Ready/Fetched/Clean"),state.enter(selectionFetched),model.parent()||model.checkDelete(),selections.push(model))})),vm.relations({}),selections.length&&vm.state().send("selected"),selections},vm.selection=function(){return vm.selections()[0]},vm.selectionIds=function(){return vm.selections().map((function(selection){return selection.id()}))},vm.selections=f.prop([]),vm.selectedClass=function(){return vm.mode().selectedClass()},vm.state=f.prop(),vm.toggleEdit=function(){vm.state().send("edit")},vm.toggleView=function(){vm.state().send("view")},vm.toggleMode=function(){vm.state().send("toggle")},vm.toggleSelection=function(model,id,optKey){if(vm.canToggle())return vm.mode().toggleSelection(model,id,optKey)},vm.undo=function(){let selection=vm.selection();selection&&selection.undo()},vm.unselect=function(models){let idx,state,ids=[],selections=vm.selections(),remaining=[];models&&(Array.isArray(models)?ids=models.map((function(model){return model.id()})):(ids=[models.id()],models=[models])),(models=models?selections.filter((function(selection){let isClearing=ids.some((function(id){return selection.id()===id}));return isClearing||remaining.push(selection),isClearing})):selections.map((function(selection){return selection}))).forEach((function(selection){state=selection.state().resolve("/Ready/Fetched/Dirty"),idx=state.enters.indexOf(selectionChanged),state.enters.splice(idx,1),state=selection.state().resolve("/Delete"),idx=state.enters.indexOf(selectionChanged),state.enters.splice(idx,1),state=selection.state().resolve("/Ready/Fetched/Clean"),idx=state.enters.indexOf(selectionFetched),state.enters.splice(idx,1)})),selections.length=0,remaining.length?remaining.forEach((function(model){selections.push(model)})):vm.state().send("unselected")},vm.zoom=f.prop(100),vm.filter(f.copy(options.config.filter||{})),vm.aggregates(f.copy(options.config.aggregates)),vm.aggregateValues=f.prop(),vm.filter().limit=vm.filter().limit||20,options.models||(vm.models(f.createList(feather.name,{fetch:!1,subscribe:options.subscribe,isEditable:vm.isEditModeEnabled(),filter:vm.filter()})),setProperties(),doFetch(),doFetchAggregates()),vm.filter.state().resolve("/Ready").enter((function(){vm.config().filter=vm.filter(),vm.refresh()})),vm.state(f.State.define({concurrent:!0},(function(){this.state("Mode",(function(){this.state("View",(function(){this.event("edit",(function(){vm.isEditModeEnabled()&&this.goto("../Edit")})),this.event("toggle",(function(){vm.isEditModeEnabled()&&this.goto("../Edit")})),this.modelDelete=function(){let confirmDialog=vm.confirmDialog();confirmDialog.message("Are you sure you want to delete the selected rows?"),confirmDialog.onOk((function(){vm.selections().filter((function(selection){return selection.canDelete()})).forEach((function(selection){return selection.delete(!0).then((function(){vm.unselect(selection),vm.models().remove(selection)})).catch((function(err){vm.errorDialog().message(err.message),m.redraw(),vm.errorDialog().show()}))}))})),confirmDialog.show()},this.modelNew=f.prop(!1),this.selectedClass=function(){return"fb-table-row-selected"},this.toggleSelection=function(model,id,optKey){let startIdx,endIdx,lastIdx,currentIdx,i,models,modelIds,adds,isSelected=vm.isSelected(model);switch(optKey){case"ctrlKey":if(isSelected)return vm.unselect(model),void vm.lastSelected(void 0);vm.select([model]),vm.lastSelected(model);break;case"shiftKey":for(document.getSelection().removeAllRanges(),adds=[],models=vm.models(),modelIds=vm.models().map((function(item){return item.id()})),lastIdx=Math.max(modelIds.indexOf(vm.lastSelected().id()),0),currentIdx=modelIds.indexOf(model.id()),currentIdx>lastIdx?(startIdx=lastIdx,endIdx=currentIdx):(startIdx=currentIdx,endIdx=lastIdx),i=startIdx;i<=endIdx;i+=1)adds.push(models[i]);vm.select(adds),vm.lastSelected(model);break;default:vm.unselect(),isSelected||(vm.select(model),vm.lastSelected(model))}return vm.nextFocus(id),!0}})),this.state("Edit",(function(){this.enter((function(){let last;vm.selections().length>1&&(last=vm.lastSelected(),vm.unselect(),vm.select(last))})),this.event("view",(function(){this.goto("../View")})),this.event("toggle",(function(){this.goto("../View")})),this.modelDelete=function(){let selection=vm.selection(),prevState=selection.state().current()[0];selection.delete(),("/Ready/New"===prevState||options.containerId)&&vm.models().remove(selection)},this.modelNew=function(){let name=vm.feather().name,model=f.createModel(name),input=vm.defaultFocus(model);return vm.models().add(model),vm.nextFocus(input),vm.select(model),!0},this.selectedClass=function(){return"fb-table-row-editor"},this.toggleSelection=function(model,id){return vm.select(model),vm.lastSelected(model),vm.nextFocus(id),!0}}))})),this.state("Selection",(function(){this.event("selected",(function(){this.goto("./On",{force:!0})})),this.state("Off"),this.state("On",(function(){this.event("unselected",(function(){this.goto("../Off")})),this.c=this.C,this.c((function(){return vm.selection().canUndo()?"./Dirty":"./Clean"})),this.state("Clean",(function(){this.event("changed",(function(){this.goto("../Dirty")}))})),this.state("Dirty",(function(){this.event("fetched",(function(){this.goto("../Clean")}))}))}))}))}))),vm.state().goto(),vm},f.catalog().register("viewModels","tableWidget",tableWidget.viewModel),tableWidget.component={oninit:function(vnode){vnode.attrs.viewModel.canToggle(!0)},onbeforeupdate:function(vnode){let vm=vnode.attrs.viewModel,isDragging=vm.isDragging(),isScrolling=vm.isScrolling();if(isScrolling&&vm.isScrolling(!1),isDragging||isScrolling)return!1},view:function(vnode){let header,rows,footer,theVm=vnode.attrs.viewModel,ids=theVm.ids(),theConfig=theVm.config(),theFilter=theVm.filter(),theSort=theFilter.sort||[],theZoom=theVm.zoom()+"%",theFeather=theVm.feather(),dlg=f.getComponent("Dialog"),aggs=theVm.aggregates(),tableBodyClass="fb-table-body";return header=function(){let ths=theConfig.columns.map(createTableHeader.bind(null,{config:theConfig,feather:theFeather,filter:theFilter,idx:0,sort:theSort,vm:theVm,zoom:theZoom}));return ths.unshift(m("th",{style:{minWidth:"25px",fontSize:theZoom}})),ths.push(m("th",{ondragover:theVm.ondragover,draggable:!0,ondrop:theVm.ondrop.bind(null,theConfig.columns.length,"column",theConfig.columns),style:{minWidth:theVm.scrollbarWidth()+"px",maxWidth:theVm.scrollbarWidth()+"px"}})),m("tr",ths)}(),rows=theVm.models().map(createTableRow.bind(null,{config:theConfig,idx:0,vm:theVm,zoom:theZoom})),rows.length||rows.push(m("tr",{style:{height:"50px"}})),aggs.length&&(tableBodyClass+=" fb-table-body-with-footer",footer=function(){let tfs=theConfig.columns.map(createTableFooter.bind(null,{config:theConfig,feather:theFeather,idx:0,vm:theVm,zoom:theZoom}));return tfs.unshift(m("th",{class:"fb-column-footer",style:{minWidth:"25px",fontSize:theZoom,color:"White"}},"-")),m("tfoot",tfs)}(),footer=m("tfoot",{id:ids.footer,onscroll:theVm.onscrollFooter,class:"fb-table-footer"},[footer])),m("div",{class:"pure-form "+theVm.class()},[m(dlg,{viewModel:theVm.confirmDialog()}),m(dlg,{viewModel:theVm.errorDialog()}),m("table",{class:"pure-table fb-table"},[m("thead",{ondragover:theVm.ondragover,draggable:!0,id:ids.header,class:"fb-table-header"},[header]),m("tbody",{id:ids.rows,class:tableBodyClass,onscroll:theVm.onscroll,oncreate:function(vnode){document.getElementById(vnode.dom.id).addEventListener("keydown",theVm.onkeydown),resize(theVm,vnode)},onupdate:resize.bind(null,theVm),onremove:function(vnode){let e=document.getElementById(vnode.dom.id);e&&e.removeEventListener("keydown",theVm.onkeydown)}},rows),footer])])}},f.catalog().register("components","tableWidget",tableWidget.component);const urlWidget={viewModel:function(options){let vm={};return vm.buttonOpen=f.prop(),vm.doOpen=function(){let url="http://"+options.parentViewModel.model().data[options.parentProperty]();window.open(url)},vm.id=f.prop(options.id||f.createId()),vm.key=f.prop(options.key||f.createId()),vm.style=f.prop(options.style||{}),vm.buttonOpen(f.createViewModel("Button",{onclick:vm.doOpen,title:"Open link in new browser tab",icon:"external-link-alt",class:"fb-data-type-edit-button"})),vm}};urlWidget.component={oninit:function(vnode){let options=vnode.attrs;this.viewModel=urlWidget.viewModel({parentViewModel:options.parentViewModel,parentProperty:options.parentProperty,id:options.id,key:options.key,style:options.style})},view:function(vnode){let ret,options=vnode.attrs,vm=this.viewModel,theStyle=vm.style(),prop=options.prop,opts={readonly:options.readonly,id:vm.id(),required:options.required,type:"url",onchange:e=>prop(e.target.value),oncreate:options.onCreate,onremove:options.onRemove,value:prop()};return opts.class?opts.class="fb-input "+opts.class:opts.class="fb-input",theStyle.display=theStyle.display||"inline-block",ret=m("div",{style:theStyle,key:vm.key()},[m("input",opts),m(f.getComponent("Button"),{viewModel:vm.buttonOpen()})]),ret}},f.catalog().register("components","urlWidget",urlWidget.component);const Gantt=window.Gantt,gantt={viewModel:function(options){let vm={};return vm.chart=f.prop(),vm.id=f.prop(options.id||f.createId()),vm.showDetail=f.prop(!0),vm.showLinks=f.prop(!0),vm.viewMode=f.prop("week"),vm}};gantt.component={oninit:function(vnode){this.viewModel=gantt.viewModel(vnode.attrs),this.viewModel.data=vnode.attrs.parentViewModel.model().data[vnode.attrs.parentProperty]},onupdate:function(){let vm=this.viewModel,id="gantt"+vm.id(),e=document.getElementById(id),chart=vm.chart(),data=vm.data().slice();vm.showDetail()||(data=data.filter((d=>Boolean(d.type)))),chart?(chart.options.viewMode=vm.viewMode(),chart.options.showLinks=vm.showLinks(),chart.data=data,chart.render()):data.length&&!chart&&(chart=new Gantt.SVGGantt(e,data,{viewMode:vm.viewMode(),showLinks:vm.showLinks(),onClick:function(item){item.feather&&item.key&&m.route.set("/edit/:feather/:key",{feather:item.feather,key:item.key},{})}}),this.viewModel.chart(chart),chart.render())},view:function(){let vm=this.viewModel,id=vm.id(),cb=f.getComponent("checkbox");return m("div",{id:"gantt-cont"+id,key:"gantt-cont"+id},[m("div",{id:"gantt-sel-div"+id,key:"gant-sel-div"+id,style:{paddingBottom:"20px"}},[m("label",{id:"gantt-sel-label"+id,key:"gantt-sel-label"+id,for:"gantt-sel"},"View mode:"),m("select",{id:"gantt-sel"+id,key:"gantt-sel"+id,value:vm.viewMode(),onchange:e=>vm.viewMode(e.target.value)},[m("option",{value:"day",label:"Day"}),m("option",{value:"week",label:"Week"}),m("option",{value:"month",label:"Month"})],"week"),m("label",{id:"gantt-detail-lb"+id,key:"gantt-detail-lb"+id,for:"gantt-detail-cb"+id},"Show detail"),m(cb,{id:"gantt-detail-cb"+id,key:"gantt-detail-cb"+id,onclick:e=>vm.showDetail(e),value:vm.showDetail()}),m("label",{id:"gantt-links-lb"+id,key:"gantt-links-lb"+id,for:"gantt-links-cb"+id},"Show links"),m(cb,{id:"gantt-links-cb"+id,key:"gantt-links-cb"+id,onclick:e=>vm.showLinks(e),value:vm.showLinks()})]),m("div",{id:"gantt"+id,key:"gantt"+id})])}},f.catalog().register("components","gantt",gantt.component);import f from"./core.js";import datasource from"./datasource.js";import model from"./models/model.js";import settings from"./models/settings.js";import catalog from"./models/catalog.js";import State from"./state.js";import navigator from"./components/navigator-menu.js";import dialog from"./components/dialog.js";import formPage from"./components/form-page.js";import childFormPage from"./components/child-form-page.js";import workbookPage from"./components/workbook-page.js";import signInPage from"./components/sign-in-page.js";import accountMenu from"./components/account-menu.js";const m=window.m,WebSocket=window.WebSocket,console=window.console,components=f.catalog().store().components(),viewModels=f.catalog().store().viewModels();let feathers,loadForms,loadCatalog,loadModules,loadProfile,moduleData,workbookData,loadWorkbooks,menu,addWorkbookViewModel,sseErrorDialogViewModel,hash=window.location.hash.slice(window.location.hash.indexOf("/")),formsSid=f.createId(),moduleSid=f.createId(),workbooks=catalog.register("workbooks"),models=catalog.store().models(),workbookModel=models.workbook,initialized=!1,isSuper=!1;const preFetch=[],fetchRequests=[],home={oninit:function(vnode){Object.keys(workbooks).forEach((function(key){let workbook=workbooks[key],config=workbook.getConfig();vnode["go"+workbook.data.name()]=function(){m.route.set("/workbook/:workbook/:key",{workbook:workbook.data.name().toSpinalCase(),key:config[0].name.toSpinalCase()})}})),menu.selected("home")},oncreate:function(){document.getElementById("fb-title").text="Featherbone"},onupdate:function(){menu.selected("home")},view:function(){let toolbarClass="fb-toolbar",toolbarButtonClass="fb-toolbar-button";switch(f.currentUser().mode){case"test":toolbarClass+=" fb-toolbar-test",toolbarButtonClass=" fb-toolbar-button-test";break;case"dev":toolbarClass+=" fb-toolbar-dev",toolbarButtonClass=" fb-toolbar-button-dev"}return m("div",{class:"fb-navigator-menu-container"},[m(navigator.component,{viewModel:menu}),[m(dialog.component,{viewModel:sseErrorDialogViewModel}),m(dialog.component,{viewModel:addWorkbookViewModel}),m("span",{class:toolbarClass+" fb-toolbar-home"},[m("div",{class:"fb-header-home"},"Home"),m(accountMenu.component),m("button",{class:toolbarButtonClass+" fb-toolbar-button-home "+(isSuper?"":"fb-button-disabled"),title:isSuper?"Add workbook":"Must be a super user to add a workbook",onclick:addWorkbookViewModel.show,disabled:!isSuper},[m("i",{class:"fa fa-plus fb-button-icon"})])])]])}};let routes={"/workbook/:workbook/:page":workbookPage.component,"/edit/:feather/:key":formPage.component,"/traverse/:feather/:key":childFormPage.component,"/search/:feather":components.searchPage,"/settings/:settings":components.settingsPage,"/sign-in":signInPage.component};const sseState=State.define((function(){this.state("Ok",(function(){this.event("error",(function(error){this.goto("/Error",{context:error})})),this.event("close",(function(){this.goto("/Closed")}))})),this.state("Closed"),this.state("Error")}));sseState.goto(),catalog.register("global","sseState",sseState);const workbookSpec={name:"Workbook",description:"System workbook definition",properties:{id:{description:"Id",type:"string",default:"createId()"},name:{description:"Workbook name",type:"string",isRequired:!0},description:{description:"Description",type:"string"},module:{description:"Module",type:"string"},icon:{description:"Menu icon",type:"string",format:"icon",default:"folder",isRequired:!0},feather:{description:"Feather",type:"string",isRequired:!0}}},addWorkbookConfig={attrs:[{attr:"name"},{attr:"description"},{attr:"icon"},{attr:"feather",dataList:"feathers"},{attr:"module",dataList:"modules"}]};function registerWorkbook(workbook){let name=workbook.name.toSpinalCase().toCamelCase(),wmodel=workbookModel(workbook);wmodel.state().goto("/Ready/Fetched/Clean"),wmodel.checkUpdate(),workbooks[name]=wmodel,catalog.register("workbooks",name,wmodel)}function addWorkbookModel(){let that=model(void 0,workbookSpec),modules=f.prop(catalog.store().data().modules());return that.addCalculated({name:"feathers",type:"array",function:function(){let result,allFeathers=catalog.store().feathers();return result=Object.keys(allFeathers).filter((function(name){return!allFeathers[name].isChild&&!allFeathers[name].isSystem})).sort().map((function(key){return{value:key,label:key}})),result.unshift({value:"",label:""}),result}}),that.addCalculated({name:"modules",type:"array",function:modules}),that.state().resolve("/Ready/New").event("save",(function(promise){let naturalKey,labelKey,d=that.data,workbook=models.workbook(),feather=catalog.getFeather(d.feather()),data={name:d.name(),description:d.description(),icon:d.icon(),module:d.module(),defaultConfig:[{name:d.feather(),feather:d.feather(),list:{columns:[]}}],localConfig:[]},dlist=data.defaultConfig[0].list;Object.keys(feather.properties).find((function(key){if(feather.properties[key].isNaturalKey)return naturalKey=key,!0})),naturalKey?dlist.columns.push({attr:naturalKey}):dlist.columns.push({attr:"id"}),Object.keys(feather.properties).find((function(key){if(feather.properties[key].isLabelKey)return labelKey=key,!0})),labelKey&&dlist.columns.push({attr:labelKey}),workbook.set(data),workbook.save().then((function(){registerWorkbook(data),m.route.set("/workbook/:workbook/:key",{workbook:d.name().toSpinalCase(),key:d.feather().toSpinalCase()}),that.clear(),promise.resolve()}))})),that}function initApp(){let keys=Object.keys(feathers);function resolveDependencies(module,dependencies){dependencies=dependencies||module.dependencies,module.dependencies.forEach((function(dependency){let parent=moduleData.find((module=>module.name===dependency));parent.dependencies.forEach((pDepencency=>dependencies.push(pDepencency))),resolveDependencies(parent,dependencies)}))}initialized=!0,moduleData.forEach((module=>resolveDependencies(module))),moduleData=function(){let module,idx,ret=[];function top(mod){return mod.dependencies.every((dep=>ret.some((added=>added.name===dep))))}for(;moduleData.length;)module=moduleData.find(top),ret.push(module),idx=moduleData.indexOf(module),moduleData.splice(idx,1);return ret}(),moduleData.forEach((function(module){try{new Function("f",'"use strict";'+module.script)(f)}catch(e){console.error(e)}})),keys.forEach((function(key){feathers[key].children={}})),keys.forEach((function(key){let parent=feathers[key].inherits||"Object";feathers[parent].children[key]=feathers[key]})),delete feathers.Object.children.Object,function subclass(name,parent){let feather=feathers[name],funcs=Object.keys(parent.static()),calculated=Object.keys(parent.calculated());Object.keys(feather.children).forEach((function(name){let child=models[name.toCamelCase()];funcs.forEach((function(func){child.static()[func]=child.static()[func]||parent.static()[func]})),calculated.forEach((function(prop){child.calculated()[prop]=child.calculated()[prop]||parent.calculated()[prop]})),subclass(name,child)}))}("Object",models.object),catalog.register("feathers","Money",{name:"Money",isSystem:!0,description:"Money definition",properties:{amount:{description:"Natural key",type:"number"},currency:{description:"Natural key",type:"string"},effective:{description:"Effective time",type:"date",format:"dateTime"},baseAmount:{description:"Amount in base currency",type:"number"}}}),workbookData.forEach(registerWorkbook),preFetch.forEach((function(ary){fetchRequests.push(ary().fetch({}))})),Promise.all(fetchRequests).then((function(){isSuper=f.currentUser().isSuper,menu=navigator.viewModel(),addWorkbookViewModel=viewModels.formDialog({icon:"plus",title:"Add workbook",model:addWorkbookModel(),config:addWorkbookConfig}),sseErrorDialogViewModel=dialog.viewModel({icon:"close",title:"Connection Error",message:'You have lost connection to the server.Click "Ok" to attempt to reconnect.',onOk:function(){document.location.reload()}}),sseState.resolve("Error").enter(sseErrorDialogViewModel.show),sseErrorDialogViewModel.buttonCancel().hide(),routes["/home"]=home,m.route(document.body,"/home",routes),"/sign-in"===hash&&(hash="/home"),m.route.set(hash)}))}function start(){initialized||(loadCatalog=new Promise((function(resolve){catalog.fetch(!0).then((function(data){let initSettings=[],toFetch=[];feathers=data,Object.keys(data).forEach((function(name){let feather=catalog.getFeather(name);feather.isFetchOnStartup&&toFetch.push(feather),name=name.toCamelCase(),"function"!=typeof models[name]&&(models[name]=function(data,spec){return model(data,spec||f.copy(feather))},models[name].calculated=f.prop({}),models[name].static=f.prop({}),Object.freeze(models[name]))})),datasource.request({method:"GET",path:"/settings-definition"}).then((function(definitions){definitions.forEach((function(definition){let name=definition.name;"function"!=typeof models[name]&&(models[name]=function(){return settings(definition)}),models[name].definition=function(){return definition},initSettings.push(new Promise((function(presolve){models[name]().fetch().then(presolve)})))})),Promise.all(initSettings).then((function(){toFetch.forEach((function(feather){let list=f.createList(feather.name,{subscribe:!0,fetch:!1,showDeleted:!0}),prop=f.prop(list);catalog.register("data",feather.plural.toCamelCase(),prop),list.defaultLimit(void 0),preFetch.push(prop)})),resolve()}))}))}))})),loadForms=new Promise((function(resolve){let payload={method:"POST",path:"/data/forms",body:{subscription:{id:formsSid,eventKey:catalog.eventKey()}}};datasource.request(payload).then((function(data){catalog.register("subscriptions",formsSid,data),catalog.register("data","forms",f.prop(data)),resolve()}))})),loadModules=new Promise((function(resolve){let payload={method:"POST",path:"/data/modules",body:{subscription:{id:moduleSid,eventKey:catalog.eventKey()},properties:["id","name","script","version","dependencies"]}};datasource.request(payload).then((function(data){let mapped;moduleData=data,catalog.register("subscriptions",moduleSid,moduleData),moduleData.forEach((function(module){module.dependencies?module.dependencies=module.dependencies.map((function(dep){return dep.module.name})):module.dependencies=[]})),mapped=moduleData.map((function(mod){return{value:mod.name,label:mod.name}})).sort((function(a,b){return a.value>b.value?1:-1})),mapped.unshift({value:"",lable:""}),catalog.register("data","modules",f.prop(mapped)),resolve()}))})),loadProfile=new Promise((function(resolve){datasource.request({method:"GET",path:"/profile"}).then((function(resp){catalog.register("data","profile",f.prop(resp)),resolve()}))})),loadWorkbooks=new Promise((function(resolve){datasource.request({method:"GET",path:"/workbooks/"}).then((function(data){workbookData=data,resolve()}))})),Promise.all([loadCatalog,loadModules,loadForms,loadProfile,loadWorkbooks]).then(initApp))}new Promise((function(resolve){datasource.request({method:"POST",path:"/connect"}).then(resolve)})).then((function(resp){let edata;resp.data&&(edata=resp.data,catalog.register("subscriptions"),catalog.eventKey(edata.eventKey),f.state().resolve("/SignedIn").enter((function(){const wsurl="ws://"+window.location.hostname+":7070",evsubscr=new WebSocket(wsurl);evsubscr.onopen=function(){evsubscr.send(edata.eventKey)},evsubscr.onmessage=function(e){f.processEvent({event:e,moduleSubscrId:moduleSid,formsSubscrId:formsSid})},f.state().resolve("/SignedOut").enter((function(){evsubscr.close(),f.state().resolve("/SignedOut").enters.pop()})),evsubscr.onclose=function(e){sseState.send("error",e)}})),resp.data.authorized?(f.currentUser(edata.authorized),f.state().send("preauthorized"),start()):(m.route(document.body,"/sign-in",routes),f.state().resolve("/SignedIn").enter(start),f.state().send("signIn")))})),document.documentElement.style.overflow="hidden",window.onresize=function(){m.redraw(!0)};