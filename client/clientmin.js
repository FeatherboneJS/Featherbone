import Big from"../node_modules/big.js/big.mjs";function dataService(data,feather){let model;return feather=feather||f.catalog().getFeather("DataService"),model=f.createModel(data,feather),model.addCalculated({name:"modules",type:"array",function:f.catalog().store().data().modules}),model}function enter(fn){return this.enters.push(fn),this}function exit(fn){return this.exits.push(fn),this}function goto(str){let name=str.slice(3),current=this.resolve(this.current()[0]);current.exits.forEach((e=>e())),this.current("/"+name),current=this.resolve("/"+name),current.enters.forEach((e=>e()))}function defineState(){let state,current,subs={};return state={current:function(...args){return args.length&&(current=state.resolve(args[0])),["/"+current.name]},resolve:function(n){return subs[n.slice(1)]},send:function(name){current.events[name]&&current.events[name]()},substateMap:subs},subs.Ready={events:{change:goto.bind(state,"../Changing"),silence:goto.bind(state,"../Silent"),disable:goto.bind(state,"../Disabled")}},subs.Changing={events:{changed:goto.bind(state,"../Ready")}},subs.Silent={events:{report:goto.bind(state,"../Ready")}},subs.Disabled={events:{enable:goto.bind(state,"../Ready")}},Object.keys(subs).forEach((function(key){subs[key].name=key,subs[key].enters=[],subs[key].exits=[],subs[key].enter=enter.bind(subs[key]),subs[key].exit=exit.bind(subs[key])})),state.current("/Ready"),state}function isChild(p){return p.type&&"object"==typeof p.type&&p.type.childOf}function isToOne(p){return p.type&&"object"==typeof p.type&&!p.type.parentOf}function isToMany(p){return p.type&&"object"==typeof p.type&&p.type.parentOf}function defaultTransform(value){return value}function createProperty(store,formatter){let newValue,oldValue,proposed,p,state,alias,isReadOnly=!1,isRequired=!1;return(formatter=formatter||{}).toType=formatter.toType||defaultTransform,formatter.fromType=formatter.fromType||defaultTransform,state=defineState(),state.substateMap.Disabled.events.changed=function(){store=oldValue},p=function(...args){let value=args[0];if(args.length){if("/Changing"===p.state().current()[0])return p.newValue(value);if(proposed=formatter.toType(value),proposed===store)return;newValue=value,oldValue=store,p.state().send("change"),store=value===newValue?proposed:formatter.toType(newValue),p.state().send("changed"),newValue=void 0,oldValue=void 0,proposed=void 0}return formatter.fromType(store)},p.alias=function(...args){return args.length&&(alias=args[0]),alias},p.newValue=function(...args){return args.length&&"/Changing"===p.state().current()[0]&&(newValue=args[0]),newValue},p.newValue.toJSON=function(){return"object"==typeof newValue&&null!==newValue&&"function"==typeof newValue.toJSON?newValue.toJSON():formatter.toType(newValue)},p.oldValue=function(){return formatter.fromType(oldValue)},p.oldValue.toJSON=function(){return oldValue},p.state=()=>state,p.toJSON=function(){return"object"==typeof store&&null!==store&&"function"==typeof store.toJSON?store.toJSON():store},p.isReadOnly=function(value){return void 0!==value&&(isReadOnly=Boolean(value)),isReadOnly||"/Ready"!==state.current()[0]},p.isRequired=function(value){return void 0!==value&&(isRequired=Boolean(value)),isRequired},p.isToOne=isToOne.bind(null,p),p.isToMany=isToMany.bind(null,p),p.isChild=isChild.bind(null,p),store=formatter.toType(store),p}Number.prototype.pad=function(width,str){let n=String(this),a=[];return str=str||"0",n.length<width&&(a.length=width-n.length+1),a.length?a.join(str)+n:n},Number.prototype.div=function(n){return new Big(this).div(n).valueOf()-0},Number.prototype.minus=function(n){return new Big(this).minus(n).valueOf()-0},Number.prototype.plus=function(n){return new Big(this).plus(n).valueOf()-0},Number.prototype.times=function(n){return new Big(this).times(n).valueOf()-0},Number.prototype.round=function(dp){return new Big(this).round(dp).valueOf()-0},f.catalog().registerModel("DataService",dataService);export default Object.freeze(createProperty);function form(data,feather){let model,props;function handleProperties(){props=void 0}return feather=feather||f.catalog().getFeather("Form"),model=f.createModel(data,feather),model.addCalculated({name:"feathers",type:"array",function:f.feathers}),model.addCalculated({name:"modules",type:"array",function:f.catalog().store().data().modules}),model.addCalculated({name:"properties",type:"array",function:function(){if(!props){let keys,formFeather=model.data.feather(),result=[];if(!formFeather)return result;formFeather=f.catalog().getFeather(formFeather),keys=Object.keys(formFeather.properties||[]).sort(),keys.unshift(""),props=keys.map((function(key){return{value:key,label:key}}))}return props}}),model.onChanged("feather",handleProperties),model.onLoad(handleProperties),model.onValidate((function(){if(model.data.isDefault()&&!model.data.isActive())throw"Default form must be active"})),model}function formAttr(data,feather){let model;function handleProp(name,validator){let fprop,readOnly,attr=model.data.attr,formFeather=model.parent().data.feather(),prop=model.data[name];if(formFeather&&attr())return formFeather=f.catalog().getFeather(formFeather),formFeather&&(fprop=formFeather.properties[attr()],readOnly=validator(fprop),prop.isReadOnly(readOnly)),readOnly;prop.isReadOnly(!0)}function handleColumns(){let columns=model.data.columns();handleProp("columns",(function(fprop){return Boolean(!fprop||"object"!=typeof fprop.type||!fprop.type.parentOf)}))?columns.canAdd(!1):columns.canAdd(!0)}function handleDataList(){handleProp("dataList",(function(fprop){return Boolean(!fprop||"object"==typeof fprop.type||"boolean"===fprop.type)}))}function handleDisableCurrency(){handleProp("disableCurrency",(function(fprop){return Boolean(!fprop||"object"!==fprop.type||"money"!==fprop.format)}))}function handleRelationWidget(){handleProp("relationWidget",(function(fprop){return Boolean(!fprop||"object"!=typeof fprop.type||fprop.type.parentOf)}))}return feather=feather||f.catalog().getFeather("FormAttr"),model=f.createModel(data,feather),model.addCalculated({name:"properties",type:"array",function:function(){let keys,formFeather=model.parent().data.feather(),result=[];return formFeather?(formFeather=f.catalog().getFeather(formFeather),keys=Object.keys(formFeather.properties||[]).sort(),result=keys.map((function(key){return{value:key,label:key}})),result.unshift({value:"",label:""}),result):result}}),model.onChanged("attr",handleColumns),model.onChanged("attr",handleDataList),model.onChanged("attr",handleDisableCurrency),model.onChanged("attr",handleRelationWidget),model.onLoad(handleColumns),model.onLoad(handleDataList),model.onLoad(handleDisableCurrency),model.onLoad(handleRelationWidget),model.data.columns().canAdd(!1),model.onValidate((function(){if(!model.parent().data.properties().find((p=>model.data.attr()===p.value)))throw"Attribute '"+model.data.attr()+"' not in feather '"+model.parent().data.feather()+"'"})),model}function formAttrColumn(data,feather){let model,stateClean;function getChildFeather(){let childFeather,formFeather=model.parent().parent().data.feather(),parentAttr=model.parent().data.attr();if(formFeather&&parentAttr)return formFeather=f.catalog().getFeather(formFeather),formFeather&&formFeather.properties[parentAttr]&&(childFeather=f.catalog().getFeather(formFeather.properties[parentAttr].type.relation)),childFeather}function resolveProperties(feather,properties,ary,prefix){prefix=prefix||"";let result=ary||[];return properties.forEach((function(key){let rfeather,prop=feather.properties[key],isObject="object"==typeof prop.type,path=prefix+key;isObject&&prop.type.properties&&(rfeather=f.catalog().getFeather(prop.type.relation),resolveProperties(rfeather,prop.type.properties,result,path+".")),isObject&&(prop.type.childOf||prop.type.parentOf||prop.type.isChild)||result.push(path)})),result}function handleProp(name,validator){let fprop,readOnly,attr=model.data.attr,prop=model.data[name],childFeather=getChildFeather();attr()&&childFeather?(fprop=childFeather.properties[attr()],readOnly=validator(fprop),prop.isReadOnly(readOnly)):prop.isReadOnly(!0)}function handleDataList(){handleProp("dataList",(function(fprop){return Boolean(!fprop||"object"==typeof fprop.type||"boolean"===fprop.type)}))}function handleShowCurrency(){handleProp("showCurrency",(function(fprop){return Boolean(!fprop||"object"!==fprop.type||"money"!==fprop.format)}))}return feather=feather||f.catalog().getFeather("FormAttrColumn"),model=f.createModel(data,feather),model.addCalculated({name:"properties",type:"array",function:function(){let keys,childFeather=getChildFeather();return childFeather?(keys=Object.keys(childFeather.properties||[]).sort(),keys=resolveProperties(childFeather,keys).sort(),keys.map((function(key){return{value:key,label:key}}))):[]}}),model.onChanged("attr",handleDataList),model.onChanged("attr",handleShowCurrency),stateClean=model.state().resolve("/Ready/Fetched/Clean"),stateClean.enter(handleDataList),stateClean.enter(handleShowCurrency),model.onValidate((function(){let childFeather;if(!model.data.properties().some((p=>model.data.attr()===p.value)))throw childFeather=getChildFeather(),childFeather?"Attribute '"+model.data.attr()+"' not in feather '"+getChildFeather().name+"'":"Feather must be selected to set attributes"})),model}function contact(data,feather){feather=feather||f.catalog().getFeather("Contact");let model=f.createModel(data,feather),d=model.data;function handleName(){d.firstName()?d.fullName(d.firstName()+" "+d.lastName()):d.fullName(d.lastName())}return model.onChanged("firstName",handleName),model.onChanged("lastName",handleName),model.naturalKey=model.data.fullName,model}function currency(data,feather){feather=feather||f.catalog().getFeather("Currency");let model=f.createModel(data,feather);return model.data.displayUnit.isReadOnly=function(){return!model.data.hasDisplayUnit()},model.data.displayUnit.isRequired=model.data.hasDisplayUnit,model.onChanged("hasDisplayUnit",(function(prop){prop()||model.data.displayUnit(null)})),model.onLoad((function(){model.data.code.isReadOnly(!0)})),model.onValidate((function(){let id,displayUnit=model.data.displayUnit(),conversions=model.data.conversions().filter((item=>"/Delete"!==item.state().current()[0]));if(displayUnit&&(id=displayUnit.id(),!conversions.some((function(model){return model.data.toUnit().id()===id}))))throw"A conversion must exist for the display unit.";if(model.data.code().length>4)throw"code may not be more than 4 characters"})),model}function currencyConversion(data,feather){feather=feather||f.catalog().getFeather("CurrencyConversion");let model=f.createModel(data,feather);return model.onValidate((function(){if(model.data.fromCurrency().id()===model.data.toCurrency().id())throw"'From' currency cannot be the same as 'to' currency.";if(model.data.ratio()<0)throw"The conversion ratio nust be a positive number."})),model}function currencyUnit(data,feather){feather=feather||f.catalog().getFeather("CurrencyUnit");let model=f.createModel(data,feather);return model.onValidate((function(){if(model.data.code().length>4)throw"code may not be more than 4 characters"})),model}function module(data,feather){feather=feather||f.catalog().getFeather("Module");let model=f.createModel(data,feather);return model.onLoad((function(){model.data.name.isReadOnly(!0)})),model}function role(data,feather){feather=feather||f.catalog().getFeather("Role");let model=f.createModel(data,feather),re=new RegExp(" ","g");return model.onChange("name",(function(prop){prop.newValue(prop.newValue().toLowerCase().replace(re,"_"))})),model.onLoad((function(){model.data.name.isReadOnly(!0)})),model.onValidate((function(){model.data.membership&&model.data.membership().forEach((function(item){if(!item.data.role())throw new Error("Role must be selected for membership")}))})),model}function roleMembership(data,feather){feather=feather||f.catalog().getFeather("RoleMembership");let model=f.createModel(data,feather);return model.addCalculated({name:"roleNames",type:"array",function:function(){let result;return result=f.catalog().store().data().roles().slice().filter((function(role){return"UserAccount"!==role.data.objectType()&&!role.data.isDeleted()})),result=result.map((role=>role.data.name())).sort(),result=result.map((function(role){return{value:role,label:role}})),result.unshift({value:"",label:""}),result}}),model}function userAccount(data,feather){feather=feather||f.catalog().getFeather("UserAccount"),void 0===data&&(data={membership:[{role:"everyone"}]});let model=f.createModel(data,feather);return model.data.isSuper&&model.data.isSuper.isReadOnly(!f.currentUser().isSuper),model.onLoad((function(){model.data.name&&model.data.name.isReadOnly(!0)})),model}function route(data,feather){let model;return feather=feather||f.catalog().getFeather("Route"),model=f.createModel(data,feather),model.addCalculated({name:"modules",type:"array",function:f.catalog().store().data().modules}),model}function script(data,feather){let model;return feather=feather||f.catalog().getFeather("Script"),model=f.createModel(data,feather),model.addCalculated({name:"annotations",description:"Lint annotations",type:"Array",function:f.prop()}),model.onValidate((function(){let annotations=model.data.annotations();if(annotations&&annotations.length)throw new Error("Script has "+annotations.length+" lint violation"+(annotations.length>1?"s":"")+" starting on line "+(annotations[0].from.line+1))})),model.onLoad((function(){model.data.name.isReadOnly(!0)})),model}function style(data,feather){feather=feather||f.catalog().getFeather("Style");let model=f.createModel(data,feather),d=model.data;function handleReadOnly(){d.color.isReadOnly(!d.hasColor()),d.backgroundColor.isReadOnly(!d.hasBackgroundColor())}return model.onChange("name",(function(prop){prop.newValue(prop.newValue().toUpperCase())})),model.onChanged("hasColor",handleReadOnly),model.onChanged("hasBackgroundColor",handleReadOnly),model.onLoad((function(){model.data.name.isReadOnly(!0),handleReadOnly()})),model.addCalculated({name:"modules",type:"array",function:f.catalog().store().data().modules}),model}f.catalog().registerModel("Form",form),f.catalog().registerModel("FormAttr",formAttr),f.catalog().registerModel("FormAttrColumn",formAttrColumn),f.catalog().registerModel("Contact",contact),f.catalog().registerModel("Currency",currency),f.catalog().registerModel("CurrencyConversion",currencyConversion),f.catalog().registerModel("CurrencyUnit",currencyUnit),module.static=f.prop({install:function(viewModel){let input=document.createElement("input"),dialog=viewModel.confirmDialog();function error(err){dialog.message(err.message),dialog.title("Error"),dialog.icon("exclamation-triangle"),dialog.buttonCancel().hide(),dialog.show()}input.setAttribute("type","file"),input.setAttribute("accept",".zip"),input.onchange=function(){let payload,file=input.files[0],formData=new FormData;formData.append("package",file),payload={method:"POST",path:"/module/install",body:formData},f.datasource().request(payload).then(viewModel.refresh).catch(error)},input.click()},package:function(viewModel){let dialog=viewModel.confirmDialog(),payload={method:"POST",path:"/module/package/"+viewModel.selections()[0].data.name()};f.datasource().request(payload).then((function(filename){let element=document.createElement("a");element.setAttribute("href","files/downloads/"+filename),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)})).catch((function(err){dialog.message(err.message),dialog.title("Error"),dialog.icon("exclamation-triangle"),dialog.buttonCancel().hide(),dialog.show()}))},packageCheck:function(selections){return 1===selections.length&&!selections.some((sel=>"Core"===sel.naturalKey()))}}),f.catalog().registerModel("Module",module),f.catalog().registerModel("Role",role),f.catalog().registerModel("RoleMembership",roleMembership),f.catalog().registerModel("UserAccount",userAccount),f.catalog().registerModel("Route",route),f.catalog().registerModel("Script",script),f.catalog().registerModel("Style",style);const Qs=window.Qs;let wbModels,wbFeathers,wbDescr='Parent of "parent" on "WorkbookDefaultConfig"';function resolveProperties(feather,properties,ary,prefix){prefix=prefix||"";let result=ary||[];return properties.forEach((function(key){let rfeather,prop=feather.properties[key],isObject="object"==typeof prop.type,path=prefix+key;isObject&&prop.type.properties&&(rfeather=f.catalog().getFeather(prop.type.relation),resolveProperties(rfeather,prop.type.properties,result,path+".")),isObject&&(!(!prop.type.childOf||prop.type.properties&&prop.type.properties.length)||prop.type.parentOf||prop.type.isChild)||result.push(path)})),result}const workbook={name:"Workbook",plural:"Workbooks",description:"System workbook definition",isSystem:!0,properties:{name:{description:"Workbook name",type:"string"},description:{description:"Description",type:"string"},module:{description:"Module",type:"string"},icon:{description:"Menu icon",type:"string",default:"folder"},sequence:{description:"Presentation order",type:"integer"},actions:{description:"Menu actions",type:"object"},launchConfig:{description:"Launch configuration",type:"object"},defaultConfig:{description:wbDescr,type:"object"},localConfig:{description:'Parent of "parent" on "WorkbookLocalConfig"',type:"object"},authorizations:{description:'Parent of "parent" on "WorkbookAuthorization"',type:{parentOf:"parent",relation:"WorkbookAuthorization"}}}},workbookDefaultConifg={description:"Workbook default sheet definition",isSystem:!0,isChild:!0,properties:{id:{description:"Unique identifier",type:"string",default:"createId"},parent:{description:"Workbook parent",type:{relation:"Workbook",childOf:"defaultConfig"}},name:{description:"Sheet name",type:"string",isRequired:!0},feather:{description:"Description",type:"string",isRequired:!0},form:{description:"Form layout",type:{relation:"Form"}},list:{description:"List layout",type:"object"},zoom:{description:"Zoom level",type:"string",default:"100"},isEditModeEnabled:{description:"Flags whether inline editing is allowed",type:"boolean",default:!0},openInNewWindow:{description:"Open record in a new tab window",type:"boolean",default:!1},actions:{description:"Menu actions that can be performed",type:"object",default:[]}}},workbookList={description:"Workbook list definition",isSystem:!0,isChild:!0,properties:{columns:{description:"Columns",type:"object"},filter:{description:"Filter",type:"object"},aggregates:{description:"Aggregates",type:"array"}}},workbookLocalConfig=f.copy(workbookDefaultConifg),workbookAuth={description:"Workbook authorization definition",isSystem:!0,properties:{id:{description:"Unique id",type:"string",default:"createId()"},isDeleted:{description:"Boilerplate",type:"boolean",default:!1},parent:{description:"Workbook parent",type:{relation:"Workbook",childOf:"authorizations"}},role:{description:"Role",type:"string",format:"role"},canRead:{description:"User can use workbook",type:"boolean",default:!0},canUpdate:{description:"User can update definition and share workbook changes",type:"boolean",default:!1}}};function resolveConfig(config){config.forEach((function(sheet){sheet.id||(sheet.id=f.createId()),"string"==typeof sheet.form&&sheet.form.length&&(sheet.form=f.catalog().store().data().forms().find((form=>sheet.form===form.id)))}))}function workbookModel(data){let model,state,substate,doPut,canUpdate,profileConfig,modules=f.prop(f.catalog().store().data().modules());function save(pPromise){this.goto("/Busy/Saving",{context:{promise:pPromise}})}return(data=data||{}).localConfig&&resolveConfig(data.localConfig),data.defaultConfig&&resolveConfig(data.defaultConfig),model=f.createModel(data,workbook),model.idProperty("name"),model.path=function(name,id){let ret="/"+name.toSpinalCase();return id&&(ret+="/"+id),ret},model.getConfig=function(){let profile,d=model.data;return profileConfig||(profile=f.catalog().store().data().profile(),profile&&profile.data&&profile.data.workbooks&&profile.data.workbooks[d.name()]?(profileConfig=f.copy(profile.data.workbooks[d.name()]),profileConfig):d.localConfig().length?d.localConfig():d.defaultConfig())},model.addCalculated({name:"modules",type:"array",function:modules}),model.canUpdate=()=>canUpdate,model.checkUpdate=function(){"/Ready/Fetched/Clean"===model.state().current()[0]&&void 0===canUpdate&&(model.state().goto("/Ready/Fetched/ReadOnly"),model.isAuthorized("canUpdate").then((function(resp){canUpdate=resp,canUpdate&&model.state().goto("/Ready/Fetched/Clean")})))},model.isAuthorized=function(pAction){return new Promise((function(resolve,reject){let query=Qs.stringify({action:pAction}),payload={method:"GET",path:"/workbook/is-authorized/"+model.id()+"?"+query};f.datasource().request(payload).then(resolve).catch(reject)}))},doPut=function(context){let cache=model.toJSON(),payload={method:"PUT",path:model.path(model.name,model.data.name()),body:cache};model.isValid()&&f.datasource().request(payload).then((function(){state.send("fetched"),context.promise.resolve(model.data)})).catch(model.error)},state=model.state(),substate=state.resolve("/Busy/Saving"),delete substate.substateMap.Posting,delete substate.substateMap.Patching,substate.substates.length=0,substate.enter(doPut),substate=state.resolve("/Ready/New"),substate.event("save",save.bind(substate)),substate=state.resolve("/Ready/Fetched/Dirty"),substate.event("save",save.bind(substate)),substate=state.resolve("/Ready/Fetched/Clean"),substate.event("changed",(function(){this.goto("../Dirty")})),substate=state.resolve("/Delete"),substate.enters.shift(),model.onLoad((function(){model.data.name.isReadOnly(!0)})),model}function workbookChild(data){let model=f.createModel(data,workbookLocalConfig);return model.onChanged("feather",(function(property){let invalid,feather,value=property.newValue(),list=model.data.list(),columns=list.data.columns(),filter=list.data.filter(),sort=!!filter&&filter.sort,criteria=!!filter&&filter.criteria;value?(feather=f.catalog().getFeather(value),invalid=columns.filter((function(column){return!feather.properties[column.attr]})),invalid.forEach((function(item){let idx=columns.indexOf(item);columns.splice(idx,1)})),sort&&(invalid=sort.filter((function(item){return!feather.properties[item.property]})),invalid.forEach((function(item){let idx=sort.indexOf(item);sort.splice(idx,1)}))),criteria&&(invalid=criteria.filter((function(item){return!feather.properties[item.property]})),invalid.forEach((function(item){let idx=criteria.indexOf(item);criteria.splice(idx,1)})))):(columns.length=0,Object.keys(filter).forEach((function(key){delete filter[key]})))})),model.onValidate((function(){if(!model.data.list().data.columns().length)throw"List must include at least one column."})),model}function workbookAuthorization(data){return f.createModel(data,workbookAuth)}workbookLocalConfig.description="Workbook local sheet definition",workbookLocalConfig.properties.parent.type.childOf="localConfig",workbookLocalConfig.properties.list={description:'Parent of "parent" on "WorkbookList"',type:{relation:"WorkbookList"}},wbFeathers=f.catalog().store().feathers(),wbFeathers.Workbook=workbook,wbFeathers.WorkbookDefaultConfig=workbookDefaultConifg,wbFeathers.WorkbookLocalConfig=workbookLocalConfig,wbFeathers.WorkbookList=workbookList,wbFeathers.WorkbookAuthorization=workbookAuth,workbookChild.static=f.prop({}),workbookChild.calculated=f.prop({}),workbookAuthorization.static=f.prop({}),workbookAuthorization.calculated=f.prop({}),workbookModel.static=f.prop({}),workbookModel.calculated=f.prop({}),wbModels=f.catalog().store().models(),wbModels.workbook=workbookModel,wbModels.workbookLocalConfig=workbookChild,wbModels.workbookAuthorization=workbookAuthorization,Object.freeze(wbModels.workbookLocalConfig);const worksheet={name:"Worksheet",plural:"Worksheets",description:"System worksheet definition",isSystem:!0,properties:{id:{description:"Unique Id",type:"string"},name:{description:"Worksheet name",type:"string"},feather:{description:"Feather definition",type:"string",dataList:"feathers"},form:{description:"Default editing form",type:"string",dataList:"forms"},isEditModeEnabled:{description:"ALlow inline editing",type:"boolean"},openInNewWindow:{description:"Open worksheet in new tab",type:"boolean"},columns:{description:'Parent of "parent" on "WorksheetColumn"',type:{parentOf:"parent",relation:"WorksheetColumn"}},actions:{description:'Parent of "parent" on "WorksheetAction"',type:{parentOf:"parent",relation:"WorksheetAction"}}}},worksheetColumn={inherits:"Object",description:"Worksheet column",isSystem:!0,properties:{attr:{description:"Column name",type:"string",dataList:"properties"},label:{description:"Column label",type:"string"},width:{description:"Width",type:"integer"}}},worksheetAction={description:"Worksheet action",isSystem:!0,properties:{name:{description:"Name",type:"string"},title:{description:"Title",type:"string"},icon:{description:"Icon name",type:"string",format:"icon"},method:{description:"Method to execute for action",type:"string"},validator:{description:"Selection validation check",type:"string"},hasSeparator:{description:"Precede action with separator",type:"boolean"}}};function worksheetModel(data){let state,substate,model=f.createModel(data,worksheet),d=model.data;return model.addCalculated({name:"feathers",type:"array",function:function(){return Object.keys(f.catalog().feathers()).sort().map((function(key){return{value:key,label:key}}))}}),model.addCalculated({name:"forms",type:"array",function:function(){let forms=f.catalog().store().data().forms(),feather=model.data.feather();return forms.filter((function(form){return form.feather===feather&&form.isActive})).map((function(form){return{value:form.name,label:form.name}}))}}),model.onChanged("feather",(function(){let props=f.catalog().getFeather(d.feather()).properties,pkeys=Object.keys(props),cols=d.columns().slice(),ckeys=cols.map((c=>c.data.attr())),idx=0;ckeys.forEach((function(col){-1===pkeys.indexOf(col)&&d.columns().remove(cols[idx]),idx+=1}))})),state=model.state(),substate=state.resolve("/Ready/New"),substate.event("fetched",(function(){this.goto("/Ready/Fetched/Clean")})),substate=state.resolve("/Busy/Saving"),delete substate.substateMap.Posting,delete substate.substateMap.Patching,substate.substates.length=0,substate=state.resolve("/Ready/Fetched/Clean"),substate.event("changed",(function(){this.goto("../Dirty")})),substate=state.resolve("/Delete"),substate.enters.shift(),model}function worksheetColumnModel(data){let model=f.createModel(data,f.catalog().getFeather("WorksheetColumn"));return model.addCalculated({name:"properties",type:"array",function:function(){let name=model.parent().data.feather(),feather=f.catalog().getFeather(name),keys=!!feather&&Object.keys(feather.properties);return keys=keys?resolveProperties(feather,keys).sort():[],keys.map((function(key){return{value:key,label:key.toName()}}))}}),model}let dloFeathers;wbFeathers.Worksheet=worksheet,wbFeathers.WorksheetColumn=worksheetColumn,wbFeathers.WorksheetAction=worksheetAction,worksheetModel.static=f.prop({}),worksheetModel.calculated=f.prop({}),wbModels.worksheet=worksheetModel,worksheetColumnModel.static=f.prop({}),worksheetColumnModel.calculated=f.prop({}),wbModels.worksheetColumn=worksheetColumnModel;const dataListOption={name:"DataListOption",plural:"DataListOptions",description:"Object for data list",inherits:"Object",isSystem:!0,properties:{value:{description:"Internal key",type:"string"},label:{description:"Display value",type:"string"}}};function dataListOptionModel(data){let model;return data=data||{},model=f.createModel(data,f.catalog().getFeather("DataListOption")),model.state().resolve("/Ready/Fetched/Clean").event("changed",(()=>model.state().goto("/Ready/Fetched/Dirty"))),model}function doc(data,feather){void 0===data?data={owner:f.currentUser().name}:void 0===data.owner&&(data.owner=f.currentUser().name),feather=feather||f.catalog().getFeather("Document");let model=f.createModel(data,feather),d=model.data;return model.onLoad((function(){let user=f.currentUser();d.owner.isReadOnly(d.owner()!==user.name&&!user.isSuper)})),model}dloFeathers=f.catalog().store().feathers(),dloFeathers.DataListOption=dataListOption,f.catalog().registerModel("DataListOption",dataListOptionModel),f.catalog().registerModel("Document",doc);const relationWidget={};function positionMenu(vnode){let e=document.getElementById(vnode.dom.id),menuRect=e.getBoundingClientRect(),pe="parentElement",tblRect=e[pe][pe][pe][pe][pe][pe].getBoundingClientRect();menuRect.bottom>tblRect.bottom&&(e.style.top="-60px",e.style.right="-155px")}relationWidget.viewModel=function(options){let duplicate,registerReceiver,modelList,vm={},hasFocus=!1,parent=options.parentViewModel,parentProperty=options.parentProperty,valueProperty=options.valueProperty,labelProperty=options.labelProperty,modelValue=parent.model().data[parentProperty],current=modelValue()?modelValue().data[valueProperty]():null,inputValue=f.prop(current),type=modelValue.type,criteria=options.filter&&options.filter.criteria||[],theFilter={criteria:f.copy(criteria),sort:[{property:valueProperty}],limit:10},configId=f.createId();function updateValue(prop){let value=prop();value?vm.value(value.data[options.valueProperty]()):vm.value("")}function mergeFilter(filter){filter=f.copy(filter||{});let pFilter=f.copy(parent.model().data[parentProperty].filter());return filter.criteria||(filter.criteria=[]),filter.sort||(filter.sort=[]),filter.criteria=filter.criteria.concat(pFilter.criteria),filter.sort=filter.sort||pFilter.sort,filter.limit=filter.limit||pFilter.limit,filter}return modelList=f.createList(type.relation,{background:!0,filter:mergeFilter(theFilter)}),parent.model().onChanged(parentProperty,updateValue),parent.model().state().resolve("/Ready/Fetched").enter(updateValue.bind(null,parent.model().data[parentProperty])),vm.canCreate=f.prop(!1),vm.listId=f.prop(f.createId()),vm.fetch=function(){vm.models().fetch(mergeFilter(theFilter),!1)},vm.id=f.prop(options.id),vm.isCell=f.prop(Boolean(options.isCell)),vm.isRelationWidget=!0,vm.isReadOnly=options.isReadOnly||f.prop(!1),vm.key=f.prop(options.key),vm.label=function(){let model=modelValue();return labelProperty&&model?model.data[labelProperty]():""},vm.labelProperty=f.prop(options.labelProperty),vm.labels=function(){return[m("div",{class:"fb-input",style:{marginLeft:"12px",marginTop:vm.label()?"6px":""}},vm.label())]},vm.model=function(){return modelValue()},vm.models=function(){return modelList},vm.new=function(){m.route.set("/edit/:feather/:key",{feather:type.relation.toSpinalCase(),key:f.createId()},{state:{receiver:registerReceiver(),create:!0}})},vm.open=function(){m.route.set("/edit/:feather/:key",{feather:type.relation.toSpinalCase(),key:modelValue().id()},{state:{receiver:registerReceiver()}})},vm.search=function(filter){let searchList=f.copy(options.list);searchList.filter=filter||options.filter||searchList.filter,searchList.filter=mergeFilter(searchList.filter),f.catalog().register("config",configId,searchList),m.route.set("/search/:feather",{feather:type.relation.toSpinalCase(),config:configId},{state:{receiver:registerReceiver()}})},vm.onchange=function(value){let currentModel,currentValue=!1,models=vm.models(),regexp=new RegExp("^"+value.replace(/\\/g,"\\\\"),"i");if(value.length&&models.some((function(model){return currentValue=model.data[valueProperty](),Array.isArray(currentValue.match(regexp))?(currentModel=model,!0):(currentValue=!1,!1)}))&&models.reduce((function(counter,model){return model.data[valueProperty]()===currentValue?counter+1:counter}),0)>1)return duplicate={criteria:[{property:valueProperty,value:currentValue}]},void document.getElementById(vm.id()).blur();currentValue?(modelValue(currentModel),inputValue(currentValue)):(modelValue(null),inputValue(null),delete theFilter.criteria,vm.fetch())},vm.onfocus=function(){let value=modelValue();hasFocus=!0,value=value?value.data[options.valueProperty]():null,inputValue(value)},vm.onblur=function(){hasFocus=!1,duplicate&&vm.search(duplicate),duplicate=void 0},vm.oninput=function(value){let fetch=!1,inputVal=inputValue()||"";(value.length<=inputVal.length||10===modelList.length)&&(fetch=!0),inputValue(value),fetch&&(theFilter.criteria=f.copy(criteria),theFilter.criteria.push({property:valueProperty,operator:"~*",value:"^"+value}),vm.fetch())},vm.onmouseovermenu=function(){vm.showMenu(!0)},vm.onmouseoutmenu=function(ev){ev&&ev.toElement&&ev.toElement.id&&-1!==ev.toElement.id.indexOf("nav-relation")||vm.showMenu(!1)},vm.parentProperty=f.prop(options.parentProperty),vm.parantViewModel=f.prop(options.parentViewModel),vm.showMenu=f.prop(!1),vm.style=f.prop({}),vm.value=function(...args){let result,value=args[0];return hasFocus?(result=args.length?inputValue(value):inputValue(),result||""):(result=modelValue(),result?result.data[valueProperty]():"")},vm.valueProperty=f.prop(valueProperty),registerReceiver=function(){let receiverKey=f.createId();return f.catalog().register("receivers",receiverKey,{callback:function(model){modelValue(model),vm.showMenu(!1)}}),receiverKey},vm.style(options.style||{}),f.catalog().isAuthorized({feather:type.relation,action:"canCreate",background:!0}).then(vm.canCreate).catch((function(err){console.error(err.message)})),vm},f.catalog().register("viewModels","relationWidget",relationWidget.viewModel),relationWidget.component={oninit:function(vnode){let options=vnode.attrs,parentProperty=options.parentProperty,relations=options.parentViewModel.relations();relations[parentProperty]||(relations[parentProperty]=relationWidget.viewModel({parentViewModel:options.parentViewModel,parentProperty:options.parentProperty,valueProperty:options.valueProperty,labelProperty:options.labelProperty,form:options.form,list:options.list,filter:options.filter,isCell:options.isCell,id:options.id,key:options.key,isReadOnly:options.isReadOnly,style:options.style})),this.viewModel=relations[parentProperty]},view:function(vnode){let listOptions,inputStyle,menuStyle,maxWidth,menu,vm=this.viewModel,readOnly=vm.isReadOnly(),theStyle=vm.style(),openMenuClass="pure-menu-link",editMenuClass="pure-menu-link",newMenuClass="pure-menu-link",buttonClass="pure-button fa fa-bars fb-relation-button",labelClass="fb-relation-label",id=vm.id();return menuStyle={display:vm.showMenu()?"block":"none"},listOptions=vm.models().map((function(model){let content={value:model.data[vm.valueProperty()]()};return vm.labelProperty()&&(content.label=model.data[vm.labelProperty()]()),m("option",content)})),theStyle.display=theStyle.display||"inline-block",vm.model()||(openMenuClass+=" pure-menu-disabled"),readOnly?(editMenuClass+=" pure-menu-disabled",newMenuClass+=" pure-menu-disabled"):vm.canCreate()||(newMenuClass+=" pure-menu-disabled"),vm.isCell()&&(inputStyle={minWidth:"100px",maxWidth:"100%"},buttonClass+=" fb-relation-button-cell",menuStyle.top="34px",menuStyle.right="-100px",labelClass="fb-relation-label-cell",menu=m("div",{id:"nav-relation-div-container-"+id,onmouseover:vm.onmouseovermenu,style:{position:"relative",display:"inline"}},[m("div",{id:"nav-relation-div-menu-"+id,class:"pure-menu custom-restricted-width fb-relation-menu",onmouseover:vm.onmouseovermenu,onmouseout:vm.onmouseoutmenu},[m("span",{id:"nav-relation-span-"+id,class:buttonClass}),m("ul",{id:"nav-relation-list-"+id,class:"pure-menu-list fb-relation-menu-list",style:menuStyle,onupdate:positionMenu},[m("li",{id:"nav-relation-search-"+id,class:editMenuClass,onclick:function(){return vm.showMenu(!1),vm.search(),!1}},[m("i",{id:"nav-relation-search-icon-"+id,class:"fa fa-search"})]," Search"),m("li",{id:"nav-relation-open-"+id,class:openMenuClass,onclick:function(){return vm.showMenu(!1),vm.open(),!1}},[m("i",{id:"nav-relation-open-icon-"+id,class:"fa fa-folder-open"})]," Open"),m("li",{id:"nav-relation-new-"+id,class:newMenuClass,onclick:function(){return vm.showMenu(!1),vm.new(),!1}},[m("i",{id:"nav-relation-new-icon-"+id,class:"fa fa-plus-circle"})]," New")])])])),theStyle.maxWidth&&(maxWidth=theStyle.maxWidth.replace("px",""),maxWidth-=35,maxWidth=maxWidth<100?100:maxWidth,inputStyle.maxWidth=maxWidth+"px"),m("div",{style:theStyle,key:vm.key()},[m("input",{style:inputStyle,list:vm.listId(),id:vm.id(),onchange:e=>vm.onchange(e.target.value),onfocus:function(){vnode.attrs.onFocus(),vm.onfocus()},onblur:function(){vnode.attrs.onBlur(),vm.onblur()},oninput:e=>vm.oninput(e.target.value),value:vm.value(),oncreate:vnode.attrs.onCreate,onremove:vnode.attrs.onRemove,readonly:readOnly,autocomplete:"off"}),menu,m("div",{class:labelClass},vm.labels()),m("datalist",{id:vm.listId()},listOptions)])}},f.catalog().register("components","relationWidget",relationWidget.component);const addressRelation={viewModel:function(options){let vm={},parent=options.parentViewModel;return vm.addressDialog=f.prop(),vm.buttonClear=f.prop(),vm.content=function(isCell){let d,content="";return vm.model()?(d=vm.model().data,content=d.street(),isCell||(d.unit()&&(content+="\n"+d.unit()),content+="\n"+d.city()+", ",content+=d.state()+" "+d.postalCode(),content+="\n"+d.country()),content):content},vm.countries=function(){let countries=f.catalog().store().data().countries().map((function(model){return model.data.name()})).sort();return countries.unshift(""),countries},vm.doClear=function(){vm.addressDialog().cancel(),vm.model(null)},vm.doEdit=function(){let value,dmodel,addressDialog=vm.addressDialog();addressDialog.onOk((function(){vm.model(dmodel.toJSON())})),addressDialog.show(),dmodel=vm.addressDialog().formWidget().model(),vm.model()&&(value=vm.model().toJSON(),dmodel.set(value),dmodel.state().goto("/Ready/Fetched/Clean"))},vm.id=f.prop(options.id||f.createId()),vm.isCell=f.prop(options.isCell),vm.model=parent.model().data[options.parentProperty],vm.onkeydown=function(e){"Enter"===e.key?vm.doEdit():"Tab"!==e.key&&e.preventDefault()},vm.states=function(){let states=f.catalog().store().data().states().map((function(model){return model.data.code()})).sort();return states.unshift(""),states},vm.style=f.prop(options.style||{}),vm.addressDialog(f.createViewModel("FormDialog",{title:"Address",model:"address",config:{attrs:[{attr:"type"},{attr:"street"},{attr:"unit"},{attr:"city"},{attr:"state",dataList:vm.states()},{attr:"postalCode"},{attr:"country",dataList:vm.countries()}]}})),vm.buttonClear(f.createViewModel("Button",{onclick:vm.doClear,label:"C&lear"})),vm.addressDialog().buttons().push(vm.buttonClear),vm}};addressRelation.component={oninit:function(vnode){let options=vnode.attrs;this.viewModel=addressRelation.viewModel({parentViewModel:options.parentViewModel,parentProperty:options.parentProperty,id:options.id,isCell:options.isCell,style:options.style,readonly:options.readonly})},view:function(vnode){let ret,vm=this.viewModel,theStyle=vm.style(),readOnly=!0===vnode.attrs.isReadOnly(),options={id:vm.id(),class:"fb-input",value:vm.content(vm.isCell()),readonly:readOnly,rows:4};return vm.isCell()&&(options.rows=1,options.style={width:"100%"}),readOnly||(options.title="Click or Enter key to edit",options.onkeydown=vm.onkeydown,options.onclick=vm.doEdit),theStyle.display=theStyle.display||"inline-block",ret=m("div",{style:theStyle},[m(f.getComponent("FormDialog"),{viewModel:vm.addressDialog()}),m("textarea",options)]),ret}},f.catalog().register("components","addressRelation",addressRelation.component);const autonumber={};function autonumberModel(){let feather,that;return feather={name:"autonumber",properties:{id:{type:"string",default:"createId()"},prefix:{description:"Character(s) to prefix number",type:"string"},sequence:{description:"The name of the number sequence",type:"string"},length:{description:"Number of digits in number",type:"integer",default:5,min:1,max:8},suffix:{description:"Character(s) to suffix number",type:"string"}}},that=f.createModel(void 0,feather),that.onChange("sequence",(function(prop){let value=prop.newValue();"string"==typeof value?prop.newValue(value.toSnakeCase()):prop.newValue("")})),that.state().resolve("/Ready/Fetched/Locking").enters.shift(),that.state().resolve("/Ready/Fetched/Locking").enter((function(){this.goto("../Dirty")})),that}autonumber.viewModel=function(options){let vm={},parent=options.parentViewModel;return vm.autonumberDialog=f.prop(),vm.buttonClear=f.prop(),vm.buttonEdit=f.prop(),vm.content=function(){let d=vm.model(),content="";return d?(content=d.prefix+(0).pad(d.length)+d.suffix,content):content},vm.doClear=function(){vm.autonumberDialog().cancel(),vm.model(null)},vm.doEdit=function(){let value,dmodel,autonumberDialog=vm.autonumberDialog();autonumberDialog.onOk((function(){value=dmodel.toJSON(),delete value.id,vm.model(value)})),autonumberDialog.show(),dmodel=vm.autonumberDialog().formWidget().model(),vm.model()?(value=vm.model(),dmodel.set(value),dmodel.state().goto("/Ready/Fetched/Clean")):dmodel.clear()},vm.id=f.prop(options.id||f.createId()),vm.key=f.prop(options.key||f.createId()),vm.model=parent.model().data[options.parentProperty],vm.style=f.prop(options.style||{}),vm.autonumberDialog(f.createViewModel("FormDialog",{title:"Auto number",model:autonumberModel(),config:{attrs:[{attr:"prefix"},{attr:"sequence"},{attr:"length"},{attr:"suffix"}]}})),vm.buttonClear(f.createViewModel("Button",{onclick:vm.doClear,label:"C&lear"})),vm.buttonEdit(f.createViewModel("Button",{onclick:vm.doEdit,title:"Edit autonumber details",icon:"edit",class:"fb-data-type-edit-button"})),vm.autonumberDialog().buttons().push(vm.buttonClear),vm},autonumber.component={oninit:function(vnode){let options=vnode.attrs;this.viewModel=autonumber.viewModel({parentViewModel:options.parentViewModel,parentProperty:options.parentProperty,id:options.id,style:options.style,readonly:options.readonly})},view:function(vnode){let ret,vm=this.viewModel,theStyle=vm.style(),options={id:vm.id(),class:"fb-data-list-input",value:vm.content(),readonly:!0};return vnode.attrs.readonly?vm.buttonEdit().disable():vm.buttonEdit().enable(),theStyle.display=theStyle.display||"inline-block",ret=m("div",{style:theStyle,key:vm.key()},[m(f.getComponent("Dialog"),{viewModel:vm.autonumberDialog()}),m("input",options),m(f.getComponent("Button"),{viewModel:vm.buttonEdit()})]),ret}},f.catalog().register("components","autonumber",autonumber.component);const button={viewModel:function(options){let vm,state,display,primary,mode,label,hotkey;return options=options||{},vm={},vm.activate=function(){state.send("activate")},vm.isDisabled=function(){return mode().isDisabled()},vm.deactivate=function(){state.send("deactivate")},vm.disable=function(){state.send("disable")},vm.enable=function(){state.send("enable")},vm.class=function(){return options.class+" "+mode().class()},vm.hidden=function(){return display().hidden()},vm.hide=function(){state.send("hide")},vm.hotKey=function(...args){let title,len,value=args[0];return args.length&&(hotkey=value,title=vm.title(),len=title.length,len&&(title+=" ("),title+="Alt + "+String.fromCharCode(hotkey),len&&(title+=")"),vm.title(title)),hotkey},vm.icon=f.prop(options.icon||""),vm.id=f.prop(f.createId()),vm.isPrimary=function(flag){return Boolean(flag)?state.send("primaryOn"):state.send("primaryOff"),"Primary/On"===state.current()[1]},vm.label=function(...args){let idx,ary,value=args[0];return args.length&&(label=value,idx=value.indexOf("&"),idx>-1&&(label=value.replace("&",""),vm.hotKey(label.slice(idx,idx+1).toUpperCase().charCodeAt(0)),ary=[],idx>0&&ary.push(m("span",label.slice(0,idx))),ary.push(m("span",{style:{textDecoration:"underline"}},label.slice(idx,idx+1))),ary.push(m("span",label.slice(idx+1,label.length))),label=ary)),label},vm.onclick=f.prop(options.onclick),vm.onkeydown=function(e){let id,b;e.altKey&&e.which===vm.hotKey()&&(id=vm.id(),b=document.getElementById(id),b.offsetParent&&(b.focus(),b.click(),e.preventDefault()))},vm.primaryClass=function(){return primary().class()},vm.show=function(){state.send("show")},vm.state=function(){return state},vm.style=function(){return options.style||{}},vm.title=f.prop(options.title||""),vm.label(options.label||""),options.hotkey&&vm.hotKey(options.hotkey.toUpperCase().charCodeAt(0)),state=f.State.define({concurrent:!0},(function(){this.state("Mode",(function(){this.state("Normal",(function(){this.event("activate",(function(){this.goto("../Active")})),this.event("disable",(function(){this.goto("../Disabled")})),this.class=f.prop(""),this.isDisabled=f.prop(!1)})),this.state("Active",(function(){this.event("deactivate",(function(){this.goto("../Normal")})),this.event("disable",(function(){this.goto("../Disabled")})),this.class=function(){return"pure-button-active"},this.isDisabled=f.prop(!1)})),this.state("Disabled",(function(){this.event("enable",(function(){this.goto("../Normal")})),this.event("activate",(function(){this.goto("../Active")})),this.class=f.prop(""),this.isDisabled=f.prop(!0)}))})),this.state("Primary",(function(){this.state("Off",(function(){this.event("primaryOn",(function(){this.goto("../On")})),this.class=f.prop("")})),this.state("On",(function(){this.event("primaryOff",(function(){this.goto("../Off")})),this.class=f.prop("pure-button-primary")}))})),this.state("Display",(function(){this.state("On",(function(){this.event("hide",(function(){this.goto("../Off")})),this.hidden=f.prop("")})),this.state("Off",(function(){this.event("show",(function(){this.goto("../On")})),this.hidden=f.prop("pure-button-hidden")}))}))})),state.goto(),display=function(){return state.resolve(state.resolve("/Display").current()[0])},mode=function(){return state.resolve(state.resolve("/Mode").current()[0])},primary=function(){return state.resolve(state.resolve("/Primary").current()[0])},vm}};f.catalog().register("viewModels","button",button.viewModel),button.component={oninit:function(vnode){let vm=vnode.attrs.viewModel||button.viewModel(vnode.attrs);this.viewModel=vm},view:function(){let opts,view,iconView,vm=this.viewModel,classes=["pure-button"],title=vm.title(),icon=vm.icon(),label=vm.label(),pre="fa fa-";return"fa"===icon.slice(0,2)&&(pre=""),opts={id:vm.id(),type:"button",style:vm.style(),disabled:vm.isDisabled(),onclick:vm.onclick()},vm.isDisabled()&&classes.push("fb-button-disabled"),vm.class()&&classes.push(vm.class()),vm.primaryClass()&&classes.push(vm.primaryClass()),classes.push(vm.hidden()),opts.class=classes.join(" "),vm.hotKey()&&(opts.oncreate=function(){document.addEventListener("keydown",vm.onkeydown)},opts.onremove=function(){document.removeEventListener("keydown",vm.onkeydown)}),icon&&(iconView=[m("i",{class:pre+icon+" fb-button-icon"})]),title&&(opts.title=title),view=m("button",opts,iconView,label),view}},f.catalog().register("components","button",button.component);const checkbox={viewModel:function(options){let vm={};return vm.hasFocus=f.prop(!1),vm.id=f.prop(options.id||f.createId()),vm.isCell=f.prop(Boolean(options.isCell)),vm}};checkbox.component={oninit:function(vnode){this.viewModel=checkbox.viewModel(vnode.attrs)},view:function(vnode){let theclass,thestyle,label,labelClass="fb-checkbox-label",vm=this.viewModel;return label=function(){if(!vm.isCell())return theclass="fb-checkbox-input",thestyle=vnode.attrs.style||{},vnode.attrs.readonly&&(labelClass+=" fb-checkbox-readonly"),vm.hasFocus()&&(labelClass+=" fb-checkbox-focus"),m("label",{for:vm.id(),title:vnode.attrs.title,class:labelClass},m("i",{class:"fa fa-check",style:{visibility:vnode.attrs.value?"visible":"hidden"}}))}(),m("div",{class:"fb-checkbox"},[m("input",{id:vm.id(),class:theclass,type:"checkbox",onclick:function(e){vnode.attrs.onclick(e.target.checked)},oncreate:vnode.attrs.onCreate,onremove:vnode.attrs.onRemove,checked:vnode.attrs.value,style:thestyle,disabled:vnode.attrs.readonly,required:Boolean(vnode.attrs.required),onfocus:function(){vnode.attrs.onFocus(),vm.hasFocus(!0)},onblur:function(){vnode.attrs.onBlur(),vm.hasFocus(!1)}}),label])}},f.catalog().register("components","checkbox",checkbox.component);const childFormPage={viewModel:function(options){if(!f.catalog().store().instances)return m.route.set("/home"),void(options.isInvalid=!0);let instances=f.catalog().store().instances(),theModel=instances[options.key];if(!theModel)return m.route.set("/home"),void(options.isInvalid=!0);let ary=theModel.parent().data[options.parentProperty](),sseState=f.catalog().store().global().sseState,theFeather=options.feather.toCamelCase(!0),form=f.getForm({form:options.form,feather:theFeather}),vm={},pageIdx=options.index||1,isNew=options.create&&!1!==options.isNew,toolbarButtonClass="fb-toolbar-button";switch(f.currentUser().mode){case"test":toolbarButtonClass+=" fb-toolbar-button-test";break;case"dev":toolbarButtonClass+=" fb-toolbar-button-dev"}return vm.buttonDone=f.prop(),vm.buttonPrevious=f.prop(),vm.buttonNext=f.prop(),vm.buttonNew=f.prop(),vm.doChildOpen=function(idx){let target=ary[idx];delete instances[theModel.id()],instances[target.id()]=target,m.route.set("/traverse/:feather/:key",{feather:options.feather,key:target.id()},{state:{parentProperty:options.parentProperty,form:options.form,index:pageIdx+1}})},vm.doDone=function(){delete instances[vm.model().id()],window.history.go(-1*pageIdx)},vm.doPrevious=function(){let idx=ary.indexOf(theModel);vm.doChildOpen(idx-1)},vm.doNext=function(){let idx=ary.indexOf(theModel);vm.doChildOpen(idx+1)},vm.doNew=function(){let newInstance=f.createList(theFeather);ary.add(newInstance),vm.doChildOpen(ary.length-1)},vm.formWidget=f.prop(),vm.model=function(){return vm.formWidget().model()},vm.sseErrorDialog=f.prop(f.createViewModel("Dialog",{icon:"close",title:"Connection Error",message:'You have lost connection to the server.Click "Ok" to attempt to reconnect.',onOk:function(){document.location.reload()}})),vm.sseErrorDialog().buttonCancel().hide(),vm.title=function(){return options.parentProperty.toName()},vm.formWidget(f.createViewModel("FormWidget",{isNew:Boolean(isNew),model:theModel,id:options.key,config:form,outsideElementIds:["toolbar"]})),vm.buttonDone(f.createViewModel("Button",{onclick:vm.doDone,label:"&Done",class:toolbarButtonClass})),vm.buttonPrevious(f.createViewModel("Button",{onclick:vm.doPrevious,label:"&Previous",icon:"arrow-up",class:toolbarButtonClass})),0===ary.indexOf(theModel)&&(vm.buttonPrevious().disable(),vm.buttonPrevious().title("Current data is first record")),vm.buttonNext(f.createViewModel("Button",{onclick:vm.doNext,label:"&Next",icon:"arrow-down",class:toolbarButtonClass})),ary.indexOf(theModel)===ary.length-1&&(vm.buttonNext().disable(),vm.buttonNext().title("Current data is last record")),vm.buttonNew(f.createViewModel("Button",{onclick:vm.doNew,label:"&New",icon:"plus-circle",class:toolbarButtonClass})),"/Ready/Fetched/ReadOnly"===f.findRoot(theModel).state().current()[0]&&(vm.buttonNew().disable(),vm.buttonNew().title("Data is read only")),sseState.resolve("Error").enter((function(){vm.sseErrorDialog().show()})),vm}};f.catalog().register("viewModels","childFormPage",childFormPage.viewModel),childFormPage.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel||childFormPage.viewModel(vnode.attrs)},view:function(vnode){if(vnode.attrs.isInvalid)return;let lock,theTitle,vm=this.viewModel,model=vm.model(),icon="file-alt",btn=f.getComponent("Button"),toolbarClass="fb-toolbar";switch(f.currentUser().mode){case"test":toolbarClass+=" fb-toolbar-test";break;case"dev":toolbarClass+=" fb-toolbar-dev"}if(model.isValid())switch(model.state().current()[0]){case"/Locked":icon="lock",lock=model.data.lock()||{},theTitle="User: "+lock.username+"\nSince: "+new Date(lock.created).toLocaleTimeString();break;case"/Ready/Fetched/Dirty":icon="pencil-alt",theTitle="Editing record";break;case"/Ready/New":icon="plus",theTitle="New record"}else icon="exclamation-triangle",theTitle=model.lastError();return m("div",[m("div",{id:"toolbar",class:toolbarClass},[m(btn,{viewModel:vm.buttonDone()}),m(btn,{viewModel:vm.buttonPrevious()}),m(btn,{viewModel:vm.buttonNext()}),m(btn,{viewModel:vm.buttonNew()})]),m("div",{class:"fb-title"},[m("i",{class:"fa fa-"+icon+" fb-title-icon",title:theTitle}),m("label",vm.title())]),m(f.getComponent("Dialog"),{viewModel:vm.sseErrorDialog()}),m(f.getComponent("FormWidget"),{viewModel:vm.formWidget()})])}},f.catalog().register("components","childFormPage",childFormPage.component);const childTable={viewModel:function(options){let tableState,canAdd,root=f.findRoot(options.parentViewModel.model()),vm={},instances=f.catalog().register("instances");function toggleCanAdd(){let currentState=root.state().current()[0];canAdd()&&"/Ready/Fetched/ReadOnly"!==currentState&&"/Locked"!==currentState?(vm.buttonAdd().enable(),vm.buttonOpen().enable()):(vm.buttonAdd().disable(),vm.buttonOpen().disable())}return vm.buttonAdd=f.prop(),vm.buttonOpen=f.prop(),vm.buttonRemove=f.prop(),vm.buttonUndo=f.prop(),vm.buttonUp=f.prop(),vm.buttonDown=f.prop(),vm.childForm=f.prop(),vm.doChildOpen=function(){let feather,selection=vm.tableWidget().selection(),models=vm.tableWidget().models();selection||(feather=options.feather.name,selection=f.createModel(feather),models.add(selection)),instances[selection.id()]=selection,selection&&m.route.set("/traverse/:feather/:key",{feather:options.feather.name.toSpinalCase(),key:selection.id()},{state:{parentProperty:options.parentProperty,form:options.config.form}})},vm.moveDown=function(){let tw=vm.tableWidget(),sel=tw.selection(),models=tw.models(),idx=models.indexOf(sel)+1;tw.models().moveDown(sel),tw.select(models[idx])},vm.moveUp=function(){let tw=vm.tableWidget(),sel=tw.selection(),models=tw.models(),idx=models.indexOf(sel)-1;tw.models().moveUp(sel),tw.select(models[idx])},vm.tableWidget=f.prop(),vm.parentViewModel=f.prop(options.parentViewModel),vm.refresh=function(){vm.tableWidget().refresh()},vm.tableWidget(f.createViewModel("TableWidget",{config:options.config,models:options.models,feather:options.feather,containerId:vm.parentViewModel().containerId(),height:options.height})),vm.tableWidget().toggleEdit(),vm.tableWidget().isQuery(!1),vm.buttonAdd(f.createViewModel("Button",{onclick:vm.tableWidget().modelNew,title:"Insert",hotkey:"I",icon:"plus-circle",class:"fb-icon-button",style:{backgroundColor:"white"}})),vm.buttonRemove(f.createViewModel("Button",{onclick:vm.tableWidget().modelDelete,title:"Delete",hotkey:"D",icon:"trash",class:"fb-icon-button",style:{backgroundColor:"white"}})),vm.buttonRemove().disable(),vm.buttonUndo(f.createViewModel("Button",{onclick:vm.tableWidget().undo,title:"Undo",hotkey:"U",icon:"undo",class:"fb-icon-button",style:{backgroundColor:"white"}})),vm.buttonUndo().hide(),vm.buttonOpen(f.createViewModel("Button",{onclick:vm.doChildOpen,title:"Open",hotkey:"O",icon:"folder-plus",class:"fb-icon-button",style:{backgroundColor:"white"}})),vm.buttonUp(f.createViewModel("Button",{onclick:vm.moveUp,icon:"chevron-up",title:"Move up",class:"fb-icon-button",style:{backgroundColor:"white",float:"right"}})),vm.buttonDown(f.createViewModel("Button",{onclick:vm.moveDown,icon:"chevron-down",title:"Move down",class:"fb-icon-button",style:{backgroundColor:"white",float:"right"}})),tableState=vm.tableWidget().state(),tableState.resolve("/Selection/Off").enter((function(){vm.buttonRemove().disable(),vm.buttonRemove().show(),vm.buttonUndo().hide()})),tableState.resolve("/Selection/On").enter((function(){let current=root.state().current()[0];"/Ready/Fetched/ReadOnly"!==current&&"/Locked"!==current&&vm.tableWidget().selection().canDelete()&&vm.buttonRemove().enable(),vm.buttonOpen().icon("folder-open"),vm.buttonOpen().enable()})),tableState.resolve("/Selection/On/Clean").enter((function(){vm.buttonRemove().show(),vm.buttonUndo().hide()})),tableState.resolve("/Selection/On/Dirty").enter((function(){vm.buttonRemove().hide(),vm.buttonUndo().show()})),root.state().resolve("/Ready/Fetched/Clean").enter((function(){let selection=vm.tableWidget().selection();selection&&!vm.tableWidget().models().some((function(model){return selection.id()===model.id()}))&&vm.tableWidget().select(void 0)})),canAdd=vm.tableWidget().models().canAdd,root.state().resolve("/Ready/Fetched/ReadOnly").enter((function(){vm.buttonAdd().disable(),vm.buttonOpen().disable()})),root.state().resolve("/Ready/Fetched/ReadOnly").exit(toggleCanAdd),root.state().resolve("/Locked").enter(vm.buttonAdd().disable),root.state().resolve("/Locked").exit(toggleCanAdd),canAdd.state().resolve("/Changing").exit(toggleCanAdd),toggleCanAdd(),vm.parentViewModel().containerId()&&(vm.buttonOpen().style().display="none"),vm}};f.catalog().register("viewModels","childTable",childTable.viewModel),childTable.component={oninit:function(vnode){let theConfig,overload,keys,theParentProperty=vnode.attrs.parentProperty,theParentViewModel=vnode.attrs.parentViewModel,prop=theParentViewModel.model().data[theParentProperty],theModels=prop(),theFeather=f.catalog().getFeather(prop.type.relation),overloads=f.catalog().getFeather(theParentViewModel.model().name).overloads||{},relations=vnode.attrs.parentViewModel.relations();theConfig=theParentViewModel.config().attrs.find((function(item){return item.attr===theParentProperty})),overload=overloads[theParentProperty],overload&&(theFeather.overloads=theFeather.overloads||{},keys=Object.keys(overload),keys.forEach((function(key){theFeather.overloads[key]=overload[key]}))),relations[theParentProperty]||(relations[theParentProperty]=childTable.viewModel({parentViewModel:theParentViewModel,parentProperty:theParentProperty,models:theModels,feather:theFeather,config:theConfig,height:vnode.attrs.height})),this.viewModel=relations[theParentProperty]},view:function(){let vm=this.viewModel,btn=f.getComponent("Button"),sel=vm.tableWidget().selection(),ary=vm.tableWidget().models(),index=ary.indexOf(sel),buttonUp=vm.buttonUp(),buttonDown=vm.buttonDown();return buttonUp.disable(),buttonDown.disable(),sel&&ary.length>1&&(index<ary.length-1&&buttonDown.enable(),index>0&&buttonUp.enable()),m("div",[m(btn,{viewModel:vm.buttonAdd()}),m(btn,{viewModel:vm.buttonRemove()}),m(btn,{viewModel:vm.buttonUndo()}),m(btn,{viewModel:vm.buttonOpen()}),m(btn,{viewModel:vm.buttonDown()}),m(btn,{viewModel:vm.buttonUp()}),m(f.getComponent("TableWidget"),{viewModel:vm.tableWidget()})])}},f.catalog().register("components","childTable",childTable.component);const contactRelation={viewModel:function(options){let vm=f.createViewModel("RelationWidget",options);return vm.labels=function(){let phone,email,address,phoneUrl,emailUrl,addressUrl,elements=[],model=options.parentViewModel.model().data[options.parentProperty]();return model&&(phone=model.data.phone?model.data.phone():"",email=model.data.email?model.data.email():"",address=model.data.address?model.data.address():"",phone&&(phoneUrl="tel:"+phone,elements.push(m("li",{class:"pure-menu-item"},[m("a",{href:phoneUrl,target:"_blank"},[m("i",{class:"fa fa-phone fb-contact-relation-icon fb-icon-button"})])],phone))),email&&(emailUrl="mailto:"+email,elements.push(m("li",{class:"pure-menu-item"},[m("a",{href:emailUrl,target:"_blank"},[m("i",{class:"fa fa-envelope fb-contact-relation-icon fb-icon-button"})])],email))),address&&(addressUrl="https://maps.google.com/?q=",addressUrl+=address.data.street()+", ",addressUrl+=address.data.city()+", ",addressUrl+=address.data.state()+", ",addressUrl+=address.data.postalCode()+"/",elements.push(m("li",{class:"pure-menu-item"},[m("a",{href:addressUrl,target:"_blank"},[m("i",{class:"fa fa-map-marker fb-contact-relation-icon fb-icon-button"})])],address.data.city()+", "+address.data.state())))),m("ul",{class:"pure-menu-list"},elements)},vm}};f.catalog().register("viewModels","contactRelation",contactRelation.viewModel),contactRelation.component={oninit:function(vnode){let list,theForm,options=vnode.attrs,id=vnode.attrs.form||"6kir5kogekam",relations=options.parentViewModel.relations();theForm=f.catalog().store().data().forms().find((row=>id===row.id)),theForm&&(theForm=theForm.toJSON()),list={columns:[{attr:"firstName"},{attr:"lastName"},{attr:"phone"},{attr:"email"},{attr:"address.city"},{attr:"address.state"}]},options.isCell=void 0!==options.isCell&&options.isCell,relations[options.parentProperty]||(relations[options.parentProperty]=contactRelation.viewModel({parentViewModel:options.parentViewModel,parentProperty:options.parentProperty,valueProperty:options.valueProperty||"fullName",form:theForm,list:options.list||list,filter:options.filter,isCell:options.isCell,id:options.id,isReadOnly:options.isReadOnly,style:options.style||{}})),this.viewModel=relations[options.parentProperty]},view:f.getComponent("RelationWidget").view,labelProperty:f.prop("phone"),valueProperty:f.prop("fullName")},f.catalog().register("components","contactRelation",contactRelation.component);const dataList={},table={viewModel:function(options){let tableState,vm={};return vm.buttonAdd=f.prop(),vm.buttonOpen=f.prop(),vm.buttonRemove=f.prop(),vm.buttonUndo=f.prop(),vm.tableWidget=f.prop(),vm.tableWidget(f.createViewModel("TableWidget",{config:{columns:[{attr:"value"},{attr:"label"}]},models:options.models,feather:"DataListOption",height:"250px"})),vm.tableWidget().toggleEdit(),vm.tableWidget().isQuery(!1),vm.buttonAdd(f.createViewModel("Button",{onclick:vm.tableWidget().modelNew,title:"Insert",hotkey:"I",icon:"plus-circle",style:{backgroundColor:"white"}})),vm.buttonRemove(f.createViewModel("Button",{onclick:vm.tableWidget().modelDelete,title:"Delete",hotkey:"D",icon:"trash",style:{backgroundColor:"white"}})),vm.buttonRemove().disable(),vm.buttonUndo(f.createViewModel("Button",{onclick:vm.tableWidget().undo,title:"Undo",hotkey:"U",icon:"undo",style:{backgroundColor:"white"}})),vm.buttonUndo().hide(),tableState=vm.tableWidget().state(),tableState.resolve("/Selection/Off").enter((function(){vm.buttonRemove().disable(),vm.buttonRemove().show(),vm.buttonUndo().hide()})),tableState.resolve("/Selection/On").enter((function(){vm.buttonRemove().enable()})),tableState.resolve("/Selection/On/Clean").enter((function(){vm.buttonRemove().show(),vm.buttonUndo().hide()})),tableState.resolve("/Selection/On/Dirty").enter((function(){vm.buttonRemove().hide(),vm.buttonUndo().show()})),vm}};table.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel},view:function(){let vm=this.viewModel,btn=f.getComponent("Button"),tw=f.getComponent("TableWidget");return m("div",[m(btn,{viewModel:vm.buttonAdd()}),m(btn,{viewModel:vm.buttonRemove()}),m(btn,{viewModel:vm.buttonUndo()}),m(tw,{viewModel:vm.tableWidget()})])}},dataList.viewModel=function(options){let dlg,vm={},parent=options.parentViewModel;return vm.buttonEdit=f.prop(),vm.dataListDialog=f.prop(),vm.content=function(){let val=vm.prop()||[];return f.types.array.tableData({value:val,options:{}})},vm.doEdit=function(){let models=vm.models(),dataListDialog=vm.dataListDialog(),value=vm.prop()||[],dataListOption=f.catalog().store().models().dataListOption;models.reset(),value.forEach((function(i){let instance=dataListOption(i);instance.state().goto("/Ready/Fetched/Clean"),models.add(instance)})),models.state().goto("/Fetched/Clean"),dataListDialog.onOk((function(){models=models.slice(),models=models.filter((i=>"/Delete"!==i.state().current()[0])),vm.prop(models.map((function(i){return{value:i.data.value(),label:i.data.label()}})))})),dataListDialog.okDisabled(!0),dataListDialog.show()},vm.key=f.prop(options.key||f.createId()),vm.id=f.prop(options.id||f.createId()),vm.models=f.prop(f.createList("DataListOption",{fetch:!1})),vm.prop=parent.model().data[options.parentProperty],vm.style=f.prop(options.style||{}),vm.table=f.prop(),vm.dataListDialog(f.createViewModel("Dialog",{icon:"edit",title:"Data list"})),dlg=vm.dataListDialog(),dlg.content=function(){return m(table.component,{viewModel:vm.table()})},dlg.style().width="480px",dlg.style().height="450px",vm.models().canAdd=f.prop(!0),vm.models().state().resolve("/Fetched/Dirty").enter((()=>dlg.okDisabled(!1))),vm.table(table.viewModel({models:vm.models(),containterId:vm.dataListDialog().ids().dialog})),vm.buttonEdit(f.createViewModel("Button",{onclick:vm.doEdit,title:"Edit relation details",icon:"edit",class:"fb-data-type-edit-button"})),vm},dataList.component={oninit:function(vnode){let options=vnode.attrs;this.viewModel=dataList.viewModel({parentViewModel:options.parentViewModel,parentProperty:options.parentProperty,id:options.id,key:options.key,style:options.style})},view:function(vnode){let vm=this.viewModel,theStyle=vm.style(),readonly=!0===vnode.attrs.readonly,theId=vm.id(),btn=f.getComponent("Button"),dlg=f.getComponent("Dialog");return readonly?vm.buttonEdit().disable():vm.buttonEdit().enable(),theStyle.display=theStyle.display||"inline-block",m("div",{style:theStyle,key:vm.key()},[m(dlg,{viewModel:vm.dataListDialog()}),m("input",{id:theId,class:"fb-data-list-input",onchange:vm.onchange,oncreate:vnode.attrs.onCreate,onremove:vnode.attrs.onRemove,value:vm.content(),readonly:!0,title:vm.content()}),m(btn,{viewModel:vm.buttonEdit()})])}},f.catalog().register("components","dataList",dataList.component);const dataType={},listWidget={viewModel:function(options){let vm={};return vm.name=f.prop(options.name),vm.items=f.prop([]),vm.onclick=function(e){let selected=vm.selected(),idx=selected.indexOf(e.target.textContent);-1===idx?selected.push(e.target.textContent):selected.splice(idx,1)},vm.selected=f.prop([]),vm}};listWidget.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel},view:function(vnode){let vm=this.viewModel,name=vm.name(),items=vm.items()||[],selected=vm.selected();return m("table",{class:"pure-table",style:vnode.attrs.style,readonly:vnode.attrs.readonly},[m("thead",[m("tr",[m("th",{class:"fb-data-type-dialog-list-header"},name)])]),m("tbody",{class:"fb-table-body fb-data-type-dialog-list-body"},items.map((function(i){return m("tr",{onclick:vm.onclick,class:-1===selected.indexOf(i)?"":"fb-data-type-dialog-list-selected"},[m("td",i)])})))])}},dataType.viewModel=function(options){let vm={},parent=options.parentViewModel;return vm.buttonAdd=f.prop(),vm.buttonEdit=f.prop(),vm.buttonRemove=f.prop(),vm.dataTypeDialog=f.prop(),vm.childOf=function(){let type=vm.prop();return"object"==typeof type&&null!==type&&type.childOf||""},vm.feathers=function(){let countries=f.catalog().store().data().countries().map((function(model){return model.data.name()})).sort();return countries.unshift(""),countries},vm.key=f.prop(options.key||f.createId()),vm.id=f.prop(options.id||f.createId()),vm.isOverload=f.prop(Boolean(options.isOverload)),vm.model=parent.model().data[options.parentProperty],vm.onchange=function(e,showDialog){if("relation"===e.target.value){if(vm.prop({}),!1!==showDialog&&vm.dataTypeDialog().show(),vm.buttonAdd().enable(),vm.buttonRemove().enable(),e.target.value&&vm.relation())return}else vm.prop(e.target.value);vm.propsAvailableWidget().items([]),vm.propsSelectedWidget().items([]),vm.buttonAdd().disable(),vm.buttonRemove().disable()},vm.onchangeDialogChildOf=function(e){let type=vm.prop();"object"==typeof type&&(type=f.copy(type),e.target.value?type.childOf=e.target.value:delete type.childOf,vm.prop(type))},vm.onchangeDialogType=function(e){vm.onchange(e,!1)},vm.onchangeDialogRelation=function(e){let type=f.copy(vm.prop());"object"==typeof type&&(type.relation=e.target.value,vm.prop(type),e.target.value?(vm.buttonAdd().enable(),vm.buttonRemove().enable(),vm.propsAvailableWidget().items(vm.properties()),vm.propsSelectedWidget().items([])):(vm.buttonAdd().disable(),vm.buttonRemove().disable()))},vm.propertyAdd=function(){let selected=vm.propsAvailableWidget().selected(),items=vm.propertiesSelected().slice();selected.forEach((item=>items.push(item))),selected.length=0,vm.propsAvailableWidget().items(vm.propertiesAvailable()),vm.propsSelectedWidget().items(items)},vm.propertyRemove=function(){let wSelected=vm.propsSelectedWidget().selected(),selected=vm.propertiesSelected().slice();wSelected.forEach((function(item){selected.splice(selected.indexOf(item),1)})),wSelected.length=0,vm.propsAvailableWidget().items(vm.propertiesAvailable()),vm.propsSelectedWidget().items(selected)},vm.properties=function(){let fp,props=[],relation=vm.relation(),co=options.parentViewModel.model().data.type.childOf;return relation&&!vm.isOverload()&&(fp=f.catalog().getFeather(relation).properties,props=Object.keys(fp).filter((p=>p!==co)).sort()),props},vm.propertiesAvailable=function(){let props=vm.properties().slice(),selected=vm.propertiesSelected()||[];return props.filter((function(p){return-1===selected.indexOf(p)}))},vm.propertiesSelected=function(...args){let type=vm.prop();return"object"==typeof type&&null!==type?(type=f.copy(type),args.length&&(type.properties=args[0],vm.prop(type)),type.properties):[]},vm.relation=function(){let type=vm.prop();return"object"==typeof type&&null!==type?type.relation:""},vm.style=f.prop(options.style||{}),vm.prop=options.parentViewModel.model().data[options.parentProperty],vm.propsAvailableWidget=f.prop(),vm.propsSelectedWidget=f.prop(),vm.type=function(){let type=vm.prop();return"object"==typeof type&&null!==type?"relation":type},vm.types=f.prop(Object.freeze(["array","boolean","integer","number","object","relation","string"])),vm.update=function(){let props,type=vm.type(),rel=vm.relation(),childOf=vm.childOf(),value=type;"relation"===type&&(value={relation:rel},props=vm.propertiesSelected(),props?value.properties=props:childOf&&(value.childOf=childOf)),vm.prop(value)},vm.buttonAdd(f.createViewModel("Button",{onclick:vm.propertyAdd,title:"Add",icon:"arrow-alt-circle-right",style:{display:"block",backgroundColor:"white"}})),vm.buttonRemove(f.createViewModel("Button",{onclick:vm.propertyRemove,title:"Remove",icon:"arrow-alt-circle-left",style:{backgroundColor:"white"}})),vm.dataTypeDialog(f.createViewModel("Dialog",{icon:"edit",title:vm.isOverload()?"Overload type":"Data type"})),vm.dataTypeDialog().buttons().pop(),vm.dataTypeDialog().content=function(){let theId=vm.id(),isNotRelation="relation"!==vm.type(),isNotFeather=!vm.relation(),propertiesSelected=vm.propertiesSelected()||[],isOverload=vm.isOverload(),btn=f.getComponent("Button");return m("div",[m("div",{class:"pure-control-group"},[m("label",{for:theId},"Type:"),m("select",{id:theId,value:vm.type(),onchange:vm.onchangeDialogType,readonly:isOverload,disabled:isOverload},vm.types().map((function(item){return m("option",{value:item,label:item,key:theId+"$"+item})})))]),m("div",{class:"pure-control-group"},[m("label",{for:"dlgRelation"},"Feather:"),m("select",{id:"dlgRelation",value:vm.relation(),onchange:vm.onchangeDialogRelation,readonly:isNotRelation,class:"fb-input"},f.feathers().map((function(item){return m("option",{value:item.value,label:item.label,key:theId+"$feather$"+item.value})})))]),m("div",{class:"pure-control-group"},[m("label",{for:"dlgChildOf"},"Child Of:"),m("input",{id:"dlgChildOf",value:vm.childOf(),onchange:vm.onchangeDialogChildOf,readonly:isNotFeather||propertiesSelected.length||isOverload})]),m("div",{class:"pure-control-group"},[m("label",{for:"dlgSelectors"},"Properties:"),m("div",{id:"dlgSelectors",style:{marginLeft:"100px",marginTop:"10px"}},[m(listWidget.component,{viewModel:vm.propsAvailableWidget(),style:{display:"inline-block",width:"120px"},readonly:isNotFeather||isOverload}),m("div",{style:{display:"inline-block",position:"absolute",marginTop:"36px"}},[m(btn,{viewModel:vm.buttonAdd()}),m(btn,{viewModel:vm.buttonRemove()})]),m(listWidget.component,{viewModel:vm.propsSelectedWidget(),style:{position:"absolute",left:"285px",display:"inline-block",width:"120px"},readonly:isNotFeather||isOverload})])])])},vm.dataTypeDialog().style().width="450px",vm.dataTypeDialog().style().height="450px",vm.buttonEdit(f.createViewModel("Button",{onclick:vm.dataTypeDialog().show,title:"Edit relation details",icon:"edit",class:"fb-data-type-edit-button"})),vm.propsAvailableWidget(listWidget.viewModel({name:"Available"})),vm.propsAvailableWidget().items=vm.propertiesAvailable,vm.propsSelectedWidget(listWidget.viewModel({name:"Selected"})),vm.propsSelectedWidget().items=vm.propertiesSelected,vm},dataType.component={oninit:function(vnode){let options=vnode.attrs;this.viewModel=dataType.viewModel({parentViewModel:options.parentViewModel,parentProperty:options.parentProperty,id:options.id,key:options.key,readonly:options.readonly,isOverload:options.isOverload})},view:function(vnode){let vm=this.viewModel,theId=vm.id(),theStyle=vm.style(),readOnly=!0===vnode.attrs.readonly||vm.isOverload(),btn=f.getComponent("Button");return theStyle.display=theStyle.display||"inline-block",vnode.attrs.readonly?vm.buttonEdit().disable():vm.buttonEdit().enable(),m("div",{style:theStyle,key:vm.key()},[m(f.getComponent("Dialog"),{viewModel:vm.dataTypeDialog()}),m("select",{id:theId,onchange:vm.onchange,oncreate:vnode.attrs.onCreate,onremove:vnode.attrs.onRemove,value:vm.type(),readonly:readOnly,disabled:readOnly},vm.types().map((function(item){let opts={value:item,label:item,key:theId+"$"+item};return vm.type()===item&&(opts.selected=!0),m("option",opts)}))),m(btn,{viewModel:vm.buttonEdit()})])}},f.catalog().register("components","dataType",dataType.component);const dialog={},dialogPolyfill=window.dialogPolyfill;dialog.viewModel=function(options){let vm,state;return options=options||{},vm={},vm.buttonOk=f.prop(),vm.buttonCancel=f.prop(),vm.buttons=f.prop([vm.buttonOk,vm.buttonCancel]),vm.icon=f.prop(options.icon),vm.ids=f.prop({dialog:options.id||f.createId(),header:f.createId(),buttonOk:f.createId(),buttonCancel:f.createId(),content:f.createId()}),vm.cancel=function(){let doCancel=vm.onCancel();"function"==typeof doCancel&&doCancel(),state.send("close")},vm.content=function(){return m("div",{id:vm.ids().content},vm.message())},vm.displayCancel=function(){return vm.onOk()?"inline-block":"none"},vm.message=f.prop(options.message||"Your message here"),vm.onCancel=f.prop(options.onCancel),vm.onOk=f.prop(options.onOk),vm.ok=function(){let doOk=vm.onOk();"function"==typeof doOk&&doOk(),state.send("close")},vm.okDisabled=f.prop(!1),vm.okTitle=f.prop(""),vm.show=function(){state.send("show")},vm.title=f.prop(options.title||""),vm.state=function(){return state},vm.style=f.prop({width:"450px"}),vm.buttonOk(f.createViewModel("Button",{onclick:vm.ok,label:"&Ok",class:"fb-dialog-button"})),vm.buttonOk().id(vm.ids().buttonOk),vm.buttonOk().isPrimary(!0),vm.buttonCancel(f.createViewModel("Button",{onclick:vm.cancel,label:"&Cancel",class:"fb-dialog-button"})),vm.buttonCancel().id(vm.ids().buttonCancel),state=f.State.define((function(){this.state("Display",(function(){this.state("Closed",(function(){this.enter((function(){let id=vm.ids().dialog,dlg=document.getElementById(id);dlg&&dlg.open&&dlg.close()})),this.event("show",(function(){this.goto("../Showing")}))})),this.state("Showing",(function(){this.enter((function(){let id=vm.ids().dialog,dlg=document.getElementById(id);dlg&&(dlg.showModal(),m.redraw())})),this.event("close",(function(){this.goto("../Closed")}))}))}))})),state.goto(),vm},f.catalog().register("viewModels","dialog",dialog.viewModel),dialog.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel||dialog.viewModel(vnode.attrs)},view:function(){let content,vm=this.viewModel,ids=vm.ids();return vm.okDisabled()?vm.buttonOk().disable():vm.buttonOk().enable(),vm.buttonOk().title(vm.okTitle()),content=vm.buttons().map((function(buttonItem){return m(f.getComponent("Button"),{viewModel:buttonItem()})})),content.unshift(m("br")),content.unshift(vm.content()),m("dialog",{id:ids.dialog,class:"fb-dialog",style:f.copy(vm.style()),oncreate:function(vnode){let dlg=document.getElementById(vnode.dom.id);dlg.showModal||dialogPolyfill.registerDialog(dlg)}},[m("h3",{id:ids.header,class:"fb-header"},[m("i",{class:"fa fa-"+vm.icon()+" fb-dialog-icon"})],vm.title().toName()),m("div",{class:"fb-dialog-content-frame"},content)])}},f.catalog().register("components","dialog",dialog.component);const filterDialog={viewModel:function(options){let vm,store,monkeyPatch=(options=options||{}).onOk,showDeletedButton=f.prop(f.createViewModel("Button",{label:"Show Deleted",icon:"far fa-square",onclick:function(){vm.filter().showDeleted=!Boolean(vm.filter().showDeleted)},class:"fb-button-checkbox fb-icon-button"}));function resolveProperty(feather,property){let prefix,suffix,rel,idx=property.indexOf(".");return idx>-1?(prefix=property.slice(0,idx),suffix=property.slice(idx+1,property.length),rel=feather.properties[prefix].type.relation||feather.properties[prefix].format.toProperCase(),resolveProperty(feather=f.catalog().getFeather(rel),suffix)):feather.properties[property]}function createEditor(obj){let w,component,prop,type,format,featherName,feather=vm.feather(),attr=obj.key,theValue=obj.value,index=obj.index,op=obj.operator,theId="fltr_value_editor_"+attr+index,opts={id:theId,key:theId},setToday=!1;return prop=resolveProperty(feather,attr),type=prop.type,format=prop.format||prop.type,"string"==typeof type?("boolean"===type?component=m(f.getComponent("Checkbox"),{value:theValue,onclick:vm.itemChanged.bind(this,index,"value")}):"date"!==format&&"dateTime"!==format||"IS"!==op?(opts.type=f.inputMap[format],opts.onchange="IN"===op?e=>vm.itemChanged.bind(this,index,"value")(e.target.value.split(",")):e=>vm.itemChanged.bind(this,index,"value")(e.target.value),opts.value=theValue,component=m("input",opts)):(-1===f.dateOptions.indexOf(theValue)&&(theValue="TODAY",setToday=!0),component=m("select",{id:theId,key:theId,onchange:e=>vm.itemChanged.bind(this,index,"value")(e.target.value),value:theValue},f.dateOptions.map((function(item){return m("option",{value:item,key:theId+"$"+item},item.toLowerCase().toCamelCase(!0).toProperCase())}))),setToday&&vm.itemChanged.bind(this,index,"value")(theValue)),component):type.childOf||type.parentOf||(featherName=feather.name.toCamelCase(),w=f.findRelationWidget(type.relation,!0),w||(w=f.createRelationWidget(type,featherName)),!w)?void 0:m(w,{parentProperty:attr,parentViewModel:vm,isCell:!0})}function getDefault(attr){let value,prop=resolveProperty(vm.feather(),attr),type=prop.type,format=prop.format;return"object"==typeof type?{id:""}:(value=format&&f.formats()[format]&&f.formats()[format].default?f.formats()[format].default:f.types[type].default,"function"==typeof value&&(value=value()),value)}return options.onOk=function(){options.filter(vm.filter()),monkeyPatch&&monkeyPatch()},options.title=options.title||"Filter",options.icon=options.icon||"filter",vm=f.createViewModel("TableDialog",options),vm.addAttr=function(attr){if(!this.some(vm.hasAttr.bind(attr)))return this.push({property:attr,value:getDefault(attr)}),!0},vm.attrs=function(){let feather=vm.feather(),keys=Object.keys(feather.properties);return vm.resolveProperties(feather,keys,void 0,void 0,!0).sort()},vm.data=function(){return vm.filter()[vm.propertyName()]},vm.itemPropertyChanged=function(index,value){vm.itemChanged(index,"property",value),vm.data()[index].value=getDefault(value),vm.data()[index].operator="="},vm.feather=f.prop(f.catalog().getFeather(options.feather.name,!0,!1)),vm.filter=f.prop(),vm.model=function(){return store},vm.operators=function(attr){let ops,prop,format,feather=vm.feather();if(ops=f.copy(f.operators),attr)switch(prop=resolveProperty(feather,attr),format=prop.format||prop.type,format){case"date":case"dateTime":delete ops["~*"],delete ops["!~*"],delete ops.IN;break;case"integer":case"number":case"money":delete ops["~*"],delete ops["!~*"],delete ops.IS,delete ops.IN;break;case"boolean":delete ops["~*"],delete ops["!~*"],delete ops[">"],delete ops["<"],delete ops[">="],delete ops["<="],delete ops.IS,delete ops.IN;break;case"string":case"password":case"tel":delete ops[">"],delete ops["<"],delete ops[">="],delete ops["<="],delete ops.IS;break;default:delete ops["~*"],delete ops["!~*"],delete ops[">"],delete ops["<"],delete ops[">="],delete ops["<="],delete ops.IN,delete ops.IS}return delete ops["~"],delete ops["!~"],ops},vm.propertyName=f.prop(options.propertyName||"criteria"),vm.relations=f.prop({}),vm.reset=function(){let name=vm.propertyName(),filter=f.copy(options.filter());filter[name]=filter[name]||[],vm.filter(filter),filter[name].length||vm.add(),vm.selection(0)},vm.viewHeaderIds=f.prop({column:f.createId(),operator:f.createId(),value:f.createId()}),vm.viewHeaders=function(){let ids=vm.viewHeaderIds();return[m("th",{class:"fb-filter-dialog-table-header-column",id:ids.column},"Column"),m("th",{class:"fb-filter-dialog-table-header-operator",id:ids.operator},"Operator"),m("th",{class:"fb-filter-dialog-table-header-value",id:ids.value},"Value")]},vm.viewRows=function(){let view;return vm.filter().showDeleted?showDeletedButton().icon("check-square"):showDeletedButton().icon("far fa-square"),view=vm.items().map((function(item){let row,operators=vm.operators(item.property);return row=m("tr",{onclick:vm.selection.bind(this,item.index,!0),style:{backgroundColor:vm.rowColor(item.index)}},[m("td",m("select",{class:"fb-filter-dialog-property",style:{minWidth:"175px"},value:item.property,onchange:e=>vm.itemPropertyChanged.bind(this,item.index)(e.target.value)},vm.attrs().map((function(attr){return m("option",{value:attr},attr.toName())})))),m("td",{class:"fb-filter-dialog-operator"},[m("select",{id:"filter_op_"+item.index,oncreate:function(vnode){document.getElementById(vnode.dom.id).value=item.operator||"="},onchange:e=>vm.itemChanged.bind(this,item.index,"operator")(e.target.value)},Object.keys(operators).map((function(op){return m("option",{value:op},operators[op])})),item.operator||"=")]),m("td",{class:"fb-filter-dialog-input-cell"},[createEditor({index:item.index,key:item.property,value:item.value,operator:item.operator,class:"fb-filter-dialog-input"})])]),row})),view},vm.style().width="750px",store=f.createModel({},vm.feather()),Object.keys(store.data).forEach((function(key){store.data[key].isToOne()&&store.onChange(key,(function(prop){vm.items().forEach((function(item){let value;item.property===key&&(value=prop.newValue(),value=value?{id:value.data.id()}:{id:""},vm.itemChanged(item.index,"value",value))}))}))})),vm.buttons().push(showDeletedButton),vm.reset(),vm}};f.catalog().register("viewModels","filterDialog",filterDialog.viewModel),filterDialog.component=f.getComponent("Dialog"),f.catalog().register("components","filterDialog",filterDialog.component);const aggregateDialog={};aggregateDialog.viewModel=function(options){let vm,monkeyPatch=(options=options||{}).onOk;function resolveProperty(feather,property){let prefix,suffix,rel,idx=property.indexOf(".");return idx>-1?(prefix=property.slice(0,idx),suffix=property.slice(idx+1,property.length),rel=feather.properties[prefix].type.relation||feather.properties[prefix].format.toProperCase(),resolveProperty(feather=f.catalog().getFeather(rel),suffix)):feather.properties[property]}return options.propertyName="sort",options.title=options.title||"Aggregate",options.icon=options.icon||"calculator",options.onOk=function(){options.aggregates(vm.data()),monkeyPatch&&monkeyPatch()},vm=f.createViewModel("TableDialog",options),vm.addAttr=function(attr){if(!this.some(vm.hasAttr.bind(attr)))return this.push({property:attr,method:"COUNT"}),!0},vm.attrs=function(){let feather=vm.feather(),keys=Object.keys(feather.properties);return vm.resolveProperties(feather,keys,void 0,void 0,!0).sort()},vm.data=f.prop([]),vm.feather=f.prop(f.catalog().getFeather(options.feather.name,!0,!1)),vm.viewHeaderIds=f.prop({column:f.createId(),method:f.createId()}),vm.viewHeaders=function(){let ids=vm.viewHeaderIds();return[m("th",{style:{minWidth:"175px"},id:ids.column},"Column"),m("th",{style:{minWidth:"175px"},id:ids.order},"Function")]},vm.methods=function(attr){let prop,feather=vm.feather(),methods=["AVG","COUNT","MAX","MIN","SUM"];return attr&&(prop=resolveProperty(feather,attr),"number"!==prop.type&&"integer"!==prop.type&&(methods=["COUNT"],"string"===prop.type&&(methods.push("MIN"),methods.push("MAX")))),methods},vm.reset=function(){let aggregates=f.copy(options.aggregates());aggregates=aggregates||[],vm.data(aggregates),aggregates.length||vm.add(),vm.selection(0)},vm.viewRows=function(){let view;function resetSelector(item,vnode){document.getElementById(vnode.dom.id).value=item.method||"COUNT"}return view=vm.items().map((function(item){let row,methods=vm.methods(item.property);return row=m("tr",{onclick:vm.selection.bind(this,item.index,!0),style:{backgroundColor:vm.rowColor(item.index)}},[m("td",{style:{minWidth:"175px",maxWidth:"175px"}},m("select",{style:{minWidth:"175px",maxWidth:"175px"},value:item.property,onchange:function(e){let i=item.index,v=e.target.value;vm.itemChanged(i,"property",v),vm.itemChanged(i,"method","COUNT")}},vm.attrs().map((function(attr){return m("option",{value:attr},attr.toName())})))),m("td",{style:{minWidth:"175px",maxWidth:"175px"}},[m("select",{style:{minWidth:"175px",maxWidth:"175px"},value:item.method||"COUNT",id:"agg_fn_"+item.index,oncreate:resetSelector.bind(null,item),onupdate:resetSelector.bind(null,item),onchange:e=>vm.itemChanged.bind(this,item.index,"method")(e.target.value)},methods.map((function(method){return m("option",{value:method},method)})),item.method||"COUNT")])]),row})),view},vm.reset(),vm.style().width="460px",vm},f.catalog().register("viewModels","aggregateDialog",aggregateDialog.viewModel),aggregateDialog.component=f.getComponent("Dialog"),f.catalog().register("components","aggregateDialog",aggregateDialog.component);const formDialog={viewModel:function(options){let vm,substate,onOk=options.onOk;return options.title=options.title||options.model.toName(),options.icon=options.icon||"file-text",options.onOk=function(){let model=vm.formWidget().model();model.save().then((function(){onOk&&onOk(model)}))},vm=f.createViewModel("Dialog",options),vm.formWidget=f.prop(),vm.modelId=f.prop(options.id),vm.okDisabled=function(){let w=vm.formWidget();return!w||!w.model().canSave()},vm.okTitle=function(){let w=vm.formWidget();return w?w.model().lastError()||"Record is unchanged":""},vm.content=function(){let state=vm.state();return state.resolve(state.current()[0]).content()},substate=vm.state().resolve("/Display/Closed"),substate.content=function(){return m("div")},substate=vm.state().resolve("/Display/Showing"),substate.enter((function(){vm.formWidget(f.createViewModel("FormWidget",{model:options.model,config:options.config,id:vm.modelId(),outsideElementIds:[vm.ids().header,vm.ids().buttonOk],containerId:vm.ids().dialog,isScrollable:!1})),delete vm.style().display})),substate.content=function(){return m(f.getComponent("FormWidget"),{viewModel:vm.formWidget()})},substate.exit((function(){vm.formWidget(void 0),vm.style().display="none"})),vm.style().top="50px",vm}};f.catalog().register("viewModels","formDialog",formDialog.viewModel),formDialog.component=f.getComponent("Dialog"),f.catalog().register("components","formDialog",formDialog.component);const formWidget={};function buildButtons(vm){let ret,className,lonelyTabClass=["pure-button","fb-group-tab","fb-group-tab-form"],midTabClass=f.copy(lonelyTabClass),leftTabClass=f.copy(lonelyTabClass),rightTabClass=f.copy(lonelyTabClass),tabs=vm.config().tabs||[],last=tabs.length-1;return tabs=tabs.map((tab=>tab.name)),tabs.length>1?(midTabClass.push("fb-group-tab-middle"),leftTabClass.push("fb-group-tab-left"),rightTabClass.push("fb-group-tab-right"),ret=tabs.map((function(name,idx){switch(idx){case 0:className=leftTabClass;break;case last:className=rightTabClass;break;default:className=f.copy(midTabClass)}return idx+1===vm.selectedTab()&&className.push("fb-group-tab-active"),m("button",{class:className.join(" "),onclick:vm.selectedTab.bind(null,idx+1)},name)})),ret):(lonelyTabClass.push("fb-group-tab-lonely"),lonelyTabClass.push("fb-group-tab-active"),m("button",{class:lonelyTabClass.join(" "),onclick:vm.selectedTab.bind(null,1)},tabs[0]))}function buildFieldset(vm,attrs){return attrs.map((function(item){let result,labelOpts,label,theKey=item.attr,theModel=vm.model(),prop=theModel.data[theKey];if(!prop)return void window.console.error("Unknown attribute "+theKey+" in form");let theDataList=item.dataList||prop.dataList,value=prop(),theOptions={height:item.height},menuButtons=vm.menuButtons(),relation=vm.relations()[theKey];return theOptions.disableCurrency=item.disableCurrency,theDataList&&("string"==typeof theDataList?theDataList=theModel.data[theDataList]():"object"!=typeof theDataList[0]&&(theDataList=theDataList.map((function(item){return{value:item,label:item}})))),labelOpts={for:theKey,key:theKey+"FormLabel",class:"fb-form-label",style:{},title:prop.description},relation&&relation.isRelationWidget?(menuButtons[theKey]||(menuButtons[theKey]={display:"none"}),labelOpts.class="pure-button fb-form-label-button",labelOpts.onclick=function(){menuButtons[theKey].display="block"},labelOpts.onmouseout=function(ev){ev&&ev.toElement&&ev.toElement.id&&-1!==ev.toElement.id.indexOf("nav-relation")||(menuButtons[theKey].display="none")},label=m("div",labelOpts,[m("div",{id:"nav-relation-div-"+theKey,class:"pure-menu fb-relation-menu"},[m("ul",{class:"pure-menu-list fb-relation-menu-list",id:"nav-relation-list-"+theKey,style:{top:"27px",display:menuButtons[theKey].display}},[m("li",{id:"nav-relation-search-"+theKey,class:function(){let ret="pure-menu-link fb-form-label-menu-item";return relation&&relation.isReadOnly&&relation.isReadOnly()&&(ret+=" pure-menu-disabled"),ret}(),onclick:function(e){return menuButtons[theKey].display="none",relation.search(),!1}},[m("i",{id:"nav-relation-search-icon-"+theKey,class:"fa fa-search"})]," Search"),m("li",{id:"nav-relation-open-"+theKey,class:function(){let ret="pure-menu-link fb-form-label-menu-item";return relation&&relation.model&&!relation.model()&&(ret+=" pure-menu-disabled"),ret}(),onclick:function(e){return menuButtons[theKey].display="none",relation.open(),!1}},[m("i",{id:"nav-relation-open-icon-"+theKey,class:"fa fa-folder-open"})]," Open"),m("li",{id:"nav-relation-new-"+theKey,class:function(){let ret="pure-menu-link fb-form-label-menu-item";return(relation&&relation.isReadOnly&&relation.isReadOnly()||!relation.canCreate())&&(ret+=" pure-menu-disabled"),ret}(),onclick:function(){return menuButtons[theKey].display="none",relation.new(),!1}},[m("i",{id:"nav-relation-new-icon-"+theKey,class:"fa fa-plus-circle"})]," New")])]),m("i",{class:"fa fa-bars",style:{marginRight:"4px"}})],item.label||prop.alias()+":")):label=m("label",labelOpts,(item.label||prop.alias())+":"),!1===item.showLabel&&(labelOpts.style.display="none"),prop.isReadOnly()||vm.focusAttr()||vm.focusAttr(theKey),vm.focusAttr()===theKey&&(theOptions.oncreate=function(vnode){document.getElementById(vnode.dom.id).focus()}),prop.isRequired()&&(null===value||"string"===prop.type&&!value)&&(labelOpts.style.color="Red"),result=m("div",{class:"pure-control-group"},[label,f.createEditor({model:theModel,key:theKey,dataList:theDataList,filter:item.filter,viewModel:vm,options:theOptions,widget:item.relationWidget})]),result}))}function resizeWidget(vm,vnode){let e=document.getElementById(vnode.dom.id),bodyHeight=window.innerHeight;vm.outsideElementIds().forEach((function(id){let h=document.getElementById(id).clientHeight;bodyHeight=bodyHeight.minus(h)})),e.style.maxHeight=bodyHeight-5+"px"}function buildUnit(vm,attrs,n){let fieldset=buildFieldset(vm,attrs);return m("div",{class:"pure-u-1 pure-u-md-1-"+n},[m("div",{class:"pure-form pure-form-aligned"},[m("fieldset",fieldset)])])}function buildGrid(grid,idx){let units,vm=this,className="fb-tabbed-panes fb-tabbed-panes-form";return units=grid.map((function(unit){return buildUnit(vm,unit,grid.length)})),idx?(idx!==vm.selectedTab()&&(className+=" fb-tabbed-panes-hidden"),m("div",{class:className},[buildButtons(vm),m("div",{class:"pure-g fb-tabbed-pane"},units)])):m("div",{class:"pure-g fb-top-pane"},units)}formWidget.viewModel=function(options){let model,modelState,vm={};return vm.config=f.prop(options.config),vm.containerId=f.prop(options.containerId),vm.errorDialog=f.prop(f.createViewModel("Dialog",{icon:"exclamation-circle",title:"Error"})),vm.errorDialog().buttonCancel().hide(),vm.isScrollable=f.prop(!1!==options.isScrollable),vm.focusAttr=f.prop(options.config.focus),vm.menuButtons=f.prop({}),vm.selectedTab=f.prop(1),vm.model=f.prop(),vm.outsideElementIds=f.prop(options.outsideElementIds||[]),vm.relations=f.prop({}),vm.selectComponents=f.prop({}),"object"==typeof options.model?vm.model(options.model):(model=vm.model(f.createModel(options.model.toCamelCase(!0))),options.id&&(model.id(options.id),options.isNew||(model.fetch(),model.checkUpdate()))),modelState=vm.model().state(),modelState.resolve("/Ready").enter((function(){let err=vm.model().lastError();err&&(vm.errorDialog().message(err.message),vm.errorDialog().show())})),vm.model().subscribe(!0),vm},f.catalog().register("viewModels","formWidget",formWidget.viewModel),formWidget.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel},onremove:function(){this.viewModel.model().subscribe(!1)},view:function(vnode){let vm=vnode.attrs.viewModel,attrs=vm.config().attrs||[],model=vm.model(),grids=[];return attrs.forEach((function(item){let gidx=item.grid||0,uidx=item.unit||0;grids[gidx]||(grids[gidx]=[]),grids[gidx][uidx]||(grids[gidx][uidx]=[]),grids[gidx][uidx].push(item)})),grids=grids.map(buildGrid.bind(vm)),grids.unshift(m(f.getComponent("Dialog"),{viewModel:vm.errorDialog()})),m("div",{id:model.id(),class:vm.isScrollable()?"fb-form-content":"",oncreate:resizeWidget.bind(null,vm),onupdate:resizeWidget.bind(null,vm)},grids)}},f.catalog().register("components","formWidget",formWidget.component);const moneyRelation={};function selections(item){let value=item.data.displayUnit()?item.data.displayUnit().data.code():item.data.code();return m("option",value)}moneyRelation.viewModel=function(options){let selector,wasReadOnly,wasCurrency,vm={},parent=options.parentViewModel,currencyList=f.catalog().store().data().currencies,currConvList=f.createList("CurrencyConversion",{fetch:!1}),prop=f.resolveProperty(parent.model(),options.parentProperty);return parent.model().onChange(options.parentProperty,(function(p){let baseCode=f.baseCurrency().data.code(),newCurr=p.newValue().currency;newCurr!==baseCode?p.oldValue().currency===newCurr||p.newValue().ratio||(vm.conversion(null),vm.fetchConversion(baseCode,f.getCurrency(newCurr).data.code())):vm.conversion(null)})),parent.model().state().resolve("/Ready/Fetched").enter((function(){let baseCode=f.baseCurrency().data.code(),newCurr=prop().currency;newCurr!==baseCode?newCurr&&!prop().ratio&&(vm.conversion(null),vm.fetchConversion(baseCode,f.getCurrency(newCurr).data.code())):vm.conversion(null)})),vm.id=f.prop(options.id),vm.key=f.prop(options.key),vm.isCell=f.prop(Boolean(options.isCell)),vm.label=function(){return f.baseCurrency(vm.effective()).data.code()},vm.amount=function(...args){let money;return args.length&&(money=f.copy(prop()),money.amount=args[0],prop(money)),prop().amount},vm.baseAmount=function(){let ret,money,baseCode=f.baseCurrency(vm.effective()).data.code(),conv=vm.conversion(),value=prop.toJSON();if(value.effective)ret=value.baseAmount;else if(conv&&conv.data.fromCurrency().data.code()===baseCode)ret=value.amount.times(conv.data.ratio.toJSON());else{if(!conv)return;ret=value.amount.div(conv.data.ratio.toJSON())}return money={amount:ret,currency:baseCode,effective:null,baseAmount:null},f.formats().money.fromType(money).amount},vm.conversion=f.prop(),vm.currency=function(...args){let money;return args.length&&(money=f.copy(prop()),money.currency=args[0],prop(money)),prop().currency},vm.disableCurrency=f.prop(Boolean(options.disableCurrency)),vm.currencies=function(){let ret,curr=vm.currency();return ret=currencyList().map((function(item){return item})).filter((function(item){return!item.data.isDeleted()||curr===item.data.code()||item.data.displayUnit()&&curr===item.data.displayUnit().data.code()})),ret.sort((function(a,b){return(a.data.displayUnit()?a.data.displayUnit().data.code():a.data.code())>(b.data.displayUnit()?b.data.displayUnit().data.code():b.data.code())?1:-1})),ret},vm.effective=function(){return prop().effective},vm.fetchConversion=function(fromCurr,toCurr){return new Promise((function(resolve,reject){let filter;filter={criteria:[{value:[fromCurr,toCurr],operator:"IN",property:"fromCurrency.code"},{value:[fromCurr,toCurr],operator:"IN",property:"toCurrency.code"}],sort:[{property:"effective",order:"DESC"}],limit:1},currConvList.fetch(filter,!1).then((function(result){vm.conversion(result.length?result[0]:null),resolve()})).catch((function(err){reject(err)}))}))},vm.selector=function(vnode){let selectorStyle,readOnly=!0===vnode.attrs.readonly||vm.disableCurrency()||vm.effective(),currency=vm.currency();return selector&&readOnly===wasReadOnly&&currency===wasCurrency||(selectorStyle={width:"95px"},vm.showCurrency()||(selectorStyle.display="none"),wasReadOnly=readOnly,wasCurrency=currency,selector=m("select",{id:"C"+vm.id(),onchange:e=>vm.currency(e.target.value),value:currency,readonly:readOnly,style:selectorStyle},vm.currencies().map(selections))),selector},vm.showCurrency=f.prop(!1!==options.showCurrency),vm},moneyRelation.component={oninit:function(vnode){let options=vnode.attrs;this.viewModel=moneyRelation.viewModel({parentViewModel:options.parentViewModel,parentProperty:options.parentProperty,id:options.id,key:options.key,isCell:options.isCell,readonly:options.readonly,showCurrency:options.showCurrency,disableCurrency:options.disableCurrency})},view:function(vnode){let currencyLabelStyle,inputStyle,amountLabelStyle,displayStyle,vm=this.viewModel,readOnly=Boolean(!0===vnode.attrs.readonly||vm.effective()),theId="A"+vm.id();return displayStyle={display:"inline-block"},amountLabelStyle={textAlign:"right",marginTop:vm.label()?"6px":"",marginRight:"30px",display:"inline-block"},inputStyle={marginRight:"4px",width:"116px",textAlign:"right"},vm.isCell()&&(displayStyle.float="right",amountLabelStyle.display="none"),vm.baseAmount()||(amountLabelStyle.display="none"),currencyLabelStyle=f.copy(amountLabelStyle),amountLabelStyle.width="105px",m("div",{style:displayStyle,key:vm.key()},[m("input",{style:inputStyle,id:theId,onchange:e=>vm.amount(e.target.value),value:vm.amount(),readonly:readOnly,oncreate:vnode.attrs.onCreate,onremove:vnode.attrs.onRemove,onfocus:vnode.attrs.onFocus,onblur:vnode.attrs.onBlur,autocomplete:"off"}),vm.selector(vnode),m("div",[m("div",{style:amountLabelStyle},vm.baseAmount()),m("div",{style:currencyLabelStyle},vm.label())])])}},f.catalog().register("components","moneyRelation",moneyRelation.component);const searchInput={viewModel:function(options){let vm,state;return options=options||{},vm={},vm.clear=function(){vm.text(""),vm.end()},vm.end=function(){state.send("end")},vm.id=f.prop(f.createId()),vm.onkeydown=function(e){"Enter"===(e.key||e.keyIdentifier)&&vm.refresh()},vm.refresh=function(){options.refresh&&options.refresh()},vm.start=function(){state.send("start")},vm.state=function(){return state},vm.style=function(){return state.resolve(state.current()[0]).style()},vm.text=f.prop(),vm.value=function(){return state.resolve(state.current()[0]).value()},state=f.State.define((function(){this.state("Search",(function(){this.state("Off",(function(){this.enter((function(){vm.text("Search")})),this.event("start",(function(){this.goto("../On")})),this.style=function(){return{color:"LightGrey",margin:"2px"}},this.value=function(){return""}})),this.state("On",(function(){this.enter((function(){vm.text("")})),this.exit((function(){vm.refresh()})),this.canExit=function(){return!vm.text()},this.event("end",(function(){this.goto("../Off")})),this.style=function(){return{color:"Black",margin:"2px"}},this.value=function(){return vm.text()}}))}))})),state.goto(),vm}};f.catalog().register("viewModels","searchInput",searchInput.viewModel),searchInput.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel||searchInput.viewModel(vnode.attrs)},view:function(){let vm=this.viewModel;return m("input",{id:vm.id(),value:vm.text(),class:"fb-search-input",style:vm.style(),onfocus:vm.start,onblur:vm.end,oninput:e=>vm.text(e.target.value),onkeydown:vm.onkeydown})}},f.catalog().register("components","searchInput",searchInput.component);const searchPage={viewModel:function(options){let vm={},theFeather=f.catalog().getFeather(options.feather.toCamelCase(!0)),theConfig=f.catalog().register("config")[options.config];return vm.buttonBack=f.prop(),vm.buttonSelect=f.prop(),vm.buttonClear=f.prop(),vm.buttonFilter=f.prop(),vm.buttonRefresh=f.prop(),vm.buttonSort=f.prop(),vm.doBack=function(){window.history.back()},vm.doSelect=function(){let receivers,selection;options.receiver&&(receivers=f.catalog().register("receivers"),receivers[options.receiver]&&(selection=vm.tableWidget().selection(),receivers[options.receiver].callback(selection),delete receivers[options.receiver])),vm.doBack()},vm.filterDialog=f.prop(),vm.sortDialog=f.prop(),vm.searchInput=f.prop(),vm.tableWidget=f.prop(),vm.refresh=function(){vm.tableWidget().refresh()},vm.searchInput(f.createViewModel("SearchInput",{refresh:vm.refresh})),vm.tableWidget(f.createViewModel("TableWidget",{config:theConfig,feather:options.feather.toCamelCase(!0),search:vm.searchInput().value,ondblclick:vm.doSelect})),vm.filterDialog(f.createViewModel("FilterDialog",{filter:vm.tableWidget().filter,list:vm.tableWidget().models(),feather:theFeather})),vm.sortDialog(f.createViewModel("SortDialog",{filter:vm.tableWidget().filter,list:vm.tableWidget().models(),feather:theFeather})),vm.buttonBack(f.createViewModel("Button",{onclick:vm.doBack,label:"&Back",icon:"arrow-left",class:"fb-toolbar-button"})),vm.buttonSelect(f.createViewModel("Button",{onclick:vm.doSelect,label:"&Select",title:vm.selectTitle,disabled:vm.selectDisabled,class:"fb-toolbar-button"})),vm.buttonSelect().isDisabled=function(){return!vm.tableWidget().selection()},vm.buttonSelect().title=function(){return vm.buttonSelect().isDisabled()?"A row must be selected":""},vm.buttonRefresh(f.createViewModel("Button",{onclick:vm.refresh,title:"Refresh",hotkey:"R",icon:"sync",class:"fb-toolbar-button"})),vm.buttonClear(f.createViewModel("Button",{onclick:vm.searchInput().clear,title:"Clear search",hotkey:"C",icon:"eraser",class:"fb-toolbar-button"})),vm.buttonClear().isDisabled=function(){return!vm.searchInput().value()},vm.buttonFilter(f.createViewModel("Button",{onclick:vm.filterDialog().show,title:"Filter",hotkey:"F",icon:"filter",class:"fb-toolbar-button"})),vm.buttonSort(f.createViewModel("Button",{onclick:vm.sortDialog().show,title:"Sort",hotkey:"O",icon:"sort",class:"fb-toolbar-button"})),vm}};f.catalog().register("viewModels","searchPage",searchPage.viewModel),searchPage.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel||searchPage.viewModel(vnode.attrs)},onremove:function(vnode){delete f.catalog().register("config")[vnode.attrs.config]},view:function(){let vm=this.viewModel,btn=f.getComponent("Button"),srch=f.getComponent("SearchInput"),sdlg=f.getComponent("SortDialog"),fdlg=f.getComponent("FilterDialog"),tw=f.getComponent("TableWidget");return m("div",{class:"pure-form"},[m("div",{class:"fb-toolbar"},[m(btn,{viewModel:vm.buttonBack()}),m(btn,{viewModel:vm.buttonSelect()}),m(srch,{viewModel:vm.searchInput()}),m(btn,{viewModel:vm.buttonRefresh()}),m(btn,{viewModel:vm.buttonClear()}),m(btn,{viewModel:vm.buttonSort()}),m(btn,{viewModel:vm.buttonFilter()})]),m(sdlg,{viewModel:vm.sortDialog()}),m(fdlg,{viewModel:vm.filterDialog()}),m(tw,{viewModel:vm.tableWidget()})])}},f.catalog().register("components","searchPage",searchPage.component);const sortDialog={viewModel:function(options){let vm;return(options=options||{}).propertyName="sort",options.title=options.title||"Sort",options.icon=options.icon||"sort",vm=f.createViewModel("FilterDialog",options),vm.addAttr=function(attr){if(!this.some(vm.hasAttr.bind(attr)))return this.push({property:attr}),!0},vm.attrs=function(){let feather=vm.feather(),keys=Object.keys(feather.properties);return vm.resolveProperties(feather,keys).sort()},vm.viewHeaderIds=f.prop({column:f.createId(),order:f.createId()}),vm.viewHeaders=function(){let ids=vm.viewHeaderIds();return[m("th",{style:{minWidth:"175px"},id:ids.column},"Column"),m("th",{style:{minWidth:"175px"},id:ids.order},"Order")]},vm.viewRows=function(){let view;return view=vm.items().map((function(item){let row;return row=m("tr",{onclick:vm.selection.bind(this,item.index,!0),style:{backgroundColor:vm.rowColor(item.index)}},[m("td",{style:{minWidth:"175px",maxWidth:"175px"}},m("select",{style:{minWidth:"175px",maxWidth:"175px"},value:item.property,onchange:e=>vm.itemChanged.bind(this,item.index,"property")(e.target.value)},vm.attrs().map((function(attr){return m("option",{value:attr},attr.toName())})))),m("td",{style:{minWidth:"175px",maxWidth:"175px"}},[m("select",{style:{minWidth:"175px",maxWidth:"175px"},value:item.order||"ASC",onchange:e=>vm.itemChanged.bind(this,item.index,"order")(e.target.value)},[m("option",{value:"ASC"},"Ascending"),m("option",{value:"DESC"},"Descending")])])]),row})),view},vm.style().width="460px",vm}};f.catalog().register("viewModels","sortDialog",sortDialog.viewModel),sortDialog.component=f.getComponent("Dialog"),f.catalog().register("components","sortDialog",sortDialog.component);const settingsPage={viewModel:function(options){options=options||{};let vm={},form={},models=f.catalog().store().models(),theModel=models[options.settings](),definition=models[options.settings].definition();return form.name=definition.name,form.description=definition.description,form.attrs=[],Object.keys(definition.properties).forEach((function(key){form.attrs.push({attr:key,grid:0,unit:0})})),vm.buttonDone=f.prop(),vm.doDone=function(){theModel.canSave()?vm.formWidget().model().save().then((function(){window.history.back()})):window.history.back()},vm.formWidget=f.prop(f.createViewModel("FormWidget",{model:theModel,id:options.settings,config:form,outsideElementIds:["toolbar"]})),vm.model=f.prop(theModel),vm.title=function(){return options.settings.toName()},vm.buttonDone(f.createViewModel("Button",{onclick:vm.doDone,label:"&Done",class:"fb-toolbar-button"})),"/Ready/New"===theModel.state().current()[0]&&theModel.fetch(),vm}};settingsPage.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel||settingsPage.viewModel(vnode.attrs)},view:function(){let vm=this.viewModel;return m("div",[m("div",{id:"toolbar",class:"fb-toolbar"},[m(f.getComponent("Button"),{viewModel:vm.buttonDone()})]),m("div",{class:"fb-title"},[m("i",{class:"fa fa-wrench fb-title-icon"}),m("label",vm.title())]),m(f.getComponent("FormWidget"),{viewModel:vm.formWidget()})])}},f.catalog().register("components","settingsPage",settingsPage.component);const tableDialog={};let scrWidth,inner,widthNoScroll,widthWithScroll;tableDialog.viewModel=function(options){let vm,state,buttonAdd,buttonRemove,buttonClear,buttonDown,buttonUp;options=options||{};let selection=f.prop();return vm=f.createViewModel("Dialog",options),vm.add=function(){let ary=vm.data();vm.attrs().some(vm.addAttr.bind(ary)),vm.isSelected()||vm.selection(ary.length-1),buttonRemove.enable(),buttonClear.enable(),vm.scrollBottom(!0)},vm.addAttr=function(attr){if(!this.some(vm.hasAttr.bind(attr)))return this.push({property:attr}),!0},vm.buttonAdd=function(){return buttonAdd},vm.buttonClear=function(){return buttonClear},vm.buttonDown=function(){return buttonDown},vm.buttonRemove=function(){return buttonRemove},vm.buttonUp=function(){return buttonUp},vm.clear=function(){vm.data().length=0,buttonClear.disable()},vm.content=function(){let btn=f.getComponent("Button");return[m(btn,{viewModel:vm.buttonAdd()}),m(btn,{viewModel:vm.buttonRemove()}),m(btn,{viewModel:vm.buttonClear()}),m(btn,{viewModel:vm.buttonDown()}),m(btn,{viewModel:vm.buttonUp()}),m("table",{class:"pure-table"},[m("thead",{class:"fb-table-dialog-table-header"},vm.viewHeaders()),m("tbody",{id:"sortTbody",class:"fb-table-dialog-table-body",oncreate:function(vnode){let e=document.getElementById(vnode.dom.id);vm.scrollBottom()&&(e.scrollTop=e.scrollHeight),vm.scrollBottom(!1)}},vm.viewRows())])]},vm.data=function(){},vm.isSelected=function(){return state.resolve(state.resolve("/Selection").current()[0]).isSelected()},vm.itemChanged=function(index,property,value){vm.data()[index][property]=value},vm.items=function(){let i=0;return vm.data().map((function(item){let ret=f.copy(item);return ret.index=i,i+=1,ret}))},vm.hasAttr=function(item){return item.property===this},vm.list=f.prop(options.list),vm.moveDown=function(){let ary=vm.data(),idx=vm.selection(),a=ary[idx],b=ary[idx+1];ary.splice(idx,2,b,a),vm.selection(idx+1)},vm.moveUp=function(){let ary=vm.data(),idx=vm.selection()-1,a=ary[idx],b=ary[idx+1];ary.splice(idx,2,b,a),vm.selection(idx)},vm.remove=function(){let idx=selection(),ary=vm.data();if(ary.splice(idx,1),state.send("unselected"),ary.length)return idx>0&&(idx-=1),void selection(idx);buttonRemove.disable()},vm.reset=function(){},vm.resolveProperties=function(feather,properties,ary,prefix,norel){prefix=prefix||"";let result=ary||[];return properties.forEach((function(key){let rfeather,prop=feather.properties[key],isObject="object"==typeof prop.type,path=prefix+key;if(isObject&&prop.type.properties&&(rfeather=f.catalog().getFeather(prop.type.relation),vm.resolveProperties(rfeather,prop.type.properties,result,path+".",norel)),"money"===prop.format)path+=".amount";else if("object"===prop.type||isObject&&(prop.type.childOf||prop.type.parentOf||prop.type.isChild||norel))return;result.push(path)})),result},vm.rowColor=function(index){return vm.selection()===index?vm.isSelected()?"LightSkyBlue":"AliceBlue":"White"},vm.title=f.prop(options.title),vm.viewHeaderIds=f.prop(),vm.viewHeaders=function(){},vm.viewRows=function(){},vm.scrollBottom=f.prop(!1),vm.selection=function(...args){let ary=vm.data(),index=args[0];return args[1]&&state.send("selected"),args.length?(buttonUp.disable(),buttonDown.disable(),ary.length>1&&(index<ary.length-1&&buttonDown.enable(),index>0&&buttonUp.enable()),selection(index)):selection()},buttonAdd=f.createViewModel("Button",{onclick:vm.add,label:"Add",icon:"plus-circle",class:"fb-icon-button",style:{backgroundColor:"white"}}),buttonRemove=f.createViewModel("Button",{onclick:vm.remove,label:"Remove",icon:"trash",class:"fb-icon-button",style:{backgroundColor:"white"}}),buttonClear=f.createViewModel("Button",{onclick:vm.clear,title:"Clear",icon:"eraser",class:"fb-icon-button",style:{backgroundColor:"white"}}),buttonUp=f.createViewModel("Button",{onclick:vm.moveUp,icon:"chevron-up",title:"Move up",class:"fb-icon-button",style:{backgroundColor:"white",float:"right"}}),buttonDown=f.createViewModel("Button",{onclick:vm.moveDown,icon:"chevron-down",title:"Move down",class:"fb-icon-button",style:{backgroundColor:"white",float:"right"}}),state=f.State.define((function(){this.state("Selection",(function(){this.state("Off",(function(){this.event("selected",(function(){this.goto("../On")})),this.isSelected=function(){return!1}})),this.state("On",(function(){this.event("unselected",(function(){this.goto("../Off")})),this.isSelected=function(){return!0}}))}))})),state.goto(),vm.state().resolve("/Display/Showing").enter((function(){vm.reset()})),vm},f.catalog().register("viewModels","tableDialog",tableDialog.viewModel),tableDialog.component=f.getComponent("Dialog"),f.catalog().register("components","tableDialog",tableDialog.component);const tableWidget={},outer=document.createElement("div"),COL_WIDTH_DEFAULT="150",LIMIT=20,ROW_COUNT=2,FETCH_MAX=3;function handleStyle(style,tdOpts){style&&(style=f.getStyle(style),tdOpts.style.color=style.color,tdOpts.style.backgroundColor=style.backgroundColor,tdOpts.style.fontWeight=style.fontWeight,tdOpts.style.textDecoration=style.textDecoration)}function normalizeDataList(dataList,model){return dataList&&("string"==typeof dataList?dataList=model.data[dataList]():"object"!=typeof dataList[0]&&(dataList=dataList.map((function(item){return{value:item,label:item}})))),dataList}function createTableDataEditor(options,col){let cell,tdOpts,inputOpts,columnSpacerClass,theWidget,config=options.config,defaultFocusId=options.defaultFocusId,theModel=options.model,onshifttab=options.onshifttab,ontab=options.ontab,theVm=options.vm,zoom=options.zoom,prop=f.resolveProperty(theModel,col),theId=theVm.formatInputId(col),item=config.columns[options.idx],columnWidth=item.width||"150",theDataList=normalizeDataList(item.dataList||prop.dataList,theModel),cfilter=item.filter,style=prop.style?prop.style():"";return columnWidth-=6,inputOpts={id:theId,key:theId,onclick:theVm.toggleSelection.bind(this,theModel,theId),value:prop(),style:{minWidth:columnWidth+"px",maxWidth:columnWidth+"px",fontSize:zoom},isCell:!0,showCurrency:item.showCurrency},theVm.nextFocus()===theId&&theId===defaultFocusId?(inputOpts.oncreate=function(vnode){let e=document.getElementById(vnode.dom.id);e.addEventListener("keydown",onshifttab),e.focus()},inputOpts.onremove=function(vnode){let e=document.getElementById(vnode.dom.id);e&&e.removeEventListener("keydown",onshifttab)},theVm.nextFocus(void 0)):theVm.nextFocus()===theId&&theId!==defaultFocusId?(inputOpts.oncreate=function(vnode){document.getElementById(vnode.dom.id).focus()},theVm.nextFocus(void 0)):theId===defaultFocusId&&(inputOpts.oncreate=function(vnode){document.getElementById(vnode.dom.id).addEventListener("keydown",onshifttab)},inputOpts.onremove=function(vnode){let e=document.getElementById(vnode.dom.id);e&&e.removeEventListener("keydown",onshifttab)}),options.lastFocusId===theId&&(inputOpts.oncreate=function(vnode){document.getElementById(vnode.dom.id).addEventListener("keydown",ontab)},inputOpts.onremove=function(vnode){let e=document.getElementById(vnode.dom.id);e&&e.removeEventListener("keydown",ontab)}),tdOpts=prop.isRequired&&prop.isRequired()&&(null===prop()||void 0===prop())?{class:"fb-table-cell-edit fb-table-cell-edit-cell fb-table-cell-edit-required",style:{}}:{class:"fb-table-cell-edit fb-table-cell-edit-cell",style:{}},tdOpts.style.minWidth=columnWidth+"px",tdOpts.style.maxWidth=columnWidth+"px",tdOpts.style.fontSize=zoom,handleStyle(style,tdOpts),columnSpacerClass="fb-column-spacer "+tdOpts.class,theWidget=theVm.form().attrs.find((item=>item.attr===col&&item.relationWidget)),theWidget&&(theWidget=theWidget.relationWidget),cell=[m("td",tdOpts,[f.createEditor({model:theModel,key:col,dataList:theDataList,filter:cfilter,viewModel:theVm,options:inputOpts,widget:theWidget})]),m("td",{style:{fontSize:zoom},class:columnSpacerClass})],options.idx+=1,cell}function createTableDataView(options,col){let url,cell,content,tdOpts,tableData,relation,theVm=options.vm,model=options.model,config=options.config,zoom=options.zoom,onClick=options.onclick,theProp=f.resolveProperty(options.model,col),theValue=theProp(),format=theProp.format||theProp.type,columnWidth=config.columns[options.idx].width||"150",style=theProp.style?theProp.style():"",id=model.id()+"-"+options.idx,dataList=normalizeDataList(config.columns[options.idx].dataList||theProp.dataList,model),otitle=theProp.title?theProp.title():"";return columnWidth-=6,tdOpts={key:id+"-data",onclick:function(ev){let optKey;ev.shiftKey?optKey="shiftKey":ev.ctrlKey&&(optKey="ctrlKey"),theVm.toggleSelection(model,theVm.formatInputId(col),optKey)},class:"fb-cell-view",style:{minWidth:columnWidth+"px",maxWidth:columnWidth+"px",fontSize:zoom}},handleStyle(style,tdOpts),"object"==typeof format&&theProp()?(relation=theProp.type.relation.toCamelCase(),tableData=f.types[relation]&&f.types[relation].tableData?f.types[relation].tableData:function(){let rel,keys;if(rel=f.catalog().getFeather(format.relation),keys=Object.keys(rel.properties),rel=keys.find((key=>rel.properties[key].isNaturalKey))||keys.find((key=>rel.properties[key].isLabelKey)),rel)return theValue=theProp().data[rel](),url=window.location.protocol+"//"+window.location.hostname+":"+window.location.port+"#!/edit/"+theProp.type.relation.toSnakeCase()+"/"+theProp().id(),m("a",{href:url,onclick:function(e){theVm.canToggle(!1),e.preventDefault(),m.route.set("/edit/:feather/:key",{feather:theProp.type.relation.toSnakeCase(),key:theProp().id()},{state:{}})}},theValue)}):tableData=theProp.format&&f.formats()[theProp.format].tableData?f.formats()[theProp.format].tableData:f.types[theProp.type]&&f.types[theProp.type].tableData?f.types[theProp.type].tableData:obj=>obj.value,dataList&&(theValue=dataList.find((i=>i.value===theValue))||{},theValue=theValue.label),content=tableData({value:theValue,options:tdOpts,viewModel:theVm,prop:theProp,onclick:onClick,title:otitle}),cell=[m("td",tdOpts,content),m("td",{key:id+"-spcr",class:"fb-column-spacer",style:{fontSize:zoom}})],options.idx+=1,cell}function resolveDescription(feather,attr){let prefix,suffix,idx=attr.indexOf(".");return idx>-1?(prefix=attr.slice(0,idx),suffix=attr.slice(idx+1,attr.length),resolveDescription(feather=f.catalog().getFeather(feather.properties[prefix].type.relation),suffix)):feather.properties[attr]?feather.properties[attr].description:"Unknown attribute '"+attr+"'"}function createTableHeader(options,col){let hview,order,name,fidx,config=options.config,filter=options.filter,vm=options.vm,sort=options.sort,zoom=options.zoom,key=col.attr,icon=[],operators=f.operators,columnWidth=config.columns[options.idx].width||"150";function findFilterIndex(col,name){let hasCol,ary=filter[name=name||"criteria"]||[],i=0;return hasCol=function(item){if(item.property===col)return!0;i+=1},!!ary.some(hasCol)&&i}return fidx=findFilterIndex(key,"sort"),columnWidth-=6,!1!==fidx&&(order=sort[fidx].order||"ASC",name="ASC"===order.toUpperCase()?"fa fa-sort-up":"fa fa-sort-down",icon.push(m("i",{class:name+" fb-column-sort-icon",style:{fontSize:zoom}})),sort.length>1&&icon.push(m("span",{class:"fb-column-sort-number",style:{fontSize:.6*vm.zoom()+"%"}},fidx+1))),fidx=findFilterIndex(key),!1!==fidx&&icon.push(m("i",{class:"fa fa-filter fb-column-filter-icon",title:operators[filter.criteria[fidx].operator||"="]+" "+filter.criteria[fidx].value,style:{fontSize:.8*vm.zoom()+"%"}})),hview=[m("th",{ondragover:vm.ondragover,draggable:!0,ondragstart:vm.ondragstart.bind(null,options.idx,"column"),ondrop:vm.ondrop.bind(null,options.idx,"column",config.columns),class:"fb-column-header",style:{minWidth:columnWidth+"px",maxWidth:columnWidth+"px",fontSize:zoom},title:resolveDescription(options.feather,key)},icon,col.label||vm.alias(key)),m("th",{ondragover:vm.ondragover,draggable:!0,ondragstart:vm.ondragstart.bind(null,options.idx,"width"),class:"fb-column-spacer fb-column-header-grabber",style:{fontSize:zoom}})],options.idx+=1,hview}function createTableRow(options,pModel){let tds,row,thContent,onClick,lock,iconStyle,theLastFocusId,onTab,onShifttab,rowClass,style,theConfig=options.config,theVm=options.vm,theZoom=options.zoom,theDefaultFocusId=theVm.defaultFocus(pModel),currentMode=theVm.mode().current()[0],isSelected=theVm.isSelected(pModel),currentState=pModel.state().current()[0],data=pModel.data,rowOpts={key:pModel.id()},cellOpts={};return isSelected&&(rowClass=theVm.selectedClass()),"/Mode/View"!==currentMode&&isSelected?(cellOpts={class:"fb-table-cell-edit"},theLastFocusId=theVm.lastFocus(pModel),onTab=function(e){"Tab"!==(e.key||e.keyIdentifier)||e.shiftKey||(e.preventDefault(),document.getElementById(theDefaultFocusId).focus())},onShifttab=function(e){"Tab"===(e.key||e.keyIdentifier)&&e.shiftKey&&(e.preventDefault(),document.getElementById(theLastFocusId).focus())},tds=theVm.attrs().map(createTableDataEditor.bind(null,{config:theConfig,defaultFocusId:theDefaultFocusId,idx:0,lastFocusId:theLastFocusId,model:pModel,onshifttab:onShifttab,ontab:onTab,vm:theVm,zoom:theZoom}))):(tds=theVm.attrs().map(createTableDataView.bind(null,{config:theConfig,d:data,idx:0,model:pModel,onclick:onClick,vm:theVm,zoom:theZoom})),rowOpts={ondblclick:theVm.ondblclick.bind(null,pModel)},style=pModel.style(),style&&(style=f.getStyle(style),rowOpts.style={color:style.color,fontWeight:style.fontWeight,textDecoration:style.textDecoration},isSelected||(rowOpts.style.backgroundColor=style.backgroundColor))),onClick=function(ev){let optKey;ev.shiftKey?optKey="shiftKey":ev.ctrlKey&&(optKey="ctrlKey"),theVm.toggleSelection(pModel,theDefaultFocusId,optKey)},iconStyle={fontSize:theZoom,minWidth:"25px"},"/Mode/Edit"!==currentMode&&isSelected?thContent=m("i",{onclick:theVm.ondblclick.bind(null,pModel),class:"fa fa-folder-open fb-icon-button",style:iconStyle}):pModel.isValid()?"/Locked"===currentState?(lock=data.lock()||{},thContent=m("i",{onclick:onClick,title:"User: "+lock.username+"\nSince: "+new Date(lock.created).toLocaleTimeString(),class:"fa fa-user-lock",style:iconStyle})):"/Delete"===currentState?thContent=m("i",{onclick:onClick,class:"fa fa-trash",style:iconStyle}):"/Ready/New"===currentState?thContent=m("i",{onclick:onClick,class:"fa fa-plus",style:iconStyle}):pModel.canUndo()?thContent=m("i",{onclick:onClick,class:"fa fa-pencil-alt",style:iconStyle}):(cellOpts={onclick:onClick,style:iconStyle},"/Mode/Edit"===currentMode&&isSelected&&(cellOpts.class="fb-table-cell-edit fb-table-cell-edit-header")):thContent=m("i",{onclick:onClick,title:pModel.lastError(),class:"fa fa-exclamation-triangle",style:iconStyle}),tds.unshift(m("th",cellOpts,thContent)),rowOpts.class=rowClass,rowOpts.key=pModel.id(),row=data.isDeleted()?m("del",{key:f.createId()},m("tr",rowOpts,tds)):m("tr",rowOpts,tds),options.idx+=1,row}function resolveFeatherProp(feather,attr){let prefix,suffix,idx=attr.indexOf(".");return idx>-1?(prefix=attr.slice(0,idx),"money"===feather.properties[prefix].format?feather.properties[prefix]:(suffix=attr.slice(idx+1,attr.length),resolveFeatherProp(feather=f.catalog().getFeather(feather.properties[prefix].type.relation),suffix))):feather.properties[attr]}function createTableFooter(options,col){let fview,theValue,tableData,config=options.config,vm=options.vm,values=vm.aggregateValues()||{},zoom=options.zoom,columnWidth=config.columns[options.idx].width||"150",prop=resolveFeatherProp(options.feather,col.attr),agg=vm.aggregates().find((a=>a.property===col.attr)),content="",attr=col.attr;return!prop||"money"!==prop.format||agg&&"COUNT"===agg.method||(attr+=".amount"),theValue=void 0!==values[attr]&&null!==values[attr]?values[attr]:"",""!==theValue&&(tableData=agg&&"COUNT"===agg.method?f.types.integer.tableData:"date"===prop.format?f.formats().date.tableData:"dateTime"===prop.format?f.formats().dateTime.tableData:"string"===prop.type?f.types.string.tableData:"money"===prop.format?f.formats().money.tableData:f.types.number.tableData,content=tableData({options:{title:"",style:{}},value:theValue})),columnWidth-=6,fview=[m("th",{class:"fb-column-footer",style:{minWidth:columnWidth+"px",maxWidth:columnWidth+"px",fontSize:zoom}},content),m("th",{class:"fb-column-spacer fb-column-header-grabber fb-column-footer",style:{fontSize:zoom}})],options.idx+=1,fview}function resize(vm,vnode){let pageFooter,yPosition,e=document.getElementById(vnode.dom.id),id=vm.footerId(),height=vm.height(),tableFooter=document.getElementById(vm.ids().footer),tfootHeight=tableFooter?tableFooter.offsetHeight+1:0;height?e.style.height=height:id?(pageFooter=document.getElementById(id),e.style.height=window.innerHeight-f.getElementPosition(e.parentElement).y-e.offsetTop-pageFooter.offsetHeight-tfootHeight-1+"px"):(yPosition=f.getElementPosition(e.offsetParent).y,height=window.innerHeight-yPosition-82,height<150&&(height=150),e.style.height=height+"px")}outer.style.visibility="hidden",outer.style.width="100px",outer.style.msOverflowStyle="scrollbar",document.body.appendChild(outer),widthNoScroll=outer.offsetWidth,outer.style.overflow="scroll",inner=document.createElement("div"),inner.style.width="100%",outer.appendChild(inner),widthWithScroll=inner.offsetWidth,outer.parentNode.removeChild(outer),scrWidth=widthNoScroll-widthWithScroll,tableWidget.viewModel=function(options){let fromWidthIdx,dataTransfer,feather="object"==typeof(options=options||{}).feather?options.feather:f.catalog().getFeather(options.feather),modelName=feather.name.toCamelCase(),modelConstructor=f.catalog().store().models()[modelName],offset=0,dlgSelectId=f.createId(),dlgSelectedId=f.createId(),dlgVisibleId=f.createId(),vm={},isEditModeEnabled=f.prop(!1!==options.isEditModeEnabled),fetchCount=0;function doDownload(target,source){let element=document.createElement("a");element.setAttribute("href",source+"/"+target),element.setAttribute("download",source),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}function doImport(){let input=document.createElement("input"),dlg=vm.confirmDialog();function callback(resp){let target="error_log_"+f.now()+".json";resp&&(dlg.message("One or more errors were encountered during import. Would you like to download the log?"),dlg.title("Error"),dlg.icon("window-close"),dlg.onOk(doDownload.bind(null,target,resp)),dlg.show()),vm.refresh()}function error(err){null!==err.response&&(dlg.message(err.message),dlg.title("Error"),dlg.icon("window-close"),dlg.buttonCancel().hide(),dlg.show())}input.setAttribute("type","file"),input.setAttribute("accept",".json,.ods,.xlsx"),input.onchange=function(){let payload,file=input.files[0],formData=new FormData,format=file.name.slice(file.name.indexOf(".")+1,file.name.length),name=file.name.slice(0,file.name.indexOf(".")),feathers=f.catalog().feathers();-1!==name.indexOf(" ")&&(name=name.slice(0,name.indexOf(" "))),"ods"===format||"json"===format||"xlsx"===format?Object.keys(feathers).some((key=>feathers[key].plural===name))?(formData.append("import",file),payload={method:"POST",path:"/do/import/"+format+"/"+name,body:formData},f.datasource().request(payload).then(callback).catch(error)):error(new Error('Unrecognized data type name "'+name+'"')):error(new Error('Unrecognized file format "'+format+'"'))},input.click()}function getFilter(offset){let criterion,fattrs=[],theValue=vm.search(),filter=f.copy(vm.filter());function formatOf(feather,property){let prefix,suffix,rel,prop,idx=property.indexOf(".");return idx>-1?(prefix=property.slice(0,idx),suffix=property.slice(idx+1,property.length),rel=feather.properties[prefix].type.relation,formatOf(f.catalog().getFeather(rel),suffix)):(prop=feather.properties[property],prop.format||prop.type)}return filter.offset=offset||0,filter.limit=20,theValue&&(vm.attrs().forEach((function(attr){let nk,props,theFeather=vm.feather(),fmt=formatOf(theFeather,attr),p=resolveFeatherProp(theFeather,attr);p.isCalculated||("string"===p.type&&"date"!==fmt&&"dateTime"!==fmt?fattrs.push(attr):"object"!=typeof fmt||fmt.childOf||(props=f.catalog().getFeather(fmt.relation).properties,nk=Object.keys(props).find((key=>props[key].isNaturalKey)),nk&&fattrs.push(attr+"."+nk)))})),fattrs.length&&(criterion={property:fattrs,operator:"~*",value:theValue},filter.criteria=filter.criteria||[],filter.criteria.push(criterion))),filter}function doExport(){let dlg=vm.confirmDialog(),isOnlyVisible=f.prop(!0),isOnlySelected=f.prop(!1),format=f.prop("xlsx"),chkbox=f.getComponent("Checkbox");function error(err){dlg.message(err.message),dlg.title("Error"),dlg.icon("window-close"),dlg.buttonCancel().hide(),dlg.show()}dlg.content=function(){return m("div",{class:"pure-form pure-form-aligned"},[m("div",{class:"pure-control-group"},[m("label",{for:dlgSelectId},"Format:"),m("select",{id:dlgSelectId,onchange:e=>format(e.target.value),value:format()},[m("option",{value:"xlsx"},"Excel 2007+ XML Format (xlsx)"),m("option",{value:"ods"},"Open Document Spreadsheet (ods)"),m("option",{value:"json"},"JavaScript Object Notation (json)")])]),m("div",{class:"pure-control-group"},[m("label",{for:dlgSelectedId},"Only selected rows:"),m(chkbox,{onclick:function(value){isOnlySelected(value)},value:isOnlySelected(),readonly:0===vm.selections().length,title:0===vm.selections().length?"No selections to export":""})]),m("div",{class:"pure-control-group"},[m("label",{for:dlgVisibleId},"Only visible columns:"),m(chkbox,{onclick:function(value){isOnlyVisible(value)},value:isOnlyVisible()})])])},dlg.title("Export data"),dlg.icon("file-export"),dlg.onOk((function(){let theUrl,payload,theBody={},fspec=vm.feather(),plural=fspec.plural||fspec.name;return isOnlyVisible()&&(theBody.properties=vm.config().columns.map((col=>col.attr)),theBody.properties=theBody.properties.filter((function(p){return-1!==p.indexOf(".")||!fspec.properties[p].isCalculated}))),theBody.filter=getFilter(),delete theBody.filter.limit,isOnlySelected()&&(theBody.filter.criteria=[{property:"id",operator:"IN",value:vm.selections().map((item=>item.id()))}]),theUrl="/do/export/"+format()+"/"+plural,payload={method:"POST",url:theUrl,body:theBody},m.request(payload).then(doDownload.bind(null,plural+"."+format())).catch(error)})),dlg.style({width:"550px"}),dlg.show()}function setProperties(){let attrs,list=vm.models(),props=[],fp=vm.feather().properties;vm.isEditModeEnabled()?list.properties(void 0):(attrs=vm.config().columns.map((col=>col.attr)),attrs.forEach((function(a){let i=a.indexOf(".");-1!==i&&(a=a.slice(0,i)),-1===props.indexOf(a)&&props.push(a)})),props=props.filter((p=>fp[p]&&!fp[p].isCalculated)),-1===props.indexOf("id")&&props.unshift("id"),list.properties(props))}function doFetchAggregates(){let theUrl,payload,aggregates=vm.aggregates(),theBody={name:vm.feather().name,aggregations:aggregates,filter:f.copy(getFilter())};if(theBody.aggregations.length)return delete theBody.filter.limit,delete theBody.filter.sort,delete theBody.filter.offset,theUrl="/do/aggregate",payload={method:"POST",url:"/do/aggregate",body:theBody},m.request(payload).then((function(resp){let keys,aggs={},i=0,props=aggregates.map((a=>a.property)),values=resp.result;null!==values?("number"==typeof values&&(values={f1:values}),keys=Object.keys(values),props.forEach((function(p){let val=values[keys[i]]||0;"money"===resolveFeatherProp(vm.feather(),p).format&&"COUNT"!==aggregates[i].method&&(val=f.money(val)),aggs[p]=val,i+=1})),vm.aggregateValues(aggs)):vm.aggregateValues({})}))}function doFetch(refresh){refresh&&(doFetchAggregates(),offset=0,fetchCount=0),fetchCount+=1,setProperties(),vm.models().fetch(getFilter(offset),!0!==refresh).then((function(){fetchCount<3&&(offset+=20,doFetch())}))}function selectionChanged(){vm.state().send("changed")}function selectionFetched(){vm.state().send("fetched")}return options.config.aggregates=options.config.aggregates||[],vm.actions=function(){let menu,o,actions=options.actions||[],selections=vm.selections();return menu=actions.map((function(action){let opts,actionIcon,method=modelConstructor.static()[action.method],validator=modelConstructor.static()[action.validator];return method||(method=function(viewModel){let dialog=viewModel.confirmDialog();dialog.message('No method "'+action.method+'" found on model "'+modelName+'"'),dialog.title("Error"),dialog.icon("exclamation-triangle"),dialog.onOk(void 0),dialog.buttonCancel().hide(),dialog.show()}),action.id=action.id||f.createId(),opts={id:"nav-actions-"+action.id,class:"pure-menu-link",title:action.title},validator&&!validator(selections)?opts.class="pure-menu-link pure-menu-disabled":opts.onclick=method.bind(null,vm),action.hasSeparator&&(opts.class+=" fb-menu-list-separator"),action.icon&&(actionIcon=[m("i",{id:"nav-actions-"+action.id+"-icon",class:"fa fa-"+action.icon+" fb-menu-list-icon"})]),m("li",opts,actionIcon,action.name)})),o={id:"nav-actions-import",class:"pure-menu-link",title:"Import data",onclick:doImport},menu.length&&(o.class+=" fb-menu-list-separator"),menu.push(m("li",o,[m("i",{id:"nav-actions-import-icon",class:"fa fa-file-import fb-menu-list-icon"})],"Import")),menu.push(m("li",{id:"nav-actions-export",class:"pure-menu-link",title:"Export data",onclick:doExport},[m("i",{id:"nav-actions-export-icon",class:"fa fa-file-export fb-menu-list-icon"})],"Export")),menu},vm.aggregates=function(ary){return ary&&(options.config.aggregates.length=0,ary.forEach((i=>options.config.aggregates.push(i)))),options.config.aggregates},vm.alias=function(attr){return f.resolveAlias(vm.feather(),attr)},vm.attrs=function(){return vm.config().columns.map((function(column){return column.attr}))||[{attr:"id"}]},vm.canToggle=f.prop(!0),vm.class=f.prop(options.class||""),vm.isEditModeEnabled=function(...args){let enable=args[0];return!1===enable&&vm.toggleView(),void 0!==enable&&vm.models().isEditable(enable),isEditModeEnabled(...args)},vm.isQuery=f.prop(!0),vm.config=f.prop(options.config),vm.footerId=f.prop(options.footerId),vm.confirmDialog=f.prop(f.createViewModel("Dialog",{icon:"question-circle",title:"Confirmation"})),vm.confirmDialog().state().resolve("/Display/Closed").enter((function(){let dlg=vm.confirmDialog();dlg.icon("question-circle"),dlg.title("Confirmation"),dlg.buttonOk().show(),dlg.buttonCancel().show(),dlg.buttonCancel().isPrimary(!1),dlg.onOk(void 0),dlg.onCancel(void 0),dlg.content=function(){return m("div",{id:dlg.ids().content},dlg.message())},dlg.buttons([dlg.buttonOk,dlg.buttonCancel]),dlg.buttonOk().label("&Ok"),dlg.buttonCancel().label("&Cancel"),dlg.style({width:"450px"})})),vm.defaultFocus=function(model){let col=vm.attrs().find((function(attr){return!model.data[attr]||!model.data[attr].isReadOnly()}));return col?vm.formatInputId(col):void 0},vm.errorDialog=f.prop(f.createViewModel("Dialog",{icon:"exclamation-triangle",title:"Error"})),vm.feather=f.prop(feather),vm.filter=f.prop(),vm.form=function(){return f.getForm({form:vm.config().form,feather:feather.name})},vm.formatInputId=function(col){return"input"+col.toCamelCase(!0)},vm.height=f.prop(options.height),vm.goNextRow=function(){let list=vm.models(),ids=list.map((function(model){return model.id()})),model=vm.model(),idx=model?ids.indexOf(model.id())+1:0;list.length>idx&&vm.select(list[idx])},vm.goPrevRow=function(){let list=vm.models(),model=vm.model(),idx=list.indexOf(model)-1;idx>=0&&vm.select(list[idx])},vm.ids=f.prop({header:f.createId(),rows:f.createId(),footer:f.createId()}),vm.isDragging=f.prop(!1),vm.isScrolling=f.prop(!1),vm.isSelected=function(model){return vm.selectionIds().indexOf(model.id())>-1},vm.lastFocus=function(model){let col;return col=vm.attrs().slice().reverse().find((function(attr){return model.data[attr]&&!model.data[attr].isReadOnly()})),col?vm.formatInputId(col):void 0},vm.lastSelected=f.prop(),vm.mode=function(){let state=vm.state();return state.resolve(state.current()[0])},vm.model=function(){return vm.selection()},vm.modelDelete=function(){return vm.mode().modelDelete()},vm.modelNew=function(){return vm.mode().modelNew()},vm.models=f.prop(options.models),vm.nextFocus=f.prop(),vm.ondblclick=function(model){vm.select(model),options.ondblclick&&options.ondblclick()},vm.ondragover=function(ev){ev.preventDefault()},vm.ondragstart=function(idx,type,ev){switch(vm.isDragging(!0),dataTransfer={},dataTransfer.typeStart=type,type){case"width":return fromWidthIdx=idx,void(dataTransfer.widthStart=ev.clientX)}dataTransfer[type]=idx},vm.ondrop=function(toIdx,type,ary,ev){let moved,column,fromIdx,oldWidth,newWidth,widthStart,typeStart=dataTransfer.typeStart;switch(ev.preventDefault(),typeStart){case"width":fromWidthIdx<=toIdx&&(widthStart=dataTransfer.widthStart-0,column=vm.config().columns[fromWidthIdx],oldWidth=column.width||"150",newWidth=oldWidth-(widthStart-ev.clientX),column.width=newWidth);break;default:fromIdx=dataTransfer[type]-0,fromIdx!==toIdx&&(moved=ary.splice(fromIdx,1)[0],ary.splice(toIdx,0,moved))}vm.isDragging(!1)},vm.onkeydown=function(e){let id;function nav(name){id=e.target.id,document.getElementById(id).blur(),vm[name](),m.redraw.sync(),document.getElementById(id).focus()}switch(e.key||e.keyIdentifier){case"Up":case"ArrowUp":nav("goPrevRow"),e.preventDefault(),e.stopPropagation();break;case"Down":case"ArrowDown":nav("goNextRow"),e.preventDefault(),e.stopPropagation()}},vm.onscroll=function(evt){let ids=vm.ids(),e=evt.srcElement,remainScroll=e.scrollHeight-e.clientHeight-e.scrollTop,childHeight=e.lastChild.clientHeight,header=document.getElementById(ids.header),rows=document.getElementById(ids.rows);if(vm.isQuery()&&remainScroll<2*childHeight&&vm.models().length>=offset)return offset+=20,void doFetch();header.scrollLeft=rows.scrollLeft,vm.isScrolling(!0)},vm.onscrollFooter=function(){let ids=vm.ids(),rows=document.getElementById(ids.rows),footer=document.getElementById(ids.footer);rows.scrollLeft=footer.scrollLeft,vm.isScrolling(!0)},vm.refresh=function(){doFetch(!0)},vm.relations=f.prop({}),vm.selectComponents=f.prop({}),vm.save=function(){vm.models().save()},vm.scrollbarWidth=f.prop(scrWidth),vm.search=options.search||f.prop(""),vm.select=function(models){let state,selections=vm.selections(),ids=vm.selectionIds();return Array.isArray(models)||(1===selections.length&&void 0!==models&&selections[0].id()===models.id()||(vm.unselect(selections),ids=[]),models=void 0===models?[]:[models]),models.forEach((function(model){-1===ids.indexOf(model.id())&&(state=model.state().resolve("/Ready/Fetched/Dirty"),state.enter(selectionChanged),state=model.state().resolve("/Delete"),state.enter(selectionChanged),state=model.state().resolve("/Ready/Fetched/Clean"),state.enter(selectionFetched),model.parent()||model.checkDelete(),selections.push(model))})),vm.relations({}),selections.length&&vm.state().send("selected"),selections},vm.selection=function(){return vm.selections()[0]},vm.selectionIds=function(){return vm.selections().map((function(selection){return selection.id()}))},vm.selections=f.prop([]),vm.selectedClass=function(){return vm.mode().selectedClass()},vm.state=f.prop(),vm.toggleEdit=function(){vm.state().send("edit")},vm.toggleView=function(){vm.state().send("view")},vm.toggleMode=function(){vm.state().send("toggle")},vm.toggleSelection=function(model,id,optKey){if(vm.canToggle())return vm.mode().toggleSelection(model,id,optKey)},vm.undo=function(){let selection=vm.selection();selection&&selection.undo()},vm.unselect=function(models){let idx,state,ids=[],selections=vm.selections(),remaining=[];models&&(Array.isArray(models)?ids=models.map((function(model){return model.id()})):(ids=[models.id()],models=[models])),(models=models?selections.filter((function(selection){let isClearing=ids.some((function(id){return selection.id()===id}));return isClearing||remaining.push(selection),isClearing})):selections.map((function(selection){return selection}))).forEach((function(selection){state=selection.state().resolve("/Ready/Fetched/Dirty"),idx=state.enters.indexOf(selectionChanged),state.enters.splice(idx,1),state=selection.state().resolve("/Delete"),idx=state.enters.indexOf(selectionChanged),state.enters.splice(idx,1),state=selection.state().resolve("/Ready/Fetched/Clean"),idx=state.enters.indexOf(selectionFetched),state.enters.splice(idx,1)})),selections.length=0,remaining.length?remaining.forEach((function(model){selections.push(model)})):vm.state().send("unselected")},vm.zoom=f.prop(100),vm.filter(f.copy(options.config.filter||{})),vm.aggregates(f.copy(options.config.aggregates)),vm.aggregateValues=f.prop(),vm.filter().limit=vm.filter().limit||20,options.models||(vm.models(f.createList(feather.name,{fetch:!1,subscribe:options.subscribe,isEditable:vm.isEditModeEnabled(),filter:vm.filter()})),setProperties(),doFetch(),doFetchAggregates()),vm.filter.state().resolve("/Ready").enter((function(){vm.config().filter=vm.filter(),vm.refresh()})),vm.state(f.State.define({concurrent:!0},(function(){this.state("Mode",(function(){this.state("View",(function(){this.event("edit",(function(){vm.isEditModeEnabled()&&this.goto("../Edit")})),this.event("toggle",(function(){vm.isEditModeEnabled()&&this.goto("../Edit")})),this.modelDelete=function(){let confirmDialog=vm.confirmDialog();confirmDialog.message("Are you sure you want to delete the selected rows?"),confirmDialog.onOk((function(){vm.selections().filter((function(selection){return selection.canDelete()})).forEach((function(selection){return selection.delete(!0).then((function(){vm.unselect(selection),vm.models().remove(selection)})).catch((function(err){vm.errorDialog().message(err.message),m.redraw(),vm.errorDialog().show()}))}))})),confirmDialog.show()},this.modelNew=f.prop(!1),this.selectedClass=function(){return"fb-table-row-selected"},this.toggleSelection=function(model,id,optKey){let startIdx,endIdx,lastIdx,currentIdx,i,models,modelIds,adds,isSelected=vm.isSelected(model);switch(optKey){case"ctrlKey":if(isSelected)return vm.unselect(model),void vm.lastSelected(void 0);vm.select([model]),vm.lastSelected(model);break;case"shiftKey":for(document.getSelection().removeAllRanges(),adds=[],models=vm.models(),modelIds=vm.models().map((function(item){return item.id()})),lastIdx=Math.max(modelIds.indexOf(vm.lastSelected().id()),0),currentIdx=modelIds.indexOf(model.id()),currentIdx>lastIdx?(startIdx=lastIdx,endIdx=currentIdx):(startIdx=currentIdx,endIdx=lastIdx),i=startIdx;i<=endIdx;i+=1)adds.push(models[i]);vm.select(adds),vm.lastSelected(model);break;default:vm.unselect(),isSelected||(vm.select(model),vm.lastSelected(model))}return vm.nextFocus(id),!0}})),this.state("Edit",(function(){this.enter((function(){let last;vm.selections().length>1&&(last=vm.lastSelected(),vm.unselect(),vm.select(last))})),this.event("view",(function(){this.goto("../View")})),this.event("toggle",(function(){this.goto("../View")})),this.modelDelete=function(){let selection=vm.selection(),prevState=selection.state().current()[0];selection.delete(),("/Ready/New"===prevState||options.containerId)&&vm.models().remove(selection)},this.modelNew=function(){let name=vm.feather().name,model=f.createModel(name),input=vm.defaultFocus(model);return vm.models().add(model),vm.nextFocus(input),vm.select(model),!0},this.selectedClass=function(){return"fb-table-row-editor"},this.toggleSelection=function(model,id){return vm.select(model),vm.lastSelected(model),vm.nextFocus(id),!0}}))})),this.state("Selection",(function(){this.event("selected",(function(){this.goto("./On",{force:!0})})),this.state("Off"),this.state("On",(function(){this.event("unselected",(function(){this.goto("../Off")})),this.c=this.C,this.c((function(){return vm.selection().canUndo()?"./Dirty":"./Clean"})),this.state("Clean",(function(){this.event("changed",(function(){this.goto("../Dirty")}))})),this.state("Dirty",(function(){this.event("fetched",(function(){this.goto("../Clean")}))}))}))}))}))),vm.state().goto(),vm},f.catalog().register("viewModels","tableWidget",tableWidget.viewModel),tableWidget.component={oninit:function(vnode){vnode.attrs.viewModel.canToggle(!0)},onbeforeupdate:function(vnode){let vm=vnode.attrs.viewModel,isDragging=vm.isDragging(),isScrolling=vm.isScrolling();if(isScrolling&&vm.isScrolling(!1),isDragging||isScrolling)return!1},view:function(vnode){let header,rows,footer,theVm=vnode.attrs.viewModel,ids=theVm.ids(),theConfig=theVm.config(),theFilter=theVm.filter(),theSort=theFilter.sort||[],theZoom=theVm.zoom()+"%",theFeather=theVm.feather(),dlg=f.getComponent("Dialog"),aggs=theVm.aggregates(),tableBodyClass="fb-table-body";return header=function(){let ths=theConfig.columns.map(createTableHeader.bind(null,{config:theConfig,feather:theFeather,filter:theFilter,idx:0,sort:theSort,vm:theVm,zoom:theZoom}));return ths.unshift(m("th",{style:{minWidth:"25px",fontSize:theZoom}})),ths.push(m("th",{ondragover:theVm.ondragover,draggable:!0,ondrop:theVm.ondrop.bind(null,theConfig.columns.length,"column",theConfig.columns),style:{minWidth:theVm.scrollbarWidth()+"px",maxWidth:theVm.scrollbarWidth()+"px"}})),m("tr",ths)}(),rows=theVm.models().map(createTableRow.bind(null,{config:theConfig,idx:0,vm:theVm,zoom:theZoom})),rows.length||rows.push(m("tr",{style:{height:"50px"}})),aggs.length&&(tableBodyClass+=" fb-table-body-with-footer",footer=function(){let tfs=theConfig.columns.map(createTableFooter.bind(null,{config:theConfig,feather:theFeather,idx:0,vm:theVm,zoom:theZoom}));return tfs.unshift(m("th",{class:"fb-column-footer",style:{minWidth:"25px",fontSize:theZoom,color:"White"}},"-")),m("tfoot",tfs)}(),footer=m("tfoot",{id:ids.footer,onscroll:theVm.onscrollFooter,class:"fb-table-footer"},[footer])),m("div",{class:"pure-form "+theVm.class()},[m(dlg,{viewModel:theVm.confirmDialog()}),m(dlg,{viewModel:theVm.errorDialog()}),m("table",{class:"pure-table fb-table"},[m("thead",{ondragover:theVm.ondragover,draggable:!0,id:ids.header,class:"fb-table-header"},[header]),m("tbody",{id:ids.rows,class:tableBodyClass,onscroll:theVm.onscroll,oncreate:function(vnode){document.getElementById(vnode.dom.id).addEventListener("keydown",theVm.onkeydown),resize(theVm,vnode)},onupdate:resize.bind(null,theVm),onremove:function(vnode){let e=document.getElementById(vnode.dom.id);e&&e.removeEventListener("keydown",theVm.onkeydown)}},rows),footer])])}},f.catalog().register("components","tableWidget",tableWidget.component);const urlWidget={viewModel:function(options){let vm={};return vm.buttonOpen=f.prop(),vm.doOpen=function(){let url="http://"+options.parentViewModel.model().data[options.parentProperty]();window.open(url)},vm.id=f.prop(options.id||f.createId()),vm.key=f.prop(options.key||f.createId()),vm.style=f.prop(options.style||{}),vm.buttonOpen(f.createViewModel("Button",{onclick:vm.doOpen,title:"Open link in new browser tab",icon:"external-link-alt",class:"fb-data-type-edit-button"})),vm}};urlWidget.component={oninit:function(vnode){let options=vnode.attrs;this.viewModel=urlWidget.viewModel({parentViewModel:options.parentViewModel,parentProperty:options.parentProperty,id:options.id,key:options.key,style:options.style})},view:function(vnode){let ret,options=vnode.attrs,vm=this.viewModel,theStyle=vm.style(),prop=options.prop,opts={readonly:options.readonly,id:vm.id(),required:options.required,type:"url",onchange:e=>prop(e.target.value),oncreate:options.onCreate,onremove:options.onRemove,value:prop()};return opts.class?opts.class="fb-input "+opts.class:opts.class="fb-input",theStyle.display=theStyle.display||"inline-block",ret=m("div",{style:theStyle,key:vm.key()},[m("input",opts),m(f.getComponent("Button"),{viewModel:vm.buttonOpen()})]),ret}},f.catalog().register("components","urlWidget",urlWidget.component);const Gantt=window.Gantt,gantt={viewModel:function(options){let vm={};return vm.chart=f.prop(),vm.id=f.prop(options.id||f.createId()),vm.showDetail=f.prop(!0),vm.showLinks=f.prop(!0),vm.viewMode=f.prop("week"),vm}};gantt.component={oninit:function(vnode){this.viewModel=gantt.viewModel(vnode.attrs),this.viewModel.data=vnode.attrs.parentViewModel.model().data[vnode.attrs.parentProperty]},onupdate:function(){let vm=this.viewModel,id="gantt"+vm.id(),e=document.getElementById(id),chart=vm.chart(),data=vm.data().slice();vm.showDetail()||(data=data.filter((d=>Boolean(d.type)))),chart?(chart.options.viewMode=vm.viewMode(),chart.options.showLinks=vm.showLinks(),chart.data=data,chart.render()):data.length&&!chart&&(chart=new Gantt.SVGGantt(e,data,{viewMode:vm.viewMode(),showLinks:vm.showLinks(),onClick:function(item){item.feather&&item.key&&m.route.set("/edit/:feather/:key",{feather:item.feather,key:item.key},{})}}),this.viewModel.chart(chart),chart.render())},view:function(){let vm=this.viewModel,id=vm.id(),cb=f.getComponent("checkbox");return m("div",{id:"gantt-cont"+id,key:"gantt-cont"+id},[m("div",{id:"gantt-sel-div"+id,key:"gant-sel-div"+id,style:{paddingBottom:"20px"}},[m("label",{id:"gantt-sel-label"+id,key:"gantt-sel-label"+id,for:"gantt-sel"},"View mode:"),m("select",{id:"gantt-sel"+id,key:"gantt-sel"+id,value:vm.viewMode(),onchange:e=>vm.viewMode(e.target.value)},[m("option",{value:"day",label:"Day"}),m("option",{value:"week",label:"Week"}),m("option",{value:"month",label:"Month"})],"week"),m("label",{id:"gantt-detail-lb"+id,key:"gantt-detail-lb"+id,for:"gantt-detail-cb"+id},"Show detail"),m(cb,{id:"gantt-detail-cb"+id,key:"gantt-detail-cb"+id,onclick:e=>vm.showDetail(e),value:vm.showDetail()}),m("label",{id:"gantt-links-lb"+id,key:"gantt-links-lb"+id,for:"gantt-links-cb"+id},"Show links"),m(cb,{id:"gantt-links-cb"+id,key:"gantt-links-cb"+id,onclick:e=>vm.showLinks(e),value:vm.showLinks()})]),m("div",{id:"gantt"+id,key:"gantt"+id})])}},f.catalog().register("components","gantt",gantt.component);const signInPage={};signInPage.component={oncreate:function(){document.getElementById("fb-title").text="Sign In"},view:function(){return m("div",{class:"pure-form pure-form-aligned"},[m("div",{class:"fb-sign-in fb-sign-in-header"},"Sign in to Featherbone"),m("div",{class:"fb-sign-in fb-sign-in-error"},f.state().current().length?f.state().resolve(f.state().current()[0]).message():""),m("div",{class:"pure-control-group fb-sign-in"},[m("label",{id:"usernameLabel",for:"username",class:"fb-sign-in-label"},"Username"),m("input",{id:"username"})]),m("div",{class:"pure-control-group fb-sign-in"},[m("label",{id:"passwordLabel",for:"password",class:"fb-sign-in-label"},"Password"),m("input",{id:"password",type:"password",onkeydown:function(e){13===e.which&&(f.state().send("authenticate"),e.preventDefault())}})]),m("div",{class:"pure-control-group fb-sign-in"},[m("label",{id:"signinLabel",for:"signin",class:"fb-sign-in-label"},""),m("button",{id:"signin",class:"pure-button pure-button-primary fb-input",onclick:function(){f.state().send("authenticate")}},"Sign in")])])}},f.catalog().register("components","signInPage",signInPage.component);const workbookPage={},editWorkbookConfig={tabs:[{name:"Definition"},{name:"Authorizations"}],attrs:[{attr:"name",grid:1},{attr:"description",grid:1},{attr:"icon",dataList:f.icons(),grid:1},{attr:"sequence",grid:1},{attr:"module",dataList:"modules",grid:1},{attr:"authorizations",showLabel:!1,height:"98px",grid:2,columns:[{attr:"role"},{label:"Read",attr:"canRead",width:60},{label:"Update",attr:"canUpdate",width:60}]}]},editSheetConfig={tabs:[{name:"Sheet"},{name:"Columns"},{name:"Actions"}],attrs:[{attr:"name",grid:1},{attr:"feather",grid:1},{attr:"openInNewWindow",label:"Open in new tab",grid:1},{attr:"form",grid:1},{attr:"isEditModeEnabled",label:"Enable edit mode",grid:1},{attr:"columns",showLabel:!1,height:"139px",grid:2,columns:[{attr:"attr",label:"Column",width:165},{attr:"label",width:165}]},{attr:"actions",showLabel:!1,height:"139px",grid:3,columns:[{attr:"name",width:165},{attr:"title",width:165},{attr:"icon",width:165},{attr:"method",width:165},{attr:"validator",width:165},{attr:"hasSeparator",width:100,label:"Separator"}]}]};let profileInvalid=!1;function saveProfile(name,config,dlg){let thePatch,oldProfile=f.catalog().store().data().profile(),newProfile=f.copy(oldProfile);function callback(resp){newProfile.etag=resp,f.catalog().store().data().profile(newProfile)}profileInvalid||(oldProfile?(newProfile.data.workbooks||(newProfile.data.workbooks={}),config?newProfile.data.workbooks[name]=f.copy(config):delete newProfile.data.workbooks[name],thePatch=jsonpatch.compare(oldProfile.data,newProfile.data),thePatch&&thePatch.length&&f.datasource().request({method:"PATCH",path:"/profile",body:{etag:oldProfile.etag,patch:thePatch}}).then(callback).catch((function(err){profileInvalid=!0,dlg.message(err.message),dlg.icon("window-close"),dlg.buttonCancel().hide(),dlg.show()}))):config&&(newProfile={data:{workbooks:{}}},newProfile.data.workbooks[name]=f.copy(config),f.datasource().request({method:"PUT",path:"/profile",body:newProfile.data}).then(callback)))}workbookPage.viewModel=function(options){let listState,tableState,searchState,currentSheet,theFeather,sseState=f.catalog().store().global().sseState,workbook=f.catalog().store().workbooks()[options.workbook.toCamelCase()];if(!workbook)return m.route.set("/home"),void(options.isInvalid=!0);let config=workbook.getConfig(),the_sheet=config.find((function(sheet){return sheet.name.toSpinalCase()===options.page}));if(!the_sheet)return m.route.set("/home"),void(options.isInvalid=!0);let sheetId=the_sheet.id,receiverKey=f.createId(),vm={},toolbarButtonClass="fb-toolbar-button",formWorkbookClass="fb-form-workbook",sheetEditModel=f.createModel("Worksheet");switch(f.currentUser().mode){case"test":toolbarButtonClass+=" fb-toolbar-button-test",formWorkbookClass+=" fb-form-workbook-test";break;case"dev":toolbarButtonClass+=" fb-toolbar-button-dev",formWorkbookClass+=" fb-form-workbook-dev"}return vm.aggregateDialog=f.prop(),vm.buttonAggregate=f.prop(),vm.buttonClear=f.prop(),vm.buttonDelete=f.prop(),vm.buttonEdit=f.prop(),vm.buttonFilter=f.prop(),vm.buttonNew=f.prop(),vm.buttonRefresh=f.prop(),vm.buttonSave=f.prop(),vm.buttonSort=f.prop(),vm.buttonUndo=f.prop(),vm.config=f.prop(config),vm.confirmDialog=f.prop(f.createViewModel("Dialog",{icon:"question-circle",title:"Confirmation"})),vm.configureSheet=function(e){let dlg=vm.sheetConfigureDialog(),sheet=vm.sheet(e.sheetId),onCancel=vm.sheetConfigureDialog().onCancel(),data={id:sheet.id,name:sheet.name,feather:sheet.feather,form:sheet.form||"",isEditModeEnabled:sheet.isEditModeEnabled,openInNewWindow:sheet.openInNewWindow,actions:sheet.actions||[],columns:sheet.list.columns||[]};sheetEditModel.set(data,!0,!0),sheetEditModel.state().send("fetched"),vm.sheetConfigureDialog().onCancel((function(){onCancel&&onCancel(),sheetEditModel.state().send("clear")})),vm.sheetConfigureDialog().onOk=function(){data=sheetEditModel.toJSON(),sheetEditModel.state().send("clear"),sheet.name=data.name,sheet.feather=data.feather,sheet.form=data.form,sheet.isEditModeEnabled=data.isEditModeEnabled,sheet.openInNewWindow=data.openInNewWindow,sheet.list.columns.length=0,sheet.actions=sheet.actions||[],sheet.actions.length=0,data.columns.forEach((function(d){void 0!==d&&sheet.list.columns.push({attr:d.attr,label:d.label,width:d.width})})),data.actions.forEach((function(d){void 0!==d&&sheet.actions.push({name:d.name,title:d.title,icon:d.icon,method:d.method,validator:d.validator,hasSeparator:Boolean(d.hasSeparator)})})),data.isEditModeEnabled?vm.buttonEdit().enable():vm.buttonEdit().disable(),vm.saveProfile()},dlg.show()},vm.footerId=f.prop(f.createId()),vm.deleteSheet=function(ev){let doDelete,idx=ev.dataTransfer.getData("text")-0,confirmDialog=vm.confirmDialog();doDelete=function(){let activeSheetId=vm.sheet().id,deleteSheetId=vm.config()[idx].id;vm.config().splice(idx,1),activeSheetId===deleteSheetId&&(idx===vm.config().length&&(idx-=1),vm.tabClicked(config[idx].name)),vm.saveProfile()},confirmDialog.message("Are you sure you want to delete this sheet?"),confirmDialog.icon("question-circle"),confirmDialog.onOk(doDelete),confirmDialog.show()},vm.editWorkbookDialog=f.prop(),vm.filter=f.prop(),vm.filterDialog=f.prop(),vm.goHome=function(){m.route.set("/home")},vm.goSignOut=function(){f.state().send("signOut")},vm.goSettings=function(){m.route.set("/settings/:settings",{settings:workbook.data.launchConfig().settings})},vm.isDraggingTab=f.prop(!1),vm.hasSettings=f.prop(Boolean(workbook.data.launchConfig().settings)),vm.modelNew=function(){let url,win,form=f.catalog().store().data().forms().find((function(frm){return vm.sheet().form===frm.name}))||{};if(vm.sheet().openInNewWindow)return url=window.location.protocol+"//"+window.location.hostname+":"+window.location.port+"#!/edit/"+theFeather.name.toSpinalCase()+"/"+f.createId(),win=window.open(url),win.options={form:form.id,create:!0,isNewWindow:!0},void(win.receiver=function(model){let nmodel=f.createModel(model.name,model.toJSON());nmodel.state().goto("/Ready/Fetched/Clean"),nmodel.checkDelete(),nmodel.checkUpdate(),vm.tableWidget().models().add(nmodel,!0),m.redraw()});vm.tableWidget().modelNew()||m.route.set("/edit/:feather/:key",{feather:theFeather.name.toSpinalCase(),key:f.createId()},{state:{form:form.id,receiver:receiverKey,create:!0}})},vm.modelOpen=function(){let url,win,selection=vm.tableWidget().selection(),sheet=vm.sheet()||{},form=f.catalog().store().data().forms().find((function(frm){return sheet.form===frm.name}))||{},type=vm.tableWidget().model().data.objectType();if(vm.sheet().openInNewWindow)return url=window.location.protocol+"//"+window.location.hostname+":"+window.location.port+"#!/edit/"+type+"/"+selection.id(),win=window.open(url),void(win.options={form:form.id,isNewWindow:!0});selection&&m.route.set("/edit/:feather/:key",{feather:type,key:selection.id()},{state:{form:form.id,receiver:receiverKey}})},vm.menu=f.prop(f.createViewModel("NavigatorMenu")),vm.newSheet=function(){let undo,newSheet,sheetName,next,dialogSheetConfigure=vm.sheetConfigureDialog(),theId=f.createId(),sheets=vm.sheets(),sheet=f.copy(vm.sheet()),i=0;for(;!sheetName;)i+=1,next="Sheet"+i,-1===sheets.indexOf(next)&&(sheetName=next);i=0,newSheet={id:theId,name:sheetName,feather:sheet.feather,list:{columns:sheet.list.columns},actions:[]},undo=function(){vm.config().pop(),dialogSheetConfigure.onCancel(void 0)},vm.config().push(newSheet),dialogSheetConfigure.onCancel(undo),vm.configureSheet({sheetId:theId})},vm.ondragend=function(){vm.isDraggingTab(!1)},vm.ondragover=function(ev){ev.preventDefault()},vm.ondragstart=function(idx,ev){vm.isDraggingTab(!0),ev.dataTransfer.setData("text",idx)},vm.ondrop=function(toIdx,ary,ev){let moved,fromIdx;ev.preventDefault(),fromIdx=ev.dataTransfer.getData("text")-0,fromIdx!==toIdx&&(moved=ary.splice(fromIdx,1)[0],ary.splice(toIdx,0,moved),vm.saveProfile()),vm.isDraggingTab(!1)},vm.onkeydown=function(ev){switch(ev.key||ev.keyIdentifier){case"Up":case"ArrowUp":vm.tableWidget().goPrevRow();break;case"Down":case"ArrowDown":vm.tableWidget().goNextRow()}},vm.onclickactions=function(){vm.showActions(!0)},vm.onmouseoutactions=function(ev){ev&&ev.toElement&&ev.toElement.id&&-1!==ev.toElement.id.indexOf("nav-actions")||vm.showActions(!1)},vm.onclickmenu=function(){vm.showMenu(!vm.showMenu())},vm.onmouseoutmenu=function(ev){ev&&ev.toElement&&ev.toElement.id&&-1!==ev.toElement.id.indexOf("nav-menu")||vm.showMenu(!1)},vm.refresh=function(){vm.tableWidget().refresh()},vm.revert=function(){saveProfile(workbook.data.name(),void 0,vm.confirmDialog()),document.location.reload()},vm.saveProfile=function(){saveProfile(workbook.data.name(),vm.config(),vm.confirmDialog())},vm.searchInput=f.prop(),vm.share=function(){let doShare,confirmDialog=vm.confirmDialog();doShare=function(){let d=f.copy(vm.config());workbook.data.localConfig(d),workbook.save()},confirmDialog.message("Are you sure you want to share your workbook configuration with all other users?"),confirmDialog.icon("question-circle"),confirmDialog.onOk(doShare),confirmDialog.show()},vm.sheet=function(id,value){let idx=0;return id?"object"==typeof id&&(value=id,id=sheetId):id=sheetId,currentSheet&&currentSheet.id===id&&!value||(config.some((function(item){if(id===item.id)return!0;idx+=1})),value&&vm.config().splice(idx,1,value),currentSheet=vm.config()[idx]),currentSheet},vm.sheets=function(){return vm.config().map((function(sheet){return sheet.name}))},vm.sheetConfigureDialog=f.prop(),vm.showFilterDialog=function(){vm.tableWidget().models().canFilter()&&vm.filterDialog().show()},vm.showActions=f.prop(!1),vm.showMenu=f.prop(!1),vm.showSortDialog=function(){vm.tableWidget().models().canFilter()&&vm.sortDialog().show()},vm.sortDialog=f.prop(),vm.sseErrorDialog=f.prop(f.createViewModel("Dialog",{icon:"window-close",title:"Connection Error",message:'You have lost connection to the server. Click "Ok" to attempt to reconnect.',onOk:function(){document.location.reload()}})),vm.sseErrorDialog().buttonCancel().hide(),vm.tabClicked=function(sheet){let wb=workbook.data.name().toSpinalCase(),pg=sheet.toSpinalCase();m.route.set("/workbook/:workbook/:page",{workbook:wb,page:pg,key:f.hashCode(wb+"-"+pg)})},vm.tableWidget=f.prop(),vm.workbook=function(){return workbook},vm.zoom=function(value){let w=vm.tableWidget();return void 0!==value&&w.zoom(value),w.zoom()},theFeather=f.catalog().getFeather(vm.sheet().feather),f.catalog().register("receivers",receiverKey,{callback:function(model){let tableModel=vm.tableWidget().selection();tableModel&&tableModel.id()===model.id()||vm.tableWidget().models().add(model,!0)}}),vm.searchInput(f.createViewModel("SearchInput",{refresh:vm.refresh})),vm.tableWidget(f.createViewModel("TableWidget",{class:formWorkbookClass,actions:vm.sheet().actions,config:vm.sheet().list,isEditModeEnabled:vm.sheet().isEditModeEnabled,feather:vm.sheet().feather,search:vm.searchInput().value,ondblclick:vm.modelOpen,subscribe:!0,footerId:vm.footerId()})),vm.tableWidget().isDragging.state().resolve("/Changing").exit((function(){vm.tableWidget().isDragging()||vm.saveProfile()})),vm.filterDialog(f.createViewModel("FilterDialog",{filter:vm.tableWidget().filter,list:vm.tableWidget().models(),feather:theFeather,onOk:vm.saveProfile})),vm.editWorkbookDialog(f.createViewModel("FormDialog",{icon:"cogs",title:"Edit workbook",model:workbook,config:editWorkbookConfig})),vm.editWorkbookDialog().style().width="475px",vm.editWorkbookDialog().buttons().push(f.prop(f.createViewModel("Button",{label:"Delete",onclick:function(){let dlg=vm.confirmDialog();dlg.message("This will permanently delete this workbook. Are you sure?"),dlg.icon("exclamation-triangle"),dlg.onOk((function(){let name=workbook.data.name();name=name.toSpinalCase().toCamelCase(),workbook.delete(!0).then((function(){f.catalog().unregister("workbooks",name),vm.editWorkbookDialog().cancel(),m.route.set("/home")}))})),dlg.show()},class:"fb-button-delete"}))),f.currentUser().isSuper||(vm.editWorkbookDialog().buttons()[2]().disable(),vm.editWorkbookDialog().buttons()[2]().title("Must be a super user to delete this workbook")),vm.sheetConfigureDialog(f.createViewModel("FormDialog",{icon:"table",title:"Configure worksheet",model:sheetEditModel,config:editSheetConfig})),vm.sheetConfigureDialog().style().width="520px",vm.aggregateDialog(f.createViewModel("AggregateDialog",{aggregates:vm.tableWidget().aggregates,list:vm.tableWidget().models(),feather:theFeather,onOk:function(){vm.refresh(),vm.saveProfile()}})),vm.sortDialog(f.createViewModel("SortDialog",{filter:vm.tableWidget().filter,list:vm.tableWidget().models(),feather:theFeather,onOk:vm.saveProfile})),vm.buttonEdit(f.createViewModel("Button",{onclick:vm.tableWidget().toggleMode,title:"Edit mode",hotkey:"E",icon:"edit",class:toolbarButtonClass})),vm.tableWidget().isEditModeEnabled()||vm.buttonEdit().disable(),vm.buttonSave(f.createViewModel("Button",{onclick:vm.tableWidget().save,label:"&Save",icon:"cloud-upload-alt",class:toolbarButtonClass})),vm.buttonSave().hide(),vm.buttonNew(f.createViewModel("Button",{onclick:vm.modelNew,label:"&New",icon:"plus-circle",class:toolbarButtonClass})),vm.buttonDelete(f.createViewModel("Button",{onclick:vm.tableWidget().modelDelete,label:"&Delete",icon:"trash",class:toolbarButtonClass})),vm.buttonDelete().disable(),(theFeather.isReadOnly||theFeather.isChild)&&(vm.buttonNew().disable(),vm.buttonNew().title("Table is read only"),vm.buttonDelete().title("Table is read only")),vm.buttonUndo(f.createViewModel("Button",{onclick:vm.tableWidget().undo,label:"&Undo",icon:"undo",class:toolbarButtonClass})),vm.buttonUndo().hide(),vm.buttonRefresh(f.createViewModel("Button",{onclick:vm.refresh,title:"Refresh",hotkey:"R",icon:"sync",class:toolbarButtonClass})),vm.buttonClear(f.createViewModel("Button",{onclick:vm.searchInput().clear,title:"Clear search",hotkey:"C",icon:"eraser",class:toolbarButtonClass})),vm.buttonClear().disable(),vm.buttonSort(f.createViewModel("Button",{onclick:vm.showSortDialog,icon:"sort",hotkey:"T",title:"Sort results",class:toolbarButtonClass})),vm.buttonFilter(f.createViewModel("Button",{onclick:vm.showFilterDialog,icon:"filter",hotkey:"F",title:"Filter results",class:toolbarButtonClass})),vm.buttonAggregate(f.createViewModel("Button",{onclick:vm.aggregateDialog().show,icon:"calculator",title:"Calculate sum, count and other aggregations",class:toolbarButtonClass})),listState=vm.tableWidget().models().state(),listState.resolve("/Fetched").enter((function(){let model=vm.tableWidget().selection();if(model&&model.canUndo())return vm.buttonDelete().hide(),void vm.buttonUndo().show();vm.buttonDelete().show(),vm.buttonUndo().hide()})),listState.resolve("/Fetched/Clean").enter((function(){vm.buttonSave().disable()})),listState.state().resolve("/Fetched/Dirty").enter((function(){vm.buttonSave().enable()})),searchState=vm.searchInput().state(),searchState.resolve("/Search/On").enter((function(){vm.buttonClear().enable()})),searchState.resolve("/Search/Off").enter((function(){vm.buttonClear().disable()})),tableState=vm.tableWidget().state(),tableState.resolve("/Mode/View").enter((function(){vm.buttonEdit().deactivate(),vm.buttonSave().hide()})),tableState.resolve("/Mode/Edit").enter((function(){vm.buttonEdit().activate(),vm.buttonSave().show()})),tableState.resolve("/Selection/Off").enter((function(){vm.buttonDelete().disable(),vm.buttonDelete().show(),vm.buttonUndo().hide()})),tableState.resolve("/Selection/On/Clean").enter((function(){vm.buttonDelete().show(),vm.buttonUndo().hide()})),tableState.resolve("/Selection/On/Dirty").enter((function(){vm.buttonDelete().hide(),vm.buttonUndo().show()})),sseState.resolve("Error").enter((function(){vm.sseErrorDialog().show()})),f.catalog().isAuthorized({feather:theFeather.name,action:"canCreate"}).then((function(canCreate){canCreate||(vm.buttonNew().disable(),vm.buttonNew().title("Unauthorized"))})).catch((function(err){console.error(err.message)})),vm},workbookPage.component={oninit:function(vnode){let workbook=vnode.attrs.workbook,sheet=vnode.attrs.page,viewModels=f.catalog().register("workbookViewModels");viewModels[workbook]&&viewModels[workbook][sheet]?this.viewModel=viewModels[workbook][sheet]:(this.viewModel=workbookPage.viewModel(vnode.attrs),vnode.attrs.isInvalid||(this.viewModel.menu().selected(workbook),viewModels[workbook]||(viewModels[workbook]={}),viewModels[workbook][sheet]=this.viewModel))},onupdate:function(vnode){this.viewModel.menu().selected(vnode.attrs.workbook)},view:function(vnode){if(vnode.attrs.isInvalid)return;let filterMenuClass,tabs,vm=this.viewModel,createTabClass="pure-button fb-workbook-tab-edit",deleteTabClass="pure-button fb-workbook-tab-edit",activeSheet=vm.sheet(),config=vm.config(),idx=0,btn=f.getComponent("Button"),srtdlg=f.getComponent("SortDialog"),fltdlg=f.getComponent("FilterDialog"),frmdlg=f.getComponent("FormDialog"),aggdlg=f.getComponent("AggregateDialog"),srch=f.getComponent("SearchInput"),tw=f.getComponent("TableWidget"),dlg=f.getComponent("Dialog"),nav=f.getComponent("NavigatorMenu"),menu=f.getComponent("AccountMenu"),toolbarClass="fb-toolbar",menuButtonClass="fb-menu-button";switch(f.currentUser().mode){case"test":toolbarClass+=" fb-toolbar-test",menuButtonClass+=" fb-menu-button-test";break;case"dev":toolbarClass+=" fb-toolbar-dev",menuButtonClass+=" fb-menu-button-dev"}return vm.tableWidget().selections().some((s=>s.canDelete()))?vm.buttonDelete().enable():vm.buttonDelete().disable(),tabs=vm.sheets().map((function(sheet){let tab,tabOpts;return tabOpts={class:"fb-workbook-tab pure-button"+(activeSheet.name.toName()===sheet.toName()?" pure-button-primary":""),onclick:vm.tabClicked.bind(this,sheet)},vm.config().length>1&&(tabOpts.ondragover=vm.ondragover,tabOpts.draggable=!0,tabOpts.ondragstart=vm.ondragstart.bind(this,idx),tabOpts.ondrop=vm.ondrop.bind(this,idx,config),tabOpts.ondragend=vm.ondragend,tabOpts.class+=" fb-workbook-tab-draggable"),tab=m("button[type=button]",tabOpts,sheet.toName()),idx+=1,tab})),vm.isDraggingTab()?(createTabClass+=" fb-workbook-tab-edit-hide",deleteTabClass+=" fb-workbook-tab-edit-show"):(createTabClass+=" fb-workbook-tab-edit-show",deleteTabClass+=" fb-workbook-tab-edit-hide"),tabs.push(m("button[type=button]",{class:createTabClass,title:"Add sheet",onclick:vm.newSheet},[m("i",{class:"fa fa-plus"})])),tabs.push(m("div",{class:deleteTabClass,ondragover:vm.ondragover,ondrop:vm.deleteSheet},[m("i",{class:"fa fa-trash"})])),filterMenuClass="pure-menu-link",vm.tableWidget().models().canFilter()||(filterMenuClass+=" pure-menu-disabled"),m("div",{class:"pure-form",oncreate:function(){let title=vm.sheet().name.toName();document.getElementById("fb-title").text=title}},[m(srtdlg,{viewModel:vm.sortDialog()}),m(fltdlg,{viewModel:vm.filterDialog()}),m(aggdlg,{viewModel:vm.aggregateDialog()}),m(frmdlg,{viewModel:vm.editWorkbookDialog()}),m(frmdlg,{viewModel:vm.sheetConfigureDialog()}),m(dlg,{viewModel:vm.confirmDialog()}),m(dlg,{viewModel:vm.sseErrorDialog()}),m("div",{class:"fb-navigator-menu-container"},[m(nav,{viewModel:vm.menu()}),m("div",[m("div",{id:"toolbar",class:toolbarClass,onkeydown:vm.onkeydown},[m(btn,{viewModel:vm.buttonEdit()}),m(btn,{viewModel:vm.buttonSave()}),m(btn,{viewModel:vm.buttonNew()}),m(btn,{viewModel:vm.buttonDelete()}),m(btn,{viewModel:vm.buttonUndo()}),m("div",{id:"nav-actions-div",class:"pure-menu custom-restricted-width fb-menu",onclick:vm.onclickactions,onmouseout:vm.onmouseoutactions},[m("span",{id:"nav-actions-button",class:"pure-button fa fa-bolt "+menuButtonClass}),m("ul",{id:"nav-actions-list",class:"pure-menu-list fb-menu-list"+(vm.showActions()?" fb-menu-list-show":"")},vm.tableWidget().actions())]),m("div",{class:"fb-toolbar-spacer"}),m(btn,{viewModel:vm.buttonRefresh()}),m(srch,{viewModel:vm.searchInput()}),m(btn,{viewModel:vm.buttonClear()}),m(btn,{viewModel:vm.buttonSort()}),m(btn,{viewModel:vm.buttonFilter()}),m(btn,{viewModel:vm.buttonAggregate()}),m("div",{id:"nav-menu-div",class:"pure-menu custom-restricted-width fb-menu fb-menu-setup",onclick:vm.onclickmenu,onmouseout:vm.onmouseoutmenu},[m("span",{id:"nav-meun-button",class:"pure-button fa fa-list "+menuButtonClass}),m("ul",{id:"nav-menu-list",class:"pure-menu-list fb-menu-list fb-menu-list-setup"+(vm.showMenu()?" fb-menu-list-show":"")},[m("li",{id:"nav-menu-configure-worksheet",class:"pure-menu-link",title:"Configure current worksheet",onclick:vm.configureSheet},[m("i",{id:"nav-menu-configure-worksheet-icon",class:"fa fa-table  fb-menu-list-icon"})],"Sheet"),m("li",{id:"nav-menu-configure-workbook",class:"pure-menu-link",title:"Configure current workbook",onclick:vm.editWorkbookDialog().show},[m("i",{id:"nav-menu-configure-workbook-icon",class:"fa fa-cogs  fb-menu-list-icon"})],"Workbook"),m("li",{id:"nav-menu-share",class:"pure-menu-link "+(vm.workbook().canUpdate()?"":" pure-menu-disabled"),title:"Share workbook configuration",onclick:vm.share},[m("i",{id:"nav-menu-share-icon",class:"fa fa-share-alt fb-menu-list-icon"})],"Share"),m("li",{id:"nav-menu-revert",class:"pure-menu-link",title:"Revert workbook configuration to original state",onclick:vm.revert},[m("i",{id:"nav-menu-revert-icon",class:"fa fa-reply fb-menu-list-icon"})],"Revert"),m("li",{id:"nav-menu-settings",class:"pure-menu-link fb-menu-list-separator"+(vm.hasSettings()?"":" pure-menu-disabled"),title:"Change module settings",onclick:vm.goSettings},[m("i",{id:"nav-menu-settings-icon",class:"fa fa-wrench fb-menu-list-icon"})],"Settings")])]),m(menu)]),m(tw,{viewModel:vm.tableWidget()}),m("div",{id:vm.footerId()},[tabs,m("i",{class:"fa fa-search-plus fb-zoom-icon fb-zoom-right-icon"}),m("input",{class:"fb-zoom-control",title:"Zoom "+vm.zoom()+"%",type:"range",step:"5",min:"50",max:"150",value:vm.zoom(),oninput:e=>vm.zoom(e.target.value)}),m("i",{class:"fa fa-search-minus fb-zoom-icon fb-zoom-left-icon"})])])])])}},f.catalog().register("components","workbookPage",workbookPage.component);const authTable={},formPage={},instances=f.catalog().register("instances"),formInstances=f.catalog().register("formInstances"),authFeather={name:"ObjectAuthorization",plural:"ObjectAuthorizations",isSystem:!0,properties:{id:{description:"Internal id",type:"string",default:"createId()"},role:{description:"Role name",type:"string",format:"role",isRequired:!0},editorCanRead:{description:"Editor for can read feather",type:"boolean"},editorCanUpdate:{description:"Editor for can update feather",type:"boolean"},editorCanDelete:{description:"Editor for can delete feather",type:"boolean"},canRead:{description:"Role can read object",type:"string"},canUpdate:{description:"Role can update object",type:"string"},canDelete:{description:"Role can update object",type:"string"},hasFeatherAuth:{description:"Has feather authorization",type:"boolean"},featherCanRead:{description:"Role can read feather",type:"boolean"},featherCanUpdate:{description:"Role can update feather",type:"boolean"},featherCanDelete:{description:"Role can update feather",type:"boolean"},isDeleted:{type:"boolean"}}};function resolveAction(value){return"true"===value?value=!0:"false"===value?value=!1:""===value&&(value=null),value}function authModel(data){let state,that=f.createModel(data,authFeather),d=that.data;function editing(action,prop){let value,oaction="can"+action,faction="featherCan"+action;if(d.hasFeatherAuth()){if(null===d[oaction]())return value=!d[faction](),void d[oaction](value.toString());if(resolveAction(d[oaction]())===d[faction]())return d[oaction](null),void prop.newValue(prop.oldValue())}value=!resolveAction(d[oaction]()),d[oaction](value.toString())}function actionChanged(action){let oaction="can"+action;d["editorCan"+action].style(null===d[oaction]()&&d.hasFeatherAuth()?"DEFAULT":"")}return that.objectId=f.prop(),state=that.state(),state.resolve("/Busy/Saving/Posting").enters.pop(),state.resolve("/Busy/Saving/Posting").enter((function(context){let isDeleting=context.isDeleting,payload={method:"POST",path:"/do/save-authorization",data:{id:that.objectId(),role:d.role(),actions:{canCreate:null,canRead:resolveAction(d.canRead()),canUpdate:resolveAction(d.canUpdate()),canDelete:resolveAction(d.canDelete())}}};isDeleting&&(payload.data.actions.canRead=null,payload.data.actions.canUpdate=null,payload.data.actions.canDelete=null),f.datasource().request(payload).then((function(resp){resp&&!isDeleting?state.goto("/Ready/Fetched/Clean"):state.goto("/Deleted"),context.resolve()}))})),state.resolve("/Ready/Fetched/Dirty").event("save",(function(pContext){that.state().goto("/Busy/Saving/Posting",{context:pContext})})),state.resolve("/Ready/Fetched/Clean").event("changed",(function(){this.goto("../Dirty")})),state.resolve("/Delete").enters.shift(),state.resolve("/Delete").event("save",(function(pContext){pContext.isDeleting=!0,that.state().goto("/Busy/Saving/Posting",{context:pContext})})),that.onLoad((function(){!function(){function getValue(action){return null!==resolveAction(d["can"+action]())?resolveAction(d["can"+action]()):d.hasFeatherAuth()?d["featherCan"+action]():null}that.set({editorCanRead:getValue("Read"),editorCanUpdate:getValue("Update"),editorCanDelete:getValue("Delete")},!0)}(),actionChanged("Read"),actionChanged("Update"),actionChanged("Delete")})),that.onChange("editorCanRead",editing.bind(null,"Read")),that.onChange("editorCanUpdate",editing.bind(null,"Update")),that.onChange("editorCanDelete",editing.bind(null,"Delete")),that.onChanged("canRead",actionChanged.bind(null,"Read")),that.onChanged("canUpdate",actionChanged.bind(null,"Update")),that.onChanged("canDelete",actionChanged.bind(null,"Delete")),that.onChanged("featherCanRead",actionChanged.bind(null,"Read")),that.onChanged("featherCanUpdate",actionChanged.bind(null,"Update")),that.onChanged("featherCanDelete",actionChanged.bind(null,"Delete")),that}f.catalog().register("feathers","ObjectAuthorization",authFeather),f.catalog().registerModel("objectAuthorization",authModel),authTable.viewModel=function(options){let tableState,vm={};return vm.buttonAdd=f.prop(),vm.buttonRemove=f.prop(),vm.buttonUndo=f.prop(),vm.tableWidget=f.prop(),vm.tableWidget(f.createViewModel("TableWidget",{models:options.models,config:{columns:[{attr:"role"},{label:"Read",attr:"editorCanRead",width:60},{label:"Update",attr:"editorCanUpdate",width:60},{label:"Delete",attr:"editorCanDelete",width:60}]},feather:"ObjectAuthorization",height:"200px"})),vm.tableWidget().toggleEdit(),vm.tableWidget().isQuery(!1),vm.buttonAdd(f.createViewModel("Button",{onclick:vm.tableWidget().modelNew,title:"Insert",hotkey:"I",icon:"plus-circle",class:"fb-icon-button",style:{backgroundColor:"white"}})),vm.buttonRemove(f.createViewModel("Button",{onclick:vm.tableWidget().modelDelete,title:"Delete",hotkey:"D",icon:"trash",class:"fb-icon-button",style:{backgroundColor:"white"}})),vm.buttonRemove().disable(),vm.buttonUndo(f.createViewModel("Button",{onclick:vm.tableWidget().undo,title:"Undo",hotkey:"U",icon:"undo",class:"fb-icon-button",style:{backgroundColor:"white"}})),vm.buttonUndo().hide(),tableState=vm.tableWidget().state(),tableState.resolve("/Selection/Off").enter((function(){vm.buttonRemove().disable(),vm.buttonRemove().show(),vm.buttonUndo().hide()})),tableState.resolve("/Selection/On").enter(vm.buttonRemove().enable),tableState.resolve("/Selection/On/Clean").enter((function(){vm.buttonRemove().show(),vm.buttonUndo().hide()})),tableState.resolve("/Selection/On/Dirty").enter((function(){vm.buttonRemove().hide(),vm.buttonUndo().show()})),vm},authTable.component={oninit:function(vnode){this.viewModel=vnode.attrs.viewModel},view:function(){let btn=f.getComponent("Button"),tw=f.getComponent("TableWidget");return m("div",[m(btn,{viewModel:this.viewModel.buttonAdd()}),m(btn,{viewModel:this.viewModel.buttonRemove()}),m(btn,{viewModel:this.viewModel.buttonUndo()}),m(tw,{viewModel:this.viewModel.tableWidget()})])}},formPage.viewModel=function(options){let isDisabled,applyTitle,saveTitle,fmodel;window.options&&Object.keys(window.options).forEach((function(key){options[key]=window.options[key]}));let sseState=f.catalog().store().global().sseState,theFeather=options.feather.toCamelCase(!0),form=f.getForm({form:options.form,feather:theFeather}),vm={},pageIdx=options.index||1,isNew=options.create&&!1!==options.isNew,authorizations=f.createList("ObjectAuthorization",{fetch:!1});authorizations.checkUpdate=!1;let authViewModel=authTable.viewModel({models:authorizations}),toolbarButtonClass="fb-toolbar-button";switch(f.currentUser().mode){case"test":toolbarButtonClass+=" fb-toolbar-button-test";break;case"dev":toolbarButtonClass+=" fb-toolbar-button-dev"}function callReceiver(){let receivers;options.receiver&&(receivers=f.catalog().register("receivers"),receivers[options.receiver]&&receivers[options.receiver].callback(vm.model())),window.receiver&&window.receiver(vm.model())}function postProcess(){f.catalog().getFeather(theFeather).authorizations.forEach((function(auth){let actions=auth.actions,found=authorizations.find((function(a){return a.data.role()===auth.role}));found?found.set({hasFeatherAuth:!0,featherCanRead:actions.canRead,featherCanUpdate:actions.canUpdate,featherCanDelete:actions.canDelete}):(found=authModel({role:auth.role,canRead:null,canUpdate:null,canDelete:null,editorCanRead:actions.canRead,editorCanUpdate:actions.canUpdate,editorCanDelete:actions.canDelete,hasFeatherAuth:!0,featherCanRead:actions.canRead,featherCanUpdate:actions.canUpdate,featherCanDelete:actions.canDelete}),authorizations.add(found)),found.state().goto("/Ready/Fetched/Clean")})),authorizations.sort((function(a,b){return a.data.role()<b.data.role()?-1:1}))}return fmodel=options.key&&instances[options.key]?instances[options.key]:options.feather.toCamelCase(),vm.buttonApply=f.prop(),vm.buttonAuth=f.prop(),vm.buttonPdf=f.prop(),vm.buttonBack=f.prop(),vm.buttonSave=f.prop(),vm.buttonSaveAndNew=f.prop(),vm.confirmDialog=f.prop(f.createViewModel("Dialog",{icon:"question-circle",title:"Confirm close",message:"You will lose changes you have made. Are you sure?",onOk:function(){vm.model().state().send("undo"),vm.doBack(!0)}})),vm.doApply=function(){vm.model().save().then((function(){callReceiver()}))},vm.doBack=function(force){let current=vm.model().state().current()[0];if("/Ready/New"!==current&&"/Ready/Fetched/Dirty"!==current||!0===force){if(delete instances[vm.model().id()],delete formInstances[vm.model().id()],options.isNewWindow)return sseState.send("close"),void window.close();null!==window.history.state?window.history.go(-1*pageIdx):m.route.set("/home")}else vm.confirmDialog().show()},vm.doNew=function(){let opts={feather:options.feather,key:f.createId()},state={state:{form:options.form,index:pageIdx+1,create:!0,receiver:options.receiver}};m.route.set("/edit/:feather/:key",opts,state)},vm.doSave=function(){vm.model().save().then((function(){callReceiver(),vm.doBack()}))},vm.doSaveAndNew=function(){vm.model().save().then((function(){callReceiver(),delete instances[vm.model().id()],delete formInstances[vm.model().id()],vm.doNew()}))},vm.editAuthDialog=f.prop(f.createViewModel("Dialog",{icon:"key",title:"Edit Authorizations",onOk:function(){let id=vm.model().id();authorizations.forEach((a=>a.objectId(id))),authorizations.save()}})),vm.editAuthDialog().content=function(){return m(authTable.component,{viewModel:authViewModel})},vm.editAuthDialog().style().width="575px",vm.editAuthDialog().state().resolve("/Display/Showing").enter((function(){authorizations.fetch({criteria:[{property:"id",value:vm.model().id()}]},!1).then(postProcess)})),vm.formWidget=f.prop(),vm.isNew=f.prop(isNew),vm.model=function(){return vm.formWidget().model()},vm.sseErrorDialog=f.prop(f.createViewModel("Dialog",{icon:"window-close",title:"Connection Error",message:'You have lost connection to the server.Click "Ok" to attempt to reconnect.',onOk:function(){document.location.reload()}})),vm.sseErrorDialog().buttonCancel().hide(),vm.title=function(){return options.feather.toName()},vm.toggleNew=function(){vm.buttonSaveAndNew().title(""),vm.model().canSave()?(vm.buttonSaveAndNew().label("Save and &New"),vm.buttonSaveAndNew().onclick(vm.doSaveAndNew)):(vm.buttonSaveAndNew().label("&New"),vm.buttonSaveAndNew().onclick(vm.doNew))},vm.formWidget(f.createViewModel("FormWidget",{isNew:Boolean(isNew),model:fmodel,id:options.key,config:form,outsideElementIds:["toolbar","title"]})),isNew&&(options.isNew=!1,m.route.set(m.route.get(),null,{replace:!0,state:options})),instances[vm.model().id()]=vm.model(),vm.buttonBack(f.createViewModel("Button",{onclick:vm.doBack,label:null===window.history.state?"&Done":"&Back",icon:null===window.history.state?"":"arrow-left",class:toolbarButtonClass})),vm.buttonApply(f.createViewModel("Button",{onclick:vm.doApply,label:"&Apply",class:toolbarButtonClass})),vm.buttonAuth(f.createViewModel("Button",{onclick:vm.editAuthDialog().show,icon:"key",title:"Edit Authorizations",class:toolbarButtonClass+" fb-toolbar-button-right"})),vm.buttonPdf(f.createViewModel("Button",{onclick:function(){let payload,dlg=vm.confirmDialog(),p=f.catalog().getFeather(theFeather).properties,now=new Date,nkey=Object.keys(p).find((function(k){return p[k].isNaturalKey}))||"id",file=vm.model().data[nkey]()+" "+now.toLocalDate()+" "+now.getHours()+now.getMinutes();return console.log(file),payload={method:"POST",url:"/do/print-pdf/form/",body:{id:vm.model().id(),form:form.name,filename:file}},m.request(payload).then((function(resp){let url=window.location.protocol+"//"+window.location.hostname+":"+window.location.port+"/pdf/"+resp;window.open(url)})).catch((function(err){dlg.message(err.message),dlg.title("Error"),dlg.icon("window-close"),dlg.buttonCancel().hide(),dlg.show()}))},icon:"file-pdf",title:"Print to PDF",class:toolbarButtonClass+" fb-toolbar-button-right"})),vm.buttonSave(f.createViewModel("Button",{onclick:vm.doSave,label:"&Save",icon:"cloud-upload-alt",class:toolbarButtonClass})),vm.buttonSaveAndNew(f.createViewModel("Button",{onclick:vm.doSaveAndNew,label:"Save and &New",icon:"plus-circle",class:toolbarButtonClass})),f.catalog().getFeather(theFeather).isReadOnly&&(vm.buttonSaveAndNew().label("&New"),vm.buttonSaveAndNew().title("Data is read only"),vm.buttonSaveAndNew().disable()),isDisabled=function(){return!vm.model().canSave()},applyTitle=vm.buttonApply().title,saveTitle=vm.buttonSave().title,vm.buttonApply().isDisabled=isDisabled,vm.buttonApply().title=function(){return isDisabled()?vm.model().lastError()||"No changes to apply":applyTitle()},vm.buttonSave().isDisabled=isDisabled,vm.buttonSave().title=function(){return isDisabled()?vm.model().lastError()||"No changes to save":saveTitle()},sseState.resolve("Error").enter((function(){vm.sseErrorDialog().show()})),vm},formPage.component={oninit:function(vnode){let frminstances=f.catalog().store().formInstances(),key=vnode.attrs.key,existing=frminstances[key];!vnode.attrs.viewModel&&existing&&(vnode.attrs.viewModel=existing),this.viewModel=vnode.attrs.viewModel||formPage.viewModel(vnode.attrs),frminstances[key]=this.viewModel},onupdate:function(){let key=this.viewModel.isNew()?"(New)":this.viewModel.model().naturalKey(),title=this.viewModel.title()+(key?": "+key:"");document.getElementById("fb-title").text=title},view:function(){let lock,theTitle,vm=this.viewModel,fmodel=vm.model(),icon="file-alt",btn=f.getComponent("Button"),dlg=f.getComponent("Dialog"),fw=f.getComponent("FormWidget"),toolbarClass="fb-toolbar";switch(f.currentUser().mode){case"test":toolbarClass+=" fb-toolbar-test";break;case"dev":toolbarClass+=" fb-toolbar-dev"}if(vm.toggleNew(),vm.buttonAuth().disable(),!1===fmodel.canUpdate())icon="lock",theTitle="Unauthorized to edit";else switch(fmodel.state().current()[0]){case"/Locked":icon="user-lock",lock=fmodel.data.lock()||{},theTitle="User: "+lock.username+"\nSince: "+new Date(lock.created).toLocaleTimeString();break;case"/Ready/Fetched/Dirty":icon="pencil-alt",theTitle="Editing record";break;case"/Ready/New":icon="plus",theTitle="New record";break;default:fmodel.data.owner&&fmodel.data.owner()===f.currentUser().name&&vm.buttonAuth().enable()}return m("div",[m("div",{id:"toolbar",class:toolbarClass},[m(btn,{viewModel:vm.buttonAuth()}),m(btn,{viewModel:vm.buttonPdf()}),m(btn,{viewModel:vm.buttonBack()}),m(btn,{viewModel:vm.buttonApply()}),m(btn,{viewModel:vm.buttonSave()}),m(btn,{viewModel:vm.buttonSaveAndNew()})]),m("div",{class:"fb-title",id:"title"},[m("i",{class:"fa fa-"+icon+" fb-title-icon",title:theTitle}),m("label",vm.title())]),m(dlg,{viewModel:vm.confirmDialog()}),m(dlg,{viewModel:vm.sseErrorDialog()}),m(dlg,{viewModel:vm.editAuthDialog()}),m(fw,{viewModel:vm.formWidget()})])}},f.catalog().register("components","formPage",formPage.component);const accountMenu={viewModel:function(){const vm={};let pwdView,infoView,oldPwd=f.prop(""),newPwd=f.prop(""),cnfPwd=f.prop(""),user=f.currentUser(),firstName=f.prop(user.firstName),lastName=f.prop(user.lastName),phone=f.prop(user.phone),email=f.prop(user.email);function validatePassword(){let msg,dlg=vm.changePasswordDialog();dlg.okDisabled(!0),oldPwd().length?newPwd().length?newPwd()!==cnfPwd()?msg="New password is not the same as confirmed password":newPwd()===oldPwd()&&(msg="New password cannot be the same as old password"):msg="New password cannot be blank":msg="Old password cannot be blank",msg?dlg.okTitle(msg):(dlg.okTitle(""),dlg.okDisabled(!1))}function validateInfo(){let msg,dlg=vm.changeUserInfoDialog();dlg.okDisabled(!0),lastName()||(msg="Last name cannot be blank"),msg?dlg.okTitle(msg):(dlg.okTitle(""),dlg.okDisabled(!1))}return vm.showMenuAccount=f.prop(!1),vm.changePasswordDialog=f.prop(),vm.changeUserInfoDialog=f.prop(),vm.errorDialog=f.prop(),vm.createPasswordContent=function(){pwdView=m("form",{class:"pure-form pure-form-aligned",id:"changePasswordDialogForm"},[m("fieldset",[m("div",{class:"pure-control-group",id:"changePasswordDialogGrp1"},[m("label",{id:"oldPasswordLabel",for:"oldPassword"},"Old Password:"),m("input",{type:"password",id:"oldPassword",value:oldPwd(),onchange:e=>oldPwd(e.target.value)})]),m("div",{class:"pure-control-group",id:"changePasswordDialogGrp2"},[m("label",{for:"newPassword",id:"newPaswordLabel"},"New Password:"),m("input",{type:"password",id:"newPassword",value:newPwd(),onchange:e=>newPwd(e.target.value)})]),m("div",{class:"pure-control-group",id:"changePasswordDialogGrp3"},[m("label",{for:"confirmPassword",id:"confirmPasswordLabel"},"Confirm Password:"),m("input",{type:"password",id:"confirmPassword",value:cnfPwd(),onchange:e=>cnfPwd(e.target.value)})])])])},vm.createUserInfoContent=function(){infoView=m("form",{class:"pure-form pure-form-aligned",id:"changeUserInfoDialogForm"},[m("fieldset",[m("div",{class:"pure-control-group",id:"changeUserInfoDialogGrp1"},[m("label",{id:"userInfoFirstNameLabel",for:"userInfoFirstName"},"First Name:"),m("input",{id:"userInfoFirstName",value:firstName(),onchange:e=>firstName(e.target.value)})]),m("div",{class:"pure-control-group",id:"changeUserInfoDialogGrp2"},[m("label",{id:"userInfoLastNameLabel",for:"userInfoLastName"},"Last Name:"),m("input",{id:"userInfoLastName",required:!0,value:lastName(),onchange:e=>lastName(e.target.value)})]),m("div",{class:"pure-control-group",id:"changeUserInfoDialogGrp3"},[m("label",{id:"userInfoEmailLabel",for:"userInfoEmail"},"Email:"),m("input",{type:"email",id:"userInfoEmail",value:email(),onchange:e=>email(e.target.value)})]),m("div",{class:"pure-control-group",id:"changeUserInfoDialogGrp3"},[m("label",{id:"userInfoPhoneLabel",for:"userInfoPhone"},"Phone:"),m("input",{type:"tel",id:"userInfoPhone",value:phone(),onchange:e=>phone(e.target.value)})])])])},vm.changePasswordDialog(f.createViewModel("Dialog",{title:"Change Password",icon:"key",onOk:function(){m.request({method:"POST",url:"do/change-password",body:{oldPassword:oldPwd(),newPassword:newPwd()}}).catch((function(err){vm.errorDialog().message(err.message),vm.errorDialog().show()})),oldPwd(""),newPwd(""),cnfPwd("")},onCancel:function(){oldPwd(""),newPwd(""),cnfPwd("")}})),vm.changePasswordDialog().content=()=>pwdView,vm.changeUserInfoDialog(f.createViewModel("Dialog",{title:"Edit my contact information",icon:"address-book",onOk:function(){m.request({method:"POST",url:"do/change-user-info",body:{firstName:firstName(),lastName:lastName(),email:email(),phone:phone()}}).then((function(){user.firstName=firstName(),user.lastName=lastName(),user.email=email(),user.phone=phone()})).catch((function(err){vm.errorDialog().message(err.message),vm.errorDialog().show()}))},onCancel:function(){firstName(user.firstName),lastName(user.lastName),email(user.email),phone(user.phone)}})),vm.changeUserInfoDialog().content=()=>infoView,vm.errorDialog(f.createViewModel("Dialog",{title:"Error",icon:"times"})),oldPwd.state().resolve("/Changing").exit(validatePassword),newPwd.state().resolve("/Changing").exit(validatePassword),cnfPwd.state().resolve("/Changing").exit(validatePassword),firstName.state().resolve("/Changing").exit(validateInfo),lastName.state().resolve("/Changing").exit(validateInfo),email.state().resolve("/Changing").exit(validateInfo),phone.state().resolve("/Changing").exit(validateInfo),vm}};f.catalog().register("viewModels","accountMenu",accountMenu.viewModel),accountMenu.component={oninit:function(){this.viewModel=accountMenu.viewModel()},view:function(){const vm=this.viewModel,dlg=f.getComponent("Dialog"),dlgState=vm.changePasswordDialog().state().current()[0];let menuButtonClass="pure-button fa fa-user-circle fb-menu-button";switch(f.currentUser().mode){case"test":menuButtonClass+=" fb-menu-button-test";break;case"dev":menuButtonClass+=" fb-menu-button-dev"}return m("div",{id:"nav-account-div",class:"pure-menu custom-restricted-width fb-menu fb-menu-setup",onclick:function(e){"/Display/Closed"===dlgState&&"BUTTON"!==e.srcElement.nodeName&&"BUTTON"!==e.target.parentElement.nodeName&&vm.showMenuAccount(!0)},onmouseout:function(ev){ev&&ev.toElement&&ev.toElement.id&&-1!==ev.toElement.id.indexOf("nav-account")||vm.showMenuAccount(!1)}},[m(dlg,{viewModel:vm.changePasswordDialog()}),m(dlg,{viewModel:vm.changeUserInfoDialog()}),m(dlg,{viewModel:vm.errorDialog()}),m("span",{id:"nav-account-button",title:"Signed in as: "+(f.currentUser()?f.currentUser().name:""),class:menuButtonClass}),m("ul",{id:"nav-account-list",class:"pure-menu-list fb-menu-list fb-menu-list-setup"+(vm.showMenuAccount()?" fb-menu-list-show":"")},[m("li",{id:"nav-account-myinfo",class:"pure-menu-link",title:"Edit my contact information",onclick:function(){let cdlg=vm.changeUserInfoDialog();vm.createUserInfoContent(),cdlg.okDisabled(!0),cdlg.show()}},[m("i",{id:"nav-account-myinfo-icon",class:"fa fa-pencil-alt fb-menu-list-icon"})],"Info"),m("li",{id:"nav-account-password",class:"pure-menu-link ",title:"Change password",onclick:function(){let cdlg=vm.changePasswordDialog();vm.createPasswordContent(),cdlg.okDisabled(!0),cdlg.show()}},[m("i",{id:"nav-account-password-icon",class:"fa fa-key fb-menu-list-icon"})],"Password"),m("li",{id:"nav-account-signout",class:"pure-menu-link fb-menu-list-separator",title:"Sign out of application",onclick:()=>f.state().send("signOut")},[m("i",{id:"nav-account-signout-icon",class:"fa fa-sign-out-alt fb-menu-list-icon"})],"Sign out")])])}},f.catalog().register("components","accountMenu",accountMenu.component);const selected=f.prop(),navigator={},state=f.State.define((function(){this.state("Expanded",(function(){this.event("toggle",(function(){this.goto("../Collapsed")})),this.classMenu="pure-menu fb-navigator-menu fb-navigator-menu-expanded",this.classHeader="",this.content=function(value){return value},this.title=function(value){return value}})),this.state("Collapsed",(function(){this.event("toggle",(function(){this.goto("../Expanded")})),this.classMenu="pure-menu fb-navigator-menu fb-navigator-menu-collapsed",this.classHeader="fb-navigator-menu-header-collapsed",this.content=function(){},this.title=function(value){return value}}))}));state.goto(),navigator.viewModel=function(){let vm;return vm={},vm.workbooks=f.catalog().store().workbooks,vm.goHome=function(){m.route.set("/home")},vm.goto=function(){let config=this.getConfig(),wb=this.data.name().toSpinalCase(),pg=config[0].name.toSpinalCase();m.route.set("/workbook/:workbook/:page",{workbook:wb,page:pg,key:f.hashCode(wb+"-"+pg)})},vm.itemContent=function(value){return state.resolve(state.current()[0]).content(value)},vm.itemTitle=function(value){return state.resolve(state.current()[0]).title(value)},vm.mouseoverKey=f.prop(),vm.mouseout=function(){vm.mouseoverKey(void 0)},vm.mouseover=function(){vm.mouseoverKey(this)},vm.toggle=function(){state.send("toggle")},vm.classHeader=function(){return state.resolve(state.current()[0]).classHeader},vm.classMenu=function(){return state.resolve(state.current()[0]).classMenu},vm.selected=selected,vm.state=f.prop(state),vm},f.catalog().register("viewModels","navigatorMenu",navigator.viewModel),navigator.component={oninit:function(vnode){let vm=vnode.attrs.viewModel||navigator.viewModel(vnode.attrs);this.viewModel=vm},view:function(){let menuItems,itemClass,keys,vm=this.viewModel,workbooks=vm.workbooks();return keys=Object.keys(workbooks).sort((function(a,b){return(workbooks[a].data.sequence()||0)-(workbooks[b].data.sequence()||0)})),menuItems=keys.map((function(key){let name=workbooks[key].data.name(),desc=workbooks[key].data.description();return itemClass="pure-menu-item fb-navigator-item",vm.selected()&&vm.selected()===key?itemClass+=" fb-navigator-item-selected":vm.mouseoverKey()===key&&(itemClass+=" fb-navigator-item-mouseover"),m("li",{class:itemClass,onclick:vm.goto.bind(workbooks[key]),onmouseover:vm.mouseover.bind(key),onmouseout:vm.mouseout,title:vm.itemTitle(desc)},[m("i",{class:"fa fa-"+workbooks[key].data.icon()+" fb-navigator-item-icon"})],vm.itemContent(name))})),itemClass="pure-menu-item fb-navigator-item","home"===vm.selected()?itemClass+=" fb-navigator-item-selected":"home"===vm.mouseoverKey()&&(itemClass+=" fb-navigator-item-mouseover"),menuItems.unshift(m("li",{class:itemClass,onclick:vm.goHome,onmouseover:vm.mouseover.bind("home"),onmouseout:vm.mouseout,title:vm.itemTitle("Home")},[m("i",{class:"fa fa-home fb-navigator-item-icon"})],vm.itemContent("Home"))),m("div",{class:vm.classMenu()},[m("div",{class:vm.classHeader()},"Featherbone",[m("i",{style:{fontSize:"x-small",marginLeft:"8px",marginTop:"4px"},class:"fa fa-chevron-left",onclick:vm.toggle})]),m("ul",{class:"pure-menu-list"},menuItems)])}},f.catalog().register("components","navigatorMenu",navigator.component);import model from"./models/model.js";import settings from"./models/settings.js";const datasource=f.datasource(),State=f.State,catalog=f.catalog(),components=catalog.store().components(),viewModels=catalog.store().viewModels();let feathers,loadForms,loadCatalog,loadModules,loadProfile,moduleData,workbookData,loadWorkbooks,menu,addWorkbookViewModel,sseErrorDialogViewModel,hash=window.location.hash.slice(window.location.hash.indexOf("/")),formsSid=f.createId(),moduleSid=f.createId(),workbooks=catalog.register("workbooks"),models=catalog.store().models(),initialized=!1,isSuper=!1;const preFetch=[],fetchRequests=[],home={oninit:function(vnode){Object.keys(workbooks).forEach((function(key){let workbook=workbooks[key],config=workbook.getConfig();vnode["go"+workbook.data.name()]=function(){m.route.set("/workbook/:workbook/:key",{workbook:workbook.data.name().toSpinalCase(),key:config[0].name.toSpinalCase()})}})),menu.selected("home")},oncreate:function(){document.getElementById("fb-title").text="Featherbone"},onupdate:function(){menu.selected("home")},view:function(){let toolbarClass="fb-toolbar",toolbarButtonClass="fb-toolbar-button";switch(f.currentUser().mode){case"test":toolbarClass+=" fb-toolbar-test",toolbarButtonClass=" fb-toolbar-button-test";break;case"dev":toolbarClass+=" fb-toolbar-dev",toolbarButtonClass=" fb-toolbar-button-dev"}return m("div",{class:"fb-navigator-menu-container"},[m(components.navigatorMenu,{viewModel:menu}),[m(components.dialog,{viewModel:sseErrorDialogViewModel}),m(components.dialog,{viewModel:addWorkbookViewModel}),m("span",{class:toolbarClass+" fb-toolbar-home"},[m("div",{class:"fb-header-home"},"Home"),m(components.accountMenu),m("button",{class:toolbarButtonClass+" fb-toolbar-button-home "+(isSuper?"":"fb-button-disabled"),title:isSuper?"Add workbook":"Must be a super user to add a workbook",onclick:addWorkbookViewModel.show,disabled:!isSuper},[m("i",{class:"fa fa-plus fb-button-icon"})])])]])}};let routes={"/workbook/:workbook/:page":components.workbookPage,"/edit/:feather/:key":components.formPage,"/traverse/:feather/:key":components.childFormPage,"/search/:feather":components.searchPage,"/settings/:settings":components.settingsPage,"/sign-in":components.signInPage};const sseState=State.define((function(){this.state("Ok",(function(){this.event("error",(function(error){this.goto("/Error",{context:error})})),this.event("close",(function(){this.goto("/Closed")}))})),this.state("Closed"),this.state("Error")}));sseState.goto(),catalog.register("global","sseState",sseState);const workbookSpec={name:"Workbook",description:"System workbook definition",properties:{id:{description:"Id",type:"string",default:"createId()"},name:{description:"Workbook name",type:"string",isRequired:!0},description:{description:"Description",type:"string"},module:{description:"Module",type:"string"},icon:{description:"Menu icon",type:"string",format:"icon",default:"folder",isRequired:!0},feather:{description:"Feather",type:"string",isRequired:!0}}},addWorkbookConfig={attrs:[{attr:"name"},{attr:"description"},{attr:"icon"},{attr:"feather",dataList:"feathers"},{attr:"module",dataList:"modules"}]};function registerWorkbook(workbook){let name=workbook.name.toSpinalCase().toCamelCase(),wmodel=models.workbook(workbook);wmodel.state().goto("/Ready/Fetched/Clean"),wmodel.checkUpdate(),workbooks[name]=wmodel,catalog.register("workbooks",name,wmodel)}function addWorkbookModel(){let that=model(void 0,workbookSpec),modules=f.prop(catalog.store().data().modules());return that.addCalculated({name:"feathers",type:"array",function:function(){let result,allFeathers=catalog.store().feathers();return result=Object.keys(allFeathers).filter((function(name){return!allFeathers[name].isChild&&!allFeathers[name].isSystem})).sort().map((function(key){return{value:key,label:key}})),result.unshift({value:"",label:""}),result}}),that.addCalculated({name:"modules",type:"array",function:modules}),that.state().resolve("/Ready/New").event("save",(function(promise){let naturalKey,labelKey,d=that.data,workbook=models.workbook(),feather=catalog.getFeather(d.feather()),data={name:d.name(),description:d.description(),icon:d.icon(),module:d.module(),defaultConfig:[{name:d.feather(),feather:d.feather(),list:{columns:[]}}],localConfig:[]},dlist=data.defaultConfig[0].list;Object.keys(feather.properties).find((function(key){if(feather.properties[key].isNaturalKey)return naturalKey=key,!0})),naturalKey?dlist.columns.push({attr:naturalKey}):dlist.columns.push({attr:"id"}),Object.keys(feather.properties).find((function(key){if(feather.properties[key].isLabelKey)return labelKey=key,!0})),labelKey&&dlist.columns.push({attr:labelKey}),workbook.set(data),workbook.save().then((function(){registerWorkbook(data),m.route.set("/workbook/:workbook/:key",{workbook:d.name().toSpinalCase(),key:d.feather().toSpinalCase()}),that.clear(),promise.resolve()}))})),that}function initPromises(){loadCatalog=new Promise((function(resolve){catalog.fetch(!0).then((function(data){let initSettings=[],toFetch=[];feathers=data,Object.keys(data).forEach((function(name){let feather=catalog.getFeather(name);feather.isFetchOnStartup&&toFetch.push(feather),name=name.toCamelCase(),"function"!=typeof models[name]&&(models[name]=function(data,spec){return model(data,spec||f.copy(feather))},models[name].calculated=f.prop({}),models[name].static=f.prop({}),Object.freeze(models[name]))})),datasource.request({method:"GET",path:"/settings-definition"}).then((function(definitions){definitions.forEach((function(definition){let name=definition.name;"function"!=typeof models[name]&&(models[name]=function(){return settings(definition)}),models[name].definition=function(){return definition},initSettings.push(new Promise((function(presolve){models[name]().fetch().then(presolve)})))})),Promise.all(initSettings).then((function(){toFetch.forEach((function(feather){let list=f.createList(feather.name,{subscribe:!0,fetch:!1,showDeleted:!0}),prop=f.prop(list);catalog.register("data",feather.plural.toCamelCase(),prop),list.defaultLimit(void 0),preFetch.push(prop)})),resolve()}))}))}))})),loadForms=new Promise((function(resolve){let payload={method:"POST",path:"/data/forms",body:{subscription:{id:formsSid,eventKey:catalog.eventKey()}}};datasource.request(payload).then((function(data){catalog.register("subscriptions",formsSid,data),catalog.register("data","forms",f.prop(data)),resolve()}))})),loadModules=new Promise((function(resolve){let payload={method:"POST",path:"/data/modules",body:{subscription:{id:moduleSid,eventKey:catalog.eventKey()},properties:["id","name","script","version","dependencies"]}};datasource.request(payload).then((function(data){let mapped;moduleData=data,catalog.register("subscriptions",moduleSid,moduleData),moduleData.forEach((function(module){module.dependencies?module.dependencies=module.dependencies.map((function(dep){return dep.module.name})):module.dependencies=[]})),mapped=moduleData.map((function(mod){return{value:mod.name,label:mod.name}})).sort((function(a,b){return a.value>b.value?1:-1})),mapped.unshift({value:"",lable:""}),catalog.register("data","modules",f.prop(mapped)),resolve()}))})),loadProfile=new Promise((function(resolve){datasource.request({method:"GET",path:"/profile"}).then((function(resp){catalog.register("data","profile",f.prop(resp)),resolve()}))})),loadWorkbooks=new Promise((function(resolve){datasource.request({method:"GET",path:"/workbooks/"}).then((function(data){workbookData=data,resolve()}))}))}function initApp(){let keys=Object.keys(feathers);function resolveDependencies(module,dependencies){dependencies=dependencies||module.dependencies,module.dependencies.forEach((function(dependency){let parent=moduleData.find((module=>module.name===dependency));parent.dependencies.forEach((pDepencency=>dependencies.push(pDepencency))),resolveDependencies(parent,dependencies)}))}initialized=!0,moduleData.forEach((module=>resolveDependencies(module))),moduleData=function(){let module,idx,ret=[];function top(mod){return mod.dependencies.every((dep=>ret.some((added=>added.name===dep))))}for(;moduleData.length;)module=moduleData.find(top),ret.push(module),idx=moduleData.indexOf(module),moduleData.splice(idx,1);return ret}(),moduleData.forEach((function(module){try{new Function("f",'"use strict";'+module.script)(f)}catch(e){console.error(e)}})),keys.forEach((function(key){feathers[key].children={}})),keys.forEach((function(key){let parent=feathers[key].inherits||"Object";feathers[parent].children[key]=feathers[key]})),delete feathers.Object.children.Object,function subclass(name,parent){let feather=feathers[name],funcs=Object.keys(parent.static()),calculated=Object.keys(parent.calculated());Object.keys(feather.children).forEach((function(name){let child=models[name.toCamelCase()];funcs.forEach((function(func){child.static()[func]=child.static()[func]||parent.static()[func]})),calculated.forEach((function(prop){child.calculated()[prop]=child.calculated()[prop]||parent.calculated()[prop]})),subclass(name,child)}))}("Object",models.object),catalog.register("feathers","Money",{name:"Money",isSystem:!0,description:"Money definition",properties:{amount:{description:"Natural key",type:"number"},currency:{description:"Natural key",type:"string"},effective:{description:"Effective time",type:"date",format:"dateTime"},baseAmount:{description:"Amount in base currency",type:"number"}}}),workbookData.forEach(registerWorkbook),preFetch.forEach((function(ary){fetchRequests.push(ary().fetch({}))})),Promise.all(fetchRequests).then((function(){isSuper=f.currentUser().isSuper,menu=viewModels.navigatorMenu(),addWorkbookViewModel=viewModels.formDialog({icon:"plus",title:"Add workbook",model:addWorkbookModel(),config:addWorkbookConfig}),sseErrorDialogViewModel=viewModels.dialog({icon:"close",title:"Connection Error",message:'You have lost connection to the server.Click "Ok" to attempt to reconnect.',onOk:function(){document.location.reload()}}),sseState.resolve("Error").enter(sseErrorDialogViewModel.show),sseErrorDialogViewModel.buttonCancel().hide(),routes["/home"]=home,m.route(document.body,"/home",routes),"/sign-in"===hash&&(hash="/home"),m.route.set(hash)}))}function start(){initialized||(initPromises(),Promise.all([loadCatalog,loadModules,loadForms,loadProfile,loadWorkbooks]).then(initApp))}function goSignIn(){m.route(document.body,"/sign-in",routes),f.state().resolve("/SignedIn").enter(start),f.state().send("signIn")}function connect(){return new Promise((function(resolve){datasource.request({method:"POST",path:"/connect"}).then(resolve)}))}connect().then((function(resp){let edata;resp.data&&(edata=resp.data,catalog.register("subscriptions"),catalog.eventKey(edata.eventKey),f.state().resolve("/SignedIn").enter((function(){const wsurl="ws://"+window.location.hostname+":7070",evsubscr=new WebSocket(wsurl);evsubscr.onopen=function(){evsubscr.send(edata.eventKey)},evsubscr.onmessage=function(e){f.processEvent({event:e,moduleSubscrId:moduleSid,formsSubscrId:formsSid})},f.state().resolve("/SignedOut").enter((function(){evsubscr.close(),f.state().resolve("/SignedOut").enters.pop()})),evsubscr.onclose=function(e){sseState.send("error",e)}})),resp.data.authorized?(f.currentUser(edata.authorized),f.state().send("preauthorized"),start()):goSignIn())})),document.documentElement.style.overflow="hidden",window.onresize=function(){m.redraw(!0)};